<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foon Yew High School - Kaohsiung Senior High School Online Exchange Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.13.0/cloudinary-core-shrinkwrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
 /* ç°ä»£åŒ–è®¾è®¡å¢å¼ºç‰ˆ CSS */
:root {
    --primary: #4361ee;
    --primary-light: #4895ef;
    --primary-dark: #3a0ca3;
    --secondary: #f72585;
    --secondary-light: #ff8fab;
    --accent: #4cc9f0;
    --accent-light: #8be9fd;
    --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    --gradient-secondary: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
    --gradient-accent: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    
    --dark: #1a1a2e;
    --dark-light: #16213e;
    --gray: #6c757d;
    --light: #f8f9fa;
    --light-gray: #e9ecef;
    
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --info: #3498db;
    
    --border-radius-xl: 24px;
    --border-radius-lg: 20px;
    --border-radius-md: 16px;
    --border-radius-sm: 12px;
    --border-radius-xs: 8px;
    
    --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.15);
    --shadow-xl: 0 24px 64px rgba(0, 0, 0, 0.2);
    --shadow-neon: 0 0 20px rgba(67, 97, 238, 0.3);
    --shadow-neon-secondary: 0 0 20px rgba(247, 37, 133, 0.3);
    
    --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    --transition-quick: all 0.3s ease;
    
    --blur-bg: blur(20px);
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);
}

/* åŸºç¡€é‡ç½®ä¸å…¨å±€æ ·å¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
    scroll-padding-top: 100px;
}

body {
    font-family: 'Poppins', 'Noto Sans SC', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 50%, #f0f4ff 100%);
    color: var(--dark);
    line-height: 1.7;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
}

/* èƒŒæ™¯è£…é¥°å…ƒç´  */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.08) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(247, 37, 133, 0.08) 0%, transparent 40%),
        radial-gradient(circle at 40% 60%, rgba(76, 201, 240, 0.05) 0%, transparent 40%);
    z-index: -2;
}

body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234361ee' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
    opacity: 0.3;
    z-index: -1;
}

.container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 32px;
}

/* ç°ä»£åŒ– Header è®¾è®¡ */
header {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: var(--blur-bg);
    -webkit-backdrop-filter: var(--blur-bg);
    padding: 1.2rem 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow-sm);
    border-bottom: var(--glass-border);
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
}

.logo {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    text-decoration: none;
    transition: var(--transition-smooth);
}

.logo:hover {
    transform: translateX(5px);
}

.logo-icon {
    width: 70px;
    height: 70px;
    border-radius: var(--border-radius-lg);
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: white;
    box-shadow: var(--shadow-neon);
    position: relative;
    overflow: hidden;
    transition: var(--transition-bounce);
}

.logo-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    transform: rotate(45deg);
    transition: var(--transition-smooth);
}

.logo:hover .logo-icon {
    transform: rotate(15deg) scale(1.1);
    box-shadow: var(--shadow-neon), 0 10px 30px rgba(67, 97, 238, 0.4);
}

.logo:hover .logo-icon::before {
    left: 100%;
}

.logo-text h1 {
    font-size: 1.8rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.3;
}

.logo-text p {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 0.3rem;
    opacity: 0.8;
}

/* ç”¨æˆ·èœå•ç°ä»£åŒ–è®¾è®¡ */
.user-menu {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem 1.2rem;
    background: var(--gradient-glass);
    border-radius: var(--border-radius-md);
    backdrop-filter: blur(10px);
    border: var(--glass-border);
    cursor: pointer;
    transition: var(--transition-smooth);
    min-width: 180px;
}

.user-info:hover {
    background: rgba(255, 255, 255, 0.95);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.user-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--gradient-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
    box-shadow: var(--shadow-neon-secondary);
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
}

.user-avatar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.user-info:hover .user-avatar {
    transform: scale(1.15) rotate(10deg);
}

.user-details {
    flex: 1;
}

.user-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--dark);
}

.user-role {
    font-size: 0.8rem;
    color: var(--gray);
    opacity: 0.8;
}

/* å¯¼èˆªæ ç°ä»£åŒ–è®¾è®¡ */
nav {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: var(--blur-bg);
    -webkit-backdrop-filter: var(--blur-bg);
    border-bottom: var(--glass-border);
    position: relative;
    z-index: 900;
}

.nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
}

.nav-links {
    display: flex;
    list-style: none;
    gap: 0.2rem;
}

.nav-links li {
    position: relative;
}

.nav-links a {
    display: block;
    padding: 1.2rem 1.8rem;
    text-decoration: none;
    color: var(--dark);
    font-weight: 600;
    font-size: 0.95rem;
    border-radius: var(--border-radius-md);
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
}

.nav-links a::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.6s ease;
}

.nav-links a:hover::before {
    left: 100%;
}

.nav-links a:hover {
    background: rgba(67, 97, 238, 0.05);
    color: var(--primary);
    transform: translateY(-2px);
}

.nav-links a.active {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-neon);
}

.nav-links a.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 3px;
    background: white;
    border-radius: 2px;
}

/* æŒ‰é’®ç°ä»£åŒ–è®¾è®¡ */
.btn {
    padding: 1rem 2.2rem;
    border: none;
    border-radius: var(--border-radius-md);
    font-weight: 600;
    font-size: 0.95rem;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: var(--transition-smooth);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.8rem;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    text-transform: uppercase;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s ease;
}

.btn:hover::before {
    left: 100%;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-neon);
}

.btn-primary:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: var(--shadow-neon), 0 12px 40px rgba(67, 97, 238, 0.4);
}

.btn-secondary {
    background: var(--gradient-secondary);
    color: white;
    box-shadow: 0 8px 25px rgba(247, 37, 133, 0.3);
}

.btn-secondary:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 40px rgba(247, 37, 133, 0.4);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
    box-shadow: none;
}

.btn-outline:hover {
    background: rgba(67, 97, 238, 0.1);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(67, 97, 238, 0.2);
}

.btn-small {
    padding: 0.7rem 1.5rem;
    font-size: 0.85rem;
}

.btn-icon {
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
}

/* ä¸»å†…å®¹åŒºåŸŸç°ä»£åŒ–è®¾è®¡ */
main {
    padding: 4rem 0;
    min-height: calc(100vh - 300px);
}

.page {
    display: none;
    animation: fadeIn 0.6s ease-out;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* é¡µé¢æ ‡é¢˜ç°ä»£åŒ–è®¾è®¡ */
.page-header {
    text-align: center;
    margin-bottom: 4rem;
    position: relative;
}

.page-header h2 {
    font-size: 3.2rem;
    font-weight: 800;
    margin-bottom: 1.2rem;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    display: inline-block;
}

.page-header h2::after {
    content: '';
    position: absolute;
    bottom: -15px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 5px;
    background: var(--gradient-primary);
    border-radius: 3px;
}

.page-header p {
    font-size: 1.2rem;
    color: var(--gray);
    max-width: 800px;
    margin: 0 auto;
    line-height: 1.8;
}
/* æ·»åŠ åˆ°æ‚¨çš„CSSä¸­ */
#batch-actions,
#autosave-status,
#shortcut-hint {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    padding: 10px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

/* ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤º */
.editing-mode #batch-actions,
.editing-mode #autosave-status,
.editing-mode #shortcut-hint {
    display: flex;
}
/* ä»ªè¡¨æ¿å¡ç‰‡ç°ä»£åŒ–è®¾è®¡ */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
    gap: 2rem;
    margin-bottom: 4rem;
}


/* å¼ºåˆ¶å›¾è¡¨å®¹å™¨å§‹ç»ˆæ˜¾ç¤º */
#progress-chart-container {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 100% !important;
    height: 350px !important;
    min-height: 350px !important;
    max-height: 350px !important;
    position: relative !important;
    background: white !important;
    border: 2px solid #4361ee !important;
    border-radius: 12px !important;
    padding: 20px !important;
    margin: 20px 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
    z-index: 100 !important;
}

/* ç§»é™¤æ‰€æœ‰å¯èƒ½éšè—å®¹å™¨çš„æ ·å¼ */
#progress-chart-container[style*="display: none"],
#progress-chart-container[style*="display:none"],
#progress-chart-container.hidden,
#progress-chart-container.d-none {
    display: block !important;
}

/* Canvasæ ·å¼ */
#progress-chart {
    display: block !important;
    width: 100% !important;
    height: 100% !important;
    position: absolute !important;
    top: 20px !important;
    left: 20px !important;
    right: 20px !important;
    bottom: 20px !important;
    box-sizing: border-box !important;
}

/* ä¿®å¤Chart.jsçš„å“åº”å¼é—®é¢˜ */
.chartjs-render-monitor {
    width: 100% !important;
    height: 100% !important;
}
        /* ==================== Exchange Statistics ç»Ÿè®¡é¡¹å¢å¼ºè®¾è®¡ ==================== */
#exchange-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin: 0;
}

#exchange-stats p {
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* ç»Ÿè®¡é¡¹å¡ç‰‡å®¹å™¨ */
.stat-item {
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(76, 201, 240, 0.05));
    border-radius: var(--border-radius-lg);
    padding: 1.5rem 1rem;
    border: 1px solid rgba(67, 97, 238, 0.1);
    transition: var(--transition-smooth);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.stat-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: translateX(-100%);
}

.stat-item:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
    border-color: rgba(67, 97, 238, 0.3);
}

.stat-item:hover::before {
    animation: shine 1.5s ease;
}

.stat-item:nth-child(1) {
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.08), rgba(67, 97, 238, 0.15));
    border-color: rgba(67, 97, 238, 0.2);
}

.stat-item:nth-child(2) {
    background: linear-gradient(135deg, rgba(247, 37, 133, 0.08), rgba(247, 37, 133, 0.15));
    border-color: rgba(247, 37, 133, 0.2);
}

.stat-item:nth-child(3) {
    background: linear-gradient(135deg, rgba(76, 201, 240, 0.08), rgba(76, 201, 240, 0.15));
    border-color: rgba(76, 201, 240, 0.2);
}

.stat-item:nth-child(4) {
    background: linear-gradient(135deg, rgba(58, 12, 163, 0.08), rgba(58, 12, 163, 0.15));
    border-color: rgba(58, 12, 163, 0.2);
}

/* ç»Ÿè®¡æ ‡ç­¾ */
.stat-item span {
    display: block;
    font-size: 0.85rem;
    color: var(--gray);
    margin-bottom: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    opacity: 0.9;
}

/* ç»Ÿè®¡æ•°å€¼ */
.stat-item strong {
    display: block;
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    padding: 0.5rem 0;
}

.stat-item:nth-child(1) strong {
    color: #4361ee;
    background: linear-gradient(135deg, #4361ee, #3a0ca3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-item:nth-child(2) strong {
    color: #f72585;
    background: linear-gradient(135deg, #f72585, #b5179e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-item:nth-child(3) strong {
    color: #4cc9f0;
    background: linear-gradient(135deg, #4cc9f0, #4895ef);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-item:nth-child(4) strong {
    color: #7209b7;
    background: linear-gradient(135deg, #7209b7, #560bad);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* ç»Ÿè®¡å›¾æ ‡ */
.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
    color: white;
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.stat-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transform: rotate(45deg);
}

.stat-item:nth-child(1) .stat-icon {
    background: linear-gradient(135deg, #4361ee, #3a0ca3);
}

.stat-item:nth-child(2) .stat-icon {
    background: linear-gradient(135deg, #f72585, #b5179e);
}

.stat-item:nth-child(3) .stat-icon {
    background: linear-gradient(135deg, #4cc9f0, #4895ef);
}

.stat-item:nth-child(4) .stat-icon {
    background: linear-gradient(135deg, #7209b7, #560bad);
}

/* è¿›åº¦æ¡æ•ˆæœ */
.stat-progress {
    width: 80%;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    margin: 1rem auto 0;
    overflow: hidden;
    position: relative;
}

.stat-progress-bar {
    height: 100%;
    border-radius: 2px;
    position: absolute;
    left: 0;
    top: 0;
    animation: progressFill 2s ease-out forwards;
}

.stat-item:nth-child(1) .stat-progress-bar {
    background: linear-gradient(90deg, #4361ee, #3a0ca3);
    width: 100%;
}

.stat-item:nth-child(2) .stat-progress-bar {
    background: linear-gradient(90deg, #f72585, #b5179e);
    width: 0%;
}

.stat-item:nth-child(3) .stat-progress-bar {
    background: linear-gradient(90deg, #4cc9f0, #4895ef);
    width: 0%;
}

.stat-item:nth-child(4) .stat-progress-bar {
    background: linear-gradient(90deg, #7209b7, #560bad);
    width: 25%;
}

@keyframes progressFill {
    from {
        width: 0;
    }
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    #exchange-stats {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .stat-item {
        padding: 1.2rem;
    }
    
    .stat-item strong {
        font-size: 1.8rem;
    }
}

@media (max-width: 576px) {
    .stat-item {
        padding: 1rem;
    }
    
    .stat-item strong {
        font-size: 1.5rem;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
}

.card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius-lg);
    border: var(--glass-border);
    overflow: hidden;
    transition: var(--transition-smooth);
    box-shadow: var(--shadow-md);
    height: 100%;
    position: relative;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-glass);
    opacity: 0;
    transition: var(--transition-smooth);
}

.card:hover {
    transform: translateY(-15px);
    box-shadow: var(--shadow-xl);
}

.card:hover::before {
    opacity: 1;
}

.card-header {
    padding: 2rem;
    background: var(--gradient-primary);
    color: white;
    position: relative;
    overflow: hidden;
}

.card-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shine 3s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.card-header i {
    font-size: 2rem;
    margin-bottom: 1rem;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
}

.card-header h3 {
    font-size: 1.5rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.card-body {
    padding: 2rem;
    position: relative;
}

/* å…¬å‘Šåˆ—è¡¨ç°ä»£åŒ–è®¾è®¡ */
.announcement-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.announcement-item {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2.5rem;
    border-left: 6px solid var(--primary);
    box-shadow: var(--shadow-md);
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
}

.announcement-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, transparent, rgba(67, 97, 238, 0.03), transparent);
}

.announcement-item:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
}

.announcement-item h4 {
    font-size: 1.6rem;
    color: var(--primary-dark);
    margin-bottom: 1.2rem;
    font-weight: 700;
}

.announcement-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: var(--dark);
    margin-bottom: 1.5rem;
}

.announcement-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1.5rem;
    border-top: 1px solid var(--light-gray);
    font-size: 0.95rem;
    color: var(--gray);
}

        /* æ·»åŠ åˆ°ç°æœ‰çš„CSSä¸­ */
.note-image {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    border-radius: var(--border-radius-sm);
    margin: 1rem 0;
    transition: var(--transition-smooth);
    cursor: pointer;
}

.note-image:hover {
    transform: scale(1.02);
    box-shadow: var(--shadow-md);
}

/* æ‡’åŠ è½½å ä½ç¬¦ */
.lazy-load {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* å›¾ç‰‡æ¨¡æ€æ¡† */
#image-modal .modal-content {
    max-width: 90vw;
    max-height: 90vh;
    background: transparent;
    box-shadow: none;
}

#image-modal img {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
}

/* Padletå¢™ç°ä»£åŒ–è®¾è®¡ */
.padlet-container {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2.5rem;
    box-shadow: var(--shadow-lg);
    min-height: 600px;
    position: relative;
    overflow: hidden;
}

        /* ç´§æ€¥CSSä¿®å¤ - ç¡®ä¿å›¾è¡¨å®¹å™¨æ€»æ˜¯å¯è§ */
#progress-chart-container {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 100% !important;
    height: 350px !important;
    min-height: 350px !important;
    position: relative !important;
    background: white !important;
    border: 2px solid #4361ee !important;
    border-radius: 12px !important;
    padding: 20px !important;
    margin: 20px 0 !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
    z-index: 1000 !important;
}

#progress-chart {
    display: block !important;
    width: 100% !important;
    height: 100% !important;
    position: absolute !important;
    top: 20px !important;
    left: 20px !important;
    right: 20px !important;
    bottom: 20px !important;
}

        /* æ·»åŠ åœ¨ç°æœ‰çš„CSSä¸­ï¼Œä¾‹å¦‚åœ¨.padlet-containeræ ·å¼åé¢ */

/* Exchange Links Container */
.exchange-links-container {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 1.8rem;
    margin-bottom: 2rem;
}

.exchange-links-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.8rem;
    padding-bottom: 1.2rem;
    border-bottom: 1px solid var(--light-gray);
}

.exchange-links-header h3 {
    margin: 0;
    color: var(--primary);
    font-size: 1.4rem;
}

/* Link Item */
.link-item {
    margin-bottom: 2rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    overflow: hidden;
    background-color: white;
}

.link-item:last-child {
    margin-bottom: 0;
}

.link-header {
    padding: 1.2rem 1.5rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid var(--light-gray);
}

.link-header h4 {
    margin: 0 0 0.5rem 0;
    color: var(--primary-dark);
    font-size: 1.2rem;
}

.link-header p {
    margin: 0;
    color: var(--gray);
    font-size: 0.95rem;
}

.link-content {
    padding: 0;
}

.link-iframe-container {
    width: 100%;
    height: 600px; /* å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´é«˜åº¦ */
    position: relative;
    background-color: #f5f5f5;
}

.link-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
}

.link-footer {
    padding: 0.8rem 1.5rem;
    background-color: #f8f9fa;
    border-top: 1px solid var(--light-gray);
    font-size: 0.85rem;
    color: var(--gray);
}

/* ç®¡ç†å‘˜é“¾æ¥ç®¡ç†åŒºåŸŸ */
.links-management {
    display: none;
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-top: 1.5rem;
}

.links-management.active {
    display: block;
}

/* é“¾æ¥ç®¡ç†è¡¨å• */
.link-form-container {
    background-color: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-top: 1rem;
    border: 1px solid var(--light-gray);
}

/* ç°æœ‰é“¾æ¥åˆ—è¡¨ */
.existing-links-list {
    margin-top: 2rem;
}

.existing-links-list h4 {
    margin-bottom: 1rem;
    color: var(--primary);
}

.link-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: white;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    margin-bottom: 0.8rem;
}

.link-list-item-info h5 {
    margin: 0 0 0.3rem 0;
    color: var(--primary);
}

.link-list-item-info p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--gray);
}

.link-list-item-actions {
    display: flex;
    gap: 0.5rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .link-iframe-container {
        height: 400px;
    }
    
    .exchange-links-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .link-list-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .link-list-item-actions {
        width: 100%;
        justify-content: flex-end;
    }
}

.padlet-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(67, 97, 238, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(247, 37, 133, 0.05) 0%, transparent 50%);
}

.padlet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--light-gray);
}

.padlet-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
}

.padlet-note {
    border-radius: var(--border-radius-md);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    min-height: 240px;
    position: relative;
    overflow: hidden;
    transition: var(--transition-smooth);
    cursor: move;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.padlet-note:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: var(--shadow-xl);
}

.padlet-note.note-yellow {
    background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
}

.padlet-note.note-blue {
    background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
}

.padlet-note.note-green {
    background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
}

.padlet-note.note-pink {
    background: linear-gradient(135deg, #f8bbd9 0%, #f48fb1 100%);
}

.note-title {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--dark);
    position: relative;
    padding-bottom: 0.8rem;
}

.note-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 40px;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 2px;
}

.note-content {
    font-size: 1.05rem;
    line-height: 1.7;
    margin-bottom: 1.5rem;
    flex-grow: 1;
}

.note-image {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: var(--border-radius-sm);
    margin: 1rem 0;
    box-shadow: var(--shadow-sm);
}

.note-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: rgba(0, 0, 0, 0.7);
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.note-actions {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: var(--transition-quick);
}

.padlet-note:hover .note-actions {
    opacity: 1;
}

.note-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1rem;
    color: var(--dark);
    transition: var(--transition-smooth);
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(10px);
}

.note-btn:hover {
    transform: scale(1.15);
    box-shadow: var(--shadow-md);
}

.add-note-btn {
    background: rgba(255, 255, 255, 0.8);
    border: 3px dashed var(--primary);
    border-radius: var(--border-radius-lg);
    height: 240px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    cursor: pointer;
    transition: var(--transition-smooth);
    backdrop-filter: blur(10px);
}

.add-note-btn:hover {
    background: rgba(67, 97, 238, 0.1);
    transform: scale(1.03);
    box-shadow: var(--shadow-md);
}

.add-note-btn i {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    opacity: 0.7;
    transition: var(--transition-smooth);
}

.add-note-btn:hover i {
    transform: rotate(90deg) scale(1.2);
    opacity: 1;
}

/* è¡¨å•ç°ä»£åŒ–è®¾è®¡ */
.form-container {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 3rem;
    max-width: 700px;
    margin: 0 auto;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.form-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: var(--gradient-primary);
}

.form-group {
    margin-bottom: 2.2rem;
    position: relative;
}

.form-group label {
    display: block;
    margin-bottom: 0.8rem;
    font-weight: 600;
    color: var(--dark);
    font-size: 1.05rem;
}

.form-control {
    width: 100%;
    padding: 1.2rem 1.5rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-md);
    font-size: 1.05rem;
    transition: var(--transition-smooth);
    background: rgba(248, 249, 250, 0.8);
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    transform: translateY(-2px);
}

.form-control:focus + .form-icon {
    color: var(--primary);
    transform: scale(1.1);
}

.form-icon {
    position: absolute;
    right: 1.5rem;
    top: 3.2rem;
    color: var(--gray);
    transition: var(--transition-smooth);
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1.2rem;
    margin-top: 3rem;
}

/* è®¤è¯é¡µé¢ç°ä»£åŒ–è®¾è®¡ */
.auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 80vh;
    padding: 2rem;
}

.auth-card {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: 3.5rem;
    width: 100%;
    max-width: 500px;
    box-shadow: var(--shadow-xl);
    position: relative;
    overflow: hidden;
}

.auth-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: var(--gradient-primary);
}

.auth-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.auth-header h2 {
    font-size: 2.4rem;
    font-weight: 800;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.auth-header p {
    color: var(--gray);
    font-size: 1.1rem;
}

.auth-divider {
    text-align: center;
    margin: 2rem 0;
    position: relative;
}

.auth-divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--light-gray), transparent);
}

.auth-divider span {
    background: white;
    padding: 0 1.5rem;
    color: var(--gray);
    font-size: 0.95rem;
    position: relative;
}

.google-btn {
    width: 100%;
    padding: 1.2rem;
    background: white;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-md);
    font-weight: 600;
    font-size: 1rem;
    color: var(--dark);
    cursor: pointer;
    transition: var(--transition-smooth);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.google-btn:hover {
    background: #f8f9fa;
    border-color: #ddd;
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.google-btn i {
    color: #db4437;
    font-size: 1.4rem;
}

/* æ—¥å†ç°ä»£åŒ–è®¾è®¡ */
.calendar-container {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2.5rem;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--light-gray);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--light-gray);
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
}

.calendar-day {
    background: white;
    padding: 1.5rem;
    min-height: 160px;
    position: relative;
    transition: var(--transition-quick);
}

.calendar-day:hover {
    background: #fcfdfe;
    transform: scale(1.01);
    z-index: 1;
}

.calendar-day.header {
    background: var(--gradient-primary);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 1.5rem 0.5rem;
    min-height: auto;
    font-size: 1.1rem;
}

.day-number {
    font-weight: 700;
    margin-bottom: 1rem;
    font-size: 1.3rem;
    color: var(--dark);
}

.calendar-event {
    background: rgba(67, 97, 238, 0.1);
    border-left: 4px solid var(--primary);
    padding: 0.8rem;
    margin-bottom: 0.5rem;
    border-radius: var(--border-radius-sm);
    font-size: 0.9rem;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.calendar-event:hover {
    background: rgba(67, 97, 238, 0.2);
    transform: translateX(5px);
}

/* ä¸ªäººèµ„æ–™ç°ä»£åŒ–è®¾è®¡ */
.profile-header {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: 3.5rem;
    display: flex;
    align-items: center;
    gap: 3rem;
    margin-bottom: 3rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.profile-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 8px;
    background: var(--gradient-primary);
}

.profile-avatar {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    background: var(--gradient-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 4.5rem;
    font-weight: 800;
    box-shadow: var(--shadow-neon-secondary), 0 20px 40px rgba(247, 37, 133, 0.3);
    transition: var(--transition-bounce);
    position: relative;
    overflow: hidden;
}

.profile-avatar::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
}

.profile-header:hover .profile-avatar {
    transform: rotate(15deg) scale(1.1);
}

.profile-info h2 {
    font-size: 2.4rem;
    font-weight: 800;
    margin-bottom: 0.8rem;
    color: var(--dark);
}

.profile-info p {
    font-size: 1.1rem;
    color: var(--gray);
    margin-bottom: 0.8rem;
}

.badge {
    display: inline-block;
    padding: 0.6rem 1.5rem;
    background: var(--light-gray);
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-right: 0.8rem;
    margin-bottom: 0.8rem;
    transition: var(--transition-smooth);
}

.badge:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-sm);
}

.badge-primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.badge-success {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
}

.badge-warning {
    background: linear-gradient(135deg, #f39c12, #f1c40f);
    color: white;
    box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
}

/* æ¨¡æ€æ¡†ç°ä»£åŒ–è®¾è®¡ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26, 26, 46, 0.85);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
    padding: 20px;
}

.modal.active {
    display: flex;
    animation: modalFadeIn 0.4s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(10px);
    }
}

.modal-content {
    background: white;
    border-radius: var(--border-radius-xl);
    width: 90%;
    max-width: 850px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    animation: modalSlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes modalSlideUp {
    from {
        opacity: 0;
        transform: translateY(80px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: 2.2rem;
    background: var(--gradient-primary);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 1.8rem;
    font-weight: 700;
}

.modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-body {
    padding: 2.5rem;
}

/* é¡µè„šç°ä»£åŒ–è®¾è®¡ */
footer {
    background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
    color: white;
    padding: 4rem 0 2rem;
    margin-top: 5rem;
    position: relative;
    overflow: hidden;
}

footer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: var(--gradient-primary);
}

.footer-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    flex-wrap: wrap;
    gap: 3rem;
}

.school-logos {
    display: flex;
    gap: 3.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.school-logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: var(--transition-smooth);
}

.school-logo:hover {
    transform: translateY(-10px);
}

.school-logo i {
    font-size: 3.5rem;
    margin-bottom: 1.2rem;
    color: var(--accent);
    transition: var(--transition-smooth);
}

.school-logo:hover i {
    transform: scale(1.15);
    color: var(--accent-light);
}

.footer-links {
    display: flex;
    gap: 2.5rem;
    flex-wrap: wrap;
}

.footer-links a {
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
    transition: var(--transition-smooth);
    position: relative;
    padding: 0.5rem 0;
}

.footer-links a::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--accent);
    transition: width 0.4s ease;
}

.footer-links a:hover {
    color: white;
}

.footer-links a:hover::after {
    width: 100%;
}

.copyright {
    text-align: center;
    padding-top: 2.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.95rem;
}
/* åœ¨æ­¤ä¹‹åæ·»åŠ Logoæ ·å¼ */
.logo-image-container {
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    transition: var(--transition-smooth);
    border: 2px solid transparent;
    margin-bottom: 1rem;
    overflow: hidden;
}

.logo-image-container:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-8px);
    border-color: var(--accent);
    box-shadow: var(--shadow-lg);
}

.logo-preview {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-preview img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: contain;
    border: 2px solid var(--light-gray);
}
/* åŠ è½½åŠ¨ç”»ç°ä»£åŒ–è®¾è®¡ */
.spinner {
    display: inline-block;
    width: 60px;
    height: 60px;
    border: 4px solid rgba(67, 97, 238, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
}

@keyframes spin {
    to { transform: rotate(720deg); }
}

.loading {
    text-align: center;
    padding: 4rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

/* è­¦å‘Šæ¶ˆæ¯ç°ä»£åŒ–è®¾è®¡ */
.alert {
    padding: 1.5rem 2rem;
    border-radius: var(--border-radius-lg);
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-md);
    border-left: 6px solid;
    animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(10px);
}

@keyframes slideInRight {
    from {
        transform: translateX(40px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.alert-success {
    background: rgba(46, 204, 113, 0.1);
    color: #155724;
    border-left-color: var(--success);
}

.alert-error {
    background: rgba(231, 76, 60, 0.1);
    color: #721c24;
    border-left-color: var(--danger);
}

.alert-warning {
    background: rgba(243, 156, 18, 0.1);
    color: #856404;
    border-left-color: var(--warning);
}

.alert-info {
    background: rgba(52, 152, 219, 0.1);
    color: #0c5460;
    border-left-color: var(--info);
}

.close-alert {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
    transition: var(--transition-quick);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.close-alert:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.1);
    transform: rotate(90deg);
}

/* æ ‡ç­¾é¡µç°ä»£åŒ–è®¾è®¡ */
.tabs {
    display: flex;
    border-bottom: 2px solid var(--light-gray);
    margin-bottom: 3rem;
    overflow-x: auto;
    gap: 0.2rem;
}

.tab {
    padding: 1.3rem 2.2rem;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 600;
    color: var(--gray);
    border-bottom: 3px solid transparent;
    transition: var(--transition-smooth);
    white-space: nowrap;
    font-size: 1.05rem;
    position: relative;
}

.tab::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 3px;
    background: var(--gradient-primary);
    border-radius: 2px 2px 0 0;
    transition: var(--transition-smooth);
}

.tab:hover {
    color: var(--primary);
    background: rgba(67, 97, 238, 0.05);
}

.tab:hover::after {
    width: 70%;
}

.tab.active {
    color: var(--primary);
}

.tab.active::after {
    width: 100%;
}

.tab-content {
    display: none;
    animation: fadeIn 0.5s ease;
}

.tab-content.active {
    display: block;
}

/* æ–‡ä»¶ä¸Šä¼ ç°ä»£åŒ–è®¾è®¡ */
.file-upload {
    border: 3px dashed var(--light-gray);
    border-radius: var(--border-radius-lg);
    padding: 3.5rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition-smooth);
    background: rgba(249, 249, 249, 0.8);
    position: relative;
    overflow: hidden;
}

.file-upload:hover {
    border-color: var(--primary);
    background: rgba(67, 97, 238, 0.05);
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
}

.file-upload i {
    font-size: 4.5rem;
    color: var(--gray);
    margin-bottom: 1.5rem;
    transition: var(--transition-smooth);
}

.file-upload:hover i {
    color: var(--primary);
    transform: scale(1.1) rotate(10deg);
}

/* æ‹–æ‹½æ•ˆæœ */
.draggable {
    cursor: move;
}

.dragging {
    opacity: 0.8;
    transform: scale(1.05) rotate(3deg);
    box-shadow: var(--shadow-xl) !important;
}

/* ç©ºçŠ¶æ€ç°ä»£åŒ–è®¾è®¡ */
.empty-state {
    text-align: center;
    padding: 5rem 2rem;
    color: var(--gray);
    max-width: 600px;
    margin: 0 auto;
}

.empty-state i {
    font-size: 6rem;
    margin-bottom: 2rem;
    color: var(--light-gray);
    opacity: 0.4;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

/* æ¬¢è¿åŒºåŸŸç°ä»£åŒ–è®¾è®¡ */
.welcome-section {
    text-align: center;
    padding: 5rem 3rem;
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--border-radius-xl);
    margin-bottom: 4rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.welcome-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(247, 37, 133, 0.1) 0%, transparent 50%);
}

.welcome-section h2 {
    font-size: 3.5rem;
    font-weight: 900;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    display: inline-block;
}

.welcome-section h2::after {
    content: '';
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 6px;
    background: var(--gradient-primary);
    border-radius: 3px;
}

.welcome-section p {
    max-width: 850px;
    margin: 0 auto 3rem;
    font-size: 1.3rem;
    line-height: 1.8;
    color: var(--dark);
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: rgba(236, 240, 241, 0.5);
    border-radius: 6px;
}

::-webkit-scrollbar-thumb {
    background: var(--gradient-primary);
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.8);
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
}

/* é€‰ä¸­æ–‡æœ¬æ ·å¼ */
::selection {
    background-color: rgba(67, 97, 238, 0.3);
    color: white;
}

/* ç„¦ç‚¹æ ·å¼ */
:focus {
    outline: none;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1400px) {
    .container {
        max-width: 1200px;
        padding: 0 24px;
    }
    
    .dashboard-cards {
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    }
    
    .padlet-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }
}

@media (max-width: 1200px) {
    .page-header h2 {
        font-size: 2.8rem;
    }
    
    .welcome-section h2 {
        font-size: 3rem;
    }
    
    .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 2rem;
    }
    
    .footer-content {
        flex-direction: column;
        gap: 3rem;
    }
}

@media (max-width: 992px) {
    .container {
        padding: 0 20px;
    }
    
    .header-container {
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .nav-container {
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .nav-links {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .nav-links a {
        padding: 1rem 1.5rem;
        font-size: 0.9rem;
    }
    
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
    
    .padlet-grid {
        grid-template-columns: 1fr;
    }
    
    .form-container {
        padding: 2rem;
    }
    
    .auth-card {
        padding: 2.5rem;
    }
    
    .page-header h2 {
        font-size: 2.4rem;
    }
    
    .welcome-section h2 {
        font-size: 2.5rem;
    }
    
    .welcome-section p {
        font-size: 1.1rem;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 0 16px;
    }
    
    .logo {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .logo-icon {
        width: 60px;
        height: 60px;
        font-size: 2rem;
    }
    
    .logo-text h1 {
        font-size: 1.4rem;
    }
    
    .user-info {
        min-width: auto;
    }
    
    .nav-links {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
    }
    
    .page-header h2 {
        font-size: 2rem;
    }
    
    .page-header p {
        font-size: 1rem;
    }
    
    .form-container {
        padding: 1.5rem;
    }
    
    .modal-content {
        width: 95%;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-header {
        padding: 1.5rem;
    }
    
    .footer-content {
        gap: 2rem;
    }
    
    .school-logos {
        gap: 2rem;
        justify-content: center;
    }
    
    .footer-links {
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .nav-links a {
        padding: 0.8rem 1.2rem;
        font-size: 0.85rem;
    }
    
    .btn {
        padding: 0.8rem 1.5rem;
        font-size: 0.85rem;
    }
    
    .page-header h2 {
        font-size: 1.8rem;
    }
    
    .welcome-section {
        padding: 3rem 1.5rem;
    }
    
    .welcome-section h2 {
        font-size: 2rem;
    }
    
    .welcome-section p {
        font-size: 1rem;
    }
    
    .card-header {
        padding: 1.5rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .announcement-item {
        padding: 1.5rem;
    }
    
    .padlet-container {
        padding: 1.5rem;
    }
    
    .auth-card {
        padding: 2rem;
    }
    
    .profile-header {
        padding: 2rem;
    }
    
    .profile-avatar {
        width: 120px;
        height: 120px;
        font-size: 3.5rem;
    }
}

/* æ‰“å°æ ·å¼ä¼˜åŒ– */
@media print {
    header, nav, footer, .btn, .modal, .alert {
        display: none !important;
    }
    
    body {
        background: white !important;
        color: black !important;
    }
    
    .container {
        max-width: 100% !important;
        padding: 0 !important;
    }
    
    .card, .form-container, .padlet-container, .calendar-container {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    
    .page-header h2 {
        -webkit-text-fill-color: black !important;
        background: none !important;
    }
}

/* é«˜çº§ç‰¹æ•ˆå’ŒåŠ¨ç”» */
.hover-lift {
    transition: var(--transition-smooth);
}

.hover-lift:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
}

.glow-effect {
    position: relative;
}

.glow-effect::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: var(--gradient-primary);
    border-radius: inherit;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.glow-effect:hover::after {
    opacity: 0.3;
    animation: glowPulse 2s infinite;
}

@keyframes glowPulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.6; }
}

.ripple-effect {
    position: relative;
    overflow: hidden;
}

.ripple-effect::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.6);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

.ripple-effect:focus:not(:active)::after {
    animation: ripple 1s ease-out;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(50, 50);
        opacity: 0;
    }
}

/* 3Då¡ç‰‡æ•ˆæœ */
.card-3d {
    transform-style: preserve-3d;
    perspective: 1000px;
}

.card-3d:hover {
    transform: rotateY(5deg) rotateX(5deg) translateY(-10px);
}

/* æ¸å˜è¾¹æ¡†æ•ˆæœ */
.gradient-border {
    position: relative;
    background: white;
    border-radius: var(--border-radius-lg);
}

.gradient-border::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
    border-radius: var(--border-radius-lg);
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.gradient-border:hover::before {
    opacity: 1;
}

/* æ‰“å­—æœºæ•ˆæœ */
.typewriter {
    overflow: hidden;
    border-right: 3px solid var(--primary);
    white-space: nowrap;
    margin: 0 auto;
    animation: 
        typing 3.5s steps(40, end),
        blink-caret .75s step-end infinite;
}

@keyframes typing {
    from { width: 0 }
    to { width: 100% }
}

@keyframes blink-caret {
    from, to { border-color: transparent }
    50% { border-color: var(--primary) }
}

/* ç²’å­èƒŒæ™¯æ•ˆæœï¼ˆå¯é€‰ï¼‰ */
.particles-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
}

.particle {
    position: absolute;
    border-radius: 50%;
    background: var(--primary);
    opacity: 0.1;
}

/* éœ“è™¹æ–‡å­—æ•ˆæœ */
.neon-text {
    text-shadow: 
        0 0 5px var(--primary),
        0 0 10px var(--primary),
        0 0 20px var(--primary),
        0 0 40px var(--primary);
    animation: neonGlow 2s infinite alternate;
}

@keyframes neonGlow {
    from {
        text-shadow: 
            0 0 5px var(--primary),
            0 0 10px var(--primary),
            0 0 20px var(--primary);
    }
    to {
        text-shadow: 
            0 0 10px var(--primary),
            0 0 20px var(--primary),
            0 0 30px var(--primary),
            0 0 40px var(--primary);
    }
}

/* æµ®åŠ¨åŠ¨ç”» */
.float-animation {
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
}

/* å‘¼å¸ç¯æ•ˆæœ */
.breathing-light {
    animation: breathing 3s ease-in-out infinite;
}

@keyframes breathing {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

/* æ³¢æµªèƒŒæ™¯æ•ˆæœ */
.wave-bg {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100px;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%234361ee" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
    animation: wave 20s linear infinite;
}

@keyframes wave {
    0% { background-position-x: 0; }
    100% { background-position-x: 1440px; }
}

/* ç½‘æ ¼èƒŒæ™¯æ•ˆæœ */
.grid-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(rgba(67, 97, 238, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(67, 97, 238, 0.05) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: -1;
}

/* å¡ç‰‡å †å æ•ˆæœ */
.card-stack {
    position: relative;
}

.card-stack::before,
.card-stack::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: inherit;
    border-radius: inherit;
    box-shadow: inherit;
    transition: var(--transition-smooth);
    z-index: -1;
}

.card-stack::before {
    top: -5px;
    left: -5px;
    opacity: 0.6;
}

.card-stack::after {
    top: -10px;
    left: -10px;
    opacity: 0.3;
}

.card-stack:hover::before {
    transform: translate(5px, 5px);
}

.card-stack:hover::after {
    transform: translate(10px, 10px);
}

        /* Task Tracking Styles */
.tasks-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.task-item {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-md);
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition-smooth);
    backdrop-filter: blur(10px);
}

.task-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-light);
}

.task-info h4 {
    margin: 0 0 5px 0;
    color: var(--primary);
    font-size: 1.1rem;
}

.task-info p {
    margin: 0 0 10px 0;
    color: var(--gray);
    font-size: 0.95rem;
}

.task-meta {
    display: flex;
    gap: 15px;
    font-size: 0.9rem;
    color: var(--gray);
    flex-wrap: wrap;
}

.task-type-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-right: 10px;
}

.type-manual {
    background-color: rgba(52, 152, 219, 0.1);
    color: var(--info);
    border: 1px solid rgba(52, 152, 219, 0.3);
}

.type-auto {
    background-color: rgba(46, 204, 113, 0.1);
    color: var(--success);
    border: 1px solid rgba(46, 204, 113, 0.3);
}

.task-actions {
    display: flex;
    gap: 10px;
}

/* Student Progress Styles */
.student-progress-item {
    background: white;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-md);
    padding: 20px;
    margin-bottom: 15px;
    transition: var(--transition-smooth);
}

.student-progress-item:hover {
    box-shadow: var(--shadow-md);
}

.student-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.student-info h4 {
    margin: 0 0 5px 0;
    color: var(--primary-dark);
}

.student-school {
    font-size: 0.9rem;
    color: var(--gray);
}

.completion-stats {
    display: flex;
    gap: 20px;
    align-items: center;
}

.completion-stats span {
    font-weight: 600;
    color: var(--primary);
    font-size: 1.1rem;
}

.progress-bar-container {
    margin-top: 15px;
    margin-bottom: 20px;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background-color: var(--light-gray);
    border-radius: 5px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 5px;
    transition: width 0.5s ease;
}

/* Task Checklist */
.task-checklist {
    margin-top: 20px;
}

.checklist-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--light-gray);
}

.checklist-item:last-child {
    border-bottom: none;
}

.checkbox-container {
    margin-right: 15px;
}

.checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--primary);
}

.task-check-label {
    flex: 1;
}

.task-check-label h5 {
    margin: 0 0 5px 0;
    font-size: 1rem;
    color: var(--dark);
}

.task-check-label p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--gray);
}

.completion-date {
    font-size: 0.85rem;
    color: var(--success);
    font-weight: 500;
}

/* Statistics Cards for Tracking */
.stat-card {
    background: var(--gradient-glass);
    border: var(--glass-border);
    border-radius: var(--border-radius-md);
    padding: 20px;
    text-align: center;
    transition: var(--transition-smooth);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.95rem;
    color: var(--gray);
}

/* Recent Activities */
.recent-activity-item {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: var(--transition-quick);
}

.recent-activity-item:hover {
    background: rgba(67, 97, 238, 0.05);
    border-radius: var(--border-radius-sm);
}

/* Reports Output */
.report-content {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-md);
}

.report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.report-table th {
    background: var(--gradient-primary);
    color: white;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
}

.report-table td {
    padding: 10px 15px;
    border-bottom: 1px solid var(--light-gray);
}

.report-table tr:hover {
    background: rgba(67, 97, 238, 0.05);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .student-progress-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .completion-stats {
        width: 100%;
        justify-content: space-between;
    }
    
    .task-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .task-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .task-meta {
        flex-direction: column;
        gap: 5px;
    }
}

        /* ==================== å€’è®¡æ—¶é¡µé¢æ ·å¼ ==================== */

.countdown-container {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: 3rem;
    box-shadow: var(--shadow-lg);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.countdown-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 8px;
    background: var(--gradient-primary);
}

.countdown-header {
    margin-bottom: 2.5rem;
}

.countdown-header h3 {
    font-size: 2.2rem;
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
}

.countdown-header p {
    font-size: 1.1rem;
    color: var(--gray);
}

/* å€’è®¡æ—¶æ•°å­—æ˜¾ç¤º */
.countdown-display {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    margin: 2.5rem 0;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(76, 201, 240, 0.05));
    border-radius: var(--border-radius-lg);
    border: 2px solid rgba(67, 97, 238, 0.1);
}

.countdown-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.countdown-number {
    font-size: 4rem;
    font-weight: 800;
    color: var(--primary);
    text-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    background: white;
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius-lg);
    min-width: 110px;
    box-shadow: var(--shadow-md);
    margin-bottom: 0.5rem;
    position: relative;
    overflow: hidden;
}

.countdown-number::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transform: translateX(-100%);
}

.countdown-display:hover .countdown-number::before {
    animation: shine 1.5s ease;
}

.countdown-label {
    font-size: 1rem;
    color: var(--gray);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.countdown-separator {
    font-size: 3rem;
    color: var(--primary);
    font-weight: bold;
    margin-top: -1.5rem;
}

/* å€’è®¡æ—¶ä¿¡æ¯å¡ç‰‡ */
.countdown-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin: 2.5rem 0;
}

.info-card {
    background: var(--gradient-glass);
    backdrop-filter: blur(10px);
    border: var(--glass-border);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-align: left;
    transition: var(--transition-smooth);
}

.info-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
}

.info-card i {
    font-size: 2rem;
    color: var(--primary);
    width: 60px;
    height: 60px;
    background: rgba(67, 97, 238, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-card h4 {
    font-size: 1rem;
    color: var(--dark);
    margin-bottom: 0.3rem;
}

.info-card p {
    font-size: 0.95rem;
    color: var(--gray);
}

/* å€’è®¡æ—¶æ¶ˆæ¯ */
.countdown-message {
    background: rgba(46, 204, 113, 0.1);
    border: 2px solid var(--success);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    margin: 2rem 0;
    color: var(--success);
    font-size: 1.1rem;
    font-weight: 600;
}

/* å€’è®¡æ—¶æ“ä½œæŒ‰é’® */
.countdown-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin: 2.5rem 0;
}

/* è¿‡å¾€æ´»åŠ¨ */
.past-events {
    background: rgba(248, 249, 250, 0.8);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-top: 3rem;
}

.past-events h4 {
    text-align: left;
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(67, 97, 238, 0.1);
}

/* é¢œè‰²é€‰æ‹©å™¨ */
.color-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: var(--transition-quick);
}

.color-option:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-md);
}

.color-option.active {
    border-color: var(--dark);
    transform: scale(1.1);
}

/* å€’è®¡æ—¶é¢„è§ˆ */
.countdown-preview {
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(247, 37, 133, 0.05));
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    border: 2px dashed var(--primary-light);
}

.preview-display {
    margin-top: 1.5rem;
}

.preview-numbers {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.preview-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    background: white;
    padding: 0.8rem 1.2rem;
    border-radius: var(--border-radius-md);
    min-width: 80px;
    box-shadow: var(--shadow-sm);
}

.preview-separator {
    font-size: 2rem;
    color: var(--primary);
    font-weight: bold;
    margin-top: -0.5rem;
}

.preview-labels {
    display: flex;
    justify-content: center;
    gap: 5rem;
    margin-left: 1rem;
    font-size: 0.9rem;
    color: var(--gray);
    font-weight: 600;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.countdown-stats {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    border: var(--glass-border);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.stat-card {
    background: var(--gradient-glass);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    text-align: center;
    transition: var(--transition-smooth);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--gray);
}

/* è¿‡å¾€æ´»åŠ¨åˆ—è¡¨ */
.event-history {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.history-item {
    background: white;
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 4px solid var(--primary);
    transition: var(--transition-smooth);
}

.history-item:hover {
    transform: translateX(10px);
    box-shadow: var(--shadow-md);
}

.history-date {
    font-weight: 600;
    color: var(--primary-dark);
    font-size: 1.1rem;
}

.history-title {
    color: var(--dark);
    margin-top: 0.3rem;
}

.history-status {
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-completed {
    background: rgba(46, 204, 113, 0.1);
    color: var(--success);
}

.status-upcoming {
    background: rgba(52, 152, 219, 0.1);
    color: var(--info);
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 992px) {
    .countdown-display {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .countdown-number {
        font-size: 3rem;
        min-width: 90px;
        padding: 0.8rem 1.2rem;
    }
    
    .countdown-separator {
        font-size: 2rem;
        margin-top: -1rem;
    }
}

@media (max-width: 768px) {
    .countdown-container {
        padding: 2rem;
    }
    
    .countdown-number {
        font-size: 2.5rem;
        min-width: 80px;
    }
    
    .countdown-info {
        grid-template-columns: 1fr;
    }
    
    .countdown-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .countdown-actions .btn {
        width: 100%;
    }
}

@media (max-width: 576px) {
    .countdown-number {
        font-size: 2rem;
        min-width: 70px;
        padding: 0.6rem 1rem;
    }
    
    .countdown-separator {
        font-size: 1.5rem;
    }
    
    .preview-number {
        font-size: 2rem;
        min-width: 60px;
        padding: 0.5rem 0.8rem;
    }
    
    .preview-labels {
        gap: 3.5rem;
    }
}

/* å€’è®¡æ—¶åŠ¨ç”» */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.countdown-number.updated {
    animation: pulse 0.5s ease;
}

/* ç´§æ€¥å€’è®¡æ—¶æ ·å¼ï¼ˆå½“æ—¶é—´å°‘äº24å°æ—¶ï¼‰ */
.countdown-urgent .countdown-number {
    color: var(--danger);
    background: linear-gradient(135deg, #fff, #ffeaea);
    box-shadow: 0 8px 25px rgba(231, 76, 60, 0.2);
}

.countdown-urgent .countdown-separator {
    color: var(--danger);
}

/* å·²å®Œæˆå€’è®¡æ—¶æ ·å¼ */
.countdown-completed .countdown-display {
    opacity: 0.5;
}

.countdown-completed .countdown-number {
    color: var(--success);
}
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <a href="#dashboard" class="logo nav-link" data-page="dashboard">
                <div class="logo-icon">
                    <i class="fas fa-hands-helping"></i>
                </div>
                <div class="logo-text">
                    <h1>Foon Yew High School - Kaohsiung Senior High School Online Exchange Platform</h1>
                    <p>Cross-cultural Academic Exchange and Collaboration Platform</p>
                </div>
            </a>
            <div class="user-menu">
                <div id="auth-buttons">
                    <button id="login-btn" class="btn btn-outline">Login</button>
                    <button id="register-btn" class="btn btn-primary">Register</button>
                </div>
                <div id="user-profile" style="display: none;">
                    <div class="user-info" id="user-info-btn">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <div>
                            <div id="user-name">ç”¨æˆ·</div>
                            <div id="user-role" style="font-size: 0.8rem; opacity: 0.8;">Student</div>
                        </div>
                    </div>
                    <button id="logout-btn" class="btn btn-small btn-outline">Logout</button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav>
        <div class="container nav-container">
            <ul class="nav-links">
                <li><a href="#dashboard" class="nav-link active" data-page="dashboard">Dashboard</a></li>
<li><a href="#announcements" class="nav-link" data-page="announcements">Announcements</a></li>
<li><a href="#wall" class="nav-link" data-page="wall">Exchange Wall</a></li>
<li><a href="#calendar" class="nav-link" data-page="calendar">Event Calendar</a></li>
<li><a href="#countdown" class="nav-link" data-page="countdown">Countdown</a></li>
<li><a href="#profile" class="nav-link" data-page="profile">Profile</a></li>
            </ul>
            <div class="nav-right">
                <div id="admin-menu" style="display: none;">
                    <button id="admin-btn" class="btn btn-secondary btn-small">
                        <i class="fas fa-cog"></i> Admin Panel
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="container">
        <!-- Dashboard Page -->
        <section id="dashboard-page" class="page active">
            <div class="welcome-section">
                <h2>Welcome to the Online Exchange Platform</h2>
                <p>Facilitating academic and cultural exchange between Foon Yew High School and Kaohsiung Senior High School</p>
                <div id="welcome-display"></div>
            </div>
            
            <div class="page-header">
                <h2>Platform Overview</h2>
                <p>Stay updated with the latest activities and statistics</p>
            </div>
            
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bullhorn"></i>
                        <h3>Latest Announcements</h3>
                    </div>
                    <div class="card-body">
                        <div id="recent-announcements">
                            <p>Loading...</p>
                        </div>
                        <button class="btn btn-outline btn-small" style="margin-top: 15px;" data-page="announcements">View All Announcements</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Upcoming Events</h3>
                    </div>
                    <div class="card-body">
                        <div id="upcoming-events">
                            <p>Loading...</p>
                        </div>
                        <button class="btn btn-outline btn-small" style="margin-top: 15px;" data-page="calendar">View Calendar</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users"></i>
                        <h3>Exchange Statistics</h3>
                    </div>
                    <div class="card-body">
<div id="exchange-stats">
    <div class="stat-item">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <span>Total Participants</span>
        <strong id="total-participants">4</strong>
        <div class="stat-progress">
            <div class="stat-progress-bar"></div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon"><i class="fas fa-user-check"></i></div>
        <span>Online Users</span>
        <strong id="online-users">0</strong>
        <div class="stat-progress">
            <div class="stat-progress-bar"></div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon"><i class="fas fa-comments"></i></div>
        <span>Total Posts</span>
        <strong id="total-posts">0</strong>
        <div class="stat-progress">
            <div class="stat-progress-bar"></div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
        <span>Total Events</span>
        <strong id="total-events">1</strong>
        <div class="stat-progress">
            <div class="stat-progress-bar"></div>
        </div>
    </div>
</div>
                        <button class="btn btn-outline btn-small" style="margin-top: 15px;" data-page="wall">View Exchange Wall</button>
                    </div>
                </div>
            </div>
            
            <div class="page-header">
                <h2>Featured Exchange Programs</h2>
                <p>Explore diverse exchange activities between the two schools</p>
            </div>
            
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Academic Seminars</h3>
                    </div>
                    <div class="card-body">
                        <p>Inter-Secondary School Online Academic Forum for Students (Science, Humanities, Arts)</p>
                        <button class="btn btn-primary btn-small" style="margin-top: 15px;" id="academic-btn">Learn More</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-trophy"></i>
                        <h3>Joint Competitions</h3>
                    </div>
                    <div class="card-body">
                        <p>Regularly held online knowledge competitions, debates, and creative contests to showcase students' talents.</p>
                        <button class="btn btn-primary btn-small" style="margin-top: 15px;" id="competition-btn">View Competitions</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-language"></i>
                        <h3>Language Exchange</h3>
                    </div>
                    <div class="card-body">
                        <p>A multi-language learning partner matching system (covering Mandarin, English, Malay, etc.) to enhance language proficiency.</p>
                        <button class="btn btn-primary btn-small" style="margin-top: 15px;" id="language-btn">Find Language Partners</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Announcements Page -->
        <section id="announcements-page" class="page">
            <div class="page-header">
                <h2>Announcements Board</h2>
                <p>View the latest notifications and important information about exchange activities</p>
            </div>
            
            <div id="announcements-list" class="announcement-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading announcements...</p>
                </div>
            </div>
        </section>
        
        <!-- Wall Page -->
        <section id="wall-page" class="page">
            <div class="page-header">
                <h2>Exchange Wall</h2>
                <p>Share your thoughts, works, or interact with exchange partners</p>
            </div>

                <!-- æ·»åŠ ï¼šExchange Links Section -->
    <div class="exchange-links-container">
        <div class="exchange-links-header">
            <h3>Exchange Resource Links</h3>
            <div id="admin-link-controls" style="display: none;">
                <button id="manage-links-btn" class="btn btn-primary btn-small">
                    <i class="fas fa-cog"></i> Manage Links
                </button>
            </div>
        </div>
        
        <!-- é“¾æ¥å°†åœ¨è¿™é‡Œç›´æ¥æ˜¾ç¤ºä¸ºåµŒå…¥å¼å†…å®¹ -->
        <div id="exchange-links-display">
            <!-- ç¬¬ä¸€ä¸ªPadleté“¾æ¥ -->
            <div class="link-item">
                <div class="link-header">
                    <h4>School Culture Exchange 2026</h4>
                    <p>Padlet for sharing and discussing school culture between FYHS and KSHS</p>
                </div>
                <div class="link-content">
                    <div class="link-iframe-container">
                        <iframe 
                            src="https://padlet.com/jb220202/fyhs-kshs-exchange-online-2026-school-culture-22-1-26-canbxnwed0c3x8d2" 
                            class="link-iframe"
                            allow="camera;microphone;display-capture"
                            loading="lazy">
                        </iframe>
                    </div>
                </div>
                <div class="link-footer">
                    <span>Added by: Admin | Date: 2026-01-05</span>
                </div>
            </div>
            
            <!-- ç¬¬äºŒä¸ªPadleté“¾æ¥ -->
            <div class="link-item">
                <div class="link-header">
                    <h4>Self Introduction Exchange</h4>
                    <p>Students introduce themselves to their exchange partners</p>
                </div>
                <div class="link-content">
                    <div class="link-iframe-container">
                        <iframe 
                            src="https://padlet.com/jb220202/self-introduction-fyhs-kshs-exchange-online-202-m6gvpozj5zaesseb" 
                            class="link-iframe"
                            allow="camera;microphone;display-capture"
                            loading="lazy">
                        </iframe>
                    </div>
                </div>
                <div class="link-footer">
                    <span>Added by: Admin | Date: 2026-01-05</span>
                </div>
            </div>
            
            <div class="padlet-container">
                <div class="padlet-header">
                    <h3>Cross-school Exchange Wall</h3>
                    <button id="add-note-btn" class="btn btn-primary" disabled>
                        <i class="fas fa-plus"></i> Add Post
                    </button>
                </div>
                <div id="padlet-wall" class="padlet-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading Communication Wall...</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Calendar Page -->
        <section id="calendar-page" class="page">
            <div class="page-header">
                <h2>Event Calendar</h2>
                <p>View all online exchange activities and important dates</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="view-calendar">View Calendar</button>
                <button class="tab" data-tab="add-event" id="add-event-tab">Add Event</button>
            </div>
            
            <div id="view-calendar" class="tab-content active">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3 id="current-month">2026 January</h3>
                        <div>
                            <button id="prev-month" class="btn btn-outline btn-small"><i class="fas fa-chevron-left"></i></button>
                            <button id="today-btn" class="btn btn-outline btn-small">Today</button>
                            <button id="next-month" class="btn btn-outline btn-small"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div id="calendar" class="calendar-grid">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div id="add-event" class="tab-content">
                <div class="form-container">
                    <h3>Add New Event</h3>
                    <form id="event-form">
                        <div class="form-group">
                            <label for="event-title">Event Title</label>
                            <input type="text" id="event-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="event-description">Event Description</label>
                            <textarea id="event-description" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="event-date">Event Date</label>
                            <input type="date" id="event-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="event-time">Event Time</label>
                            <input type="time" id="event-time" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="event-type">Event Type</label>
                            <select id="event-type" class="form-control">
                                <option value="academic">Academic Seminar</option>
                                <option value="cultural">Cultural Exchange</option>
                                <option value="competition">Joint Competition</option>
                                <option value="language">Language Exchange</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event-school">Host School</label>
                            <select id="event-school" class="form-control">
                                <option value="both">Joint by Both Schools</option>
                                <option value="fyhs">Foon Yew High School</option>
                                <option value="kshs">Kaohsiung Senior High School</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Add Event</button>
                            <button type="button" class="btn btn-outline" id="cancel-event">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

<!-- Countdown Page -->
<section id="countdown-page" class="page">
    <div class="page-header">
        <h2>Exchange Countdown</h2>
        <p>Countdown display and setup for the next exchange event</p>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="countdown-view">Countdown View</button>
        <button class="tab" data-tab="countdown-admin" id="countdown-admin-tab">Countdown Settings</button>
    </div>
    
    <!-- ç”¨æˆ·å€’è®¡æ—¶è§†å›¾ -->
    <div id="countdown-view" class="tab-content active">
        <div class="countdown-container">
            <div class="countdown-header">
                <h3 id="countdown-event-title">Next Online Exchange Session</h3>
                <p id="countdown-event-desc">Online Exchange Program between Foon Yew High School and Kaohsiung Municipal Kaohsiung Senior High School</p>
            </div>
            
            <div class="countdown-display" id="countdown-display">
                <div class="countdown-unit">
                    <div class="countdown-number" id="days">00</div>
                    <div class="countdown-label">Days</div>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-unit">
                    <div class="countdown-number" id="hours">00</div>
                    <div class="countdown-label">Hours</div>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-unit">
                    <div class="countdown-number" id="minutes">00</div>
                    <div class="countdown-label">Minutes</div>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-unit">
                    <div class="countdown-number" id="seconds">00</div>
                    <div class="countdown-label">Seconds</div>
                </div>
            </div>
            
            <div class="countdown-info">
                <div class="info-card">
                    <i class="fas fa-calendar-check"></i>
                    <div>
                        <h4>Event Time</h4>
                        <p id="event-date-time">Not set</p>
                    </div>
                </div>
                <div class="info-card">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <h4>Event Format</h4>
                        <p id="event-platform">Online Conference Platform</p>
                    </div>
                </div>
                <div class="info-card">
                    <i class="fas fa-users"></i>
                    <div>
                        <h4>Expected Participants</h4>
                        <p id="event-participants">0 person</p>
                    </div>
                </div>
            </div>
            
            <div class="countdown-message" id="countdown-message">
                Loading countdown information...
            </div>
            
            <div class="countdown-actions">
                <button class="btn btn-primary" id="set-reminder-btn">
                    <i class="fas fa-bell"></i> Set Reminder
                </button>
                <button class="btn btn-outline" id="share-countdown-btn">
                    <i class="fas fa-share-alt"></i> Share Countdown
                </button>
                <button class="btn btn-outline" id="view-details-btn">
                    <i class="fas fa-info-circle"></i> View Event Details
                </button>
            </div>
            
            <!-- è¿‡å¾€æ´»åŠ¨è®°å½• -->
            <div class="past-events" id="past-events-section">
                <h4>Past Exchange Events</h4>
                <div id="past-events-list">
                    <!-- è¿‡å¾€æ´»åŠ¨å°†é€šè¿‡JSåŠ è½½ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†å‘˜è®¾ç½®è§†å›¾ -->
    <div id="countdown-admin" class="tab-content">
        <div class="form-container">
            <h3>Set Exchange Countdown</h3>
            <p style="margin-bottom: 2rem; color: var(--gray);">Set the time and details for the next online exchange event.</p>
            
            <form id="countdown-settings-form">
                <div class="form-group">
                    <label for="countdown-event-name">Event Name *</label>
                    <input type="text" id="countdown-event-name" class="form-control" 
                           placeholder="For example: The First Online Cultural Exchange Conference" required>
                </div>
                
                <div class="form-group">
                    <label for="countdown-event-description">Event Description</label>
                    <textarea id="countdown-event-description" class="form-control" rows="3"
                              placeholder="Describe the content and significance of this event..."></textarea>
                </div>
                
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label for="countdown-event-date">Event Date *</label>
                        <input type="date" id="countdown-event-date" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="countdown-event-time">Event Time *</label>
                        <input type="time" id="countdown-event-time" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="countdown-event-platform">Event Platform</label>
                    <select id="countdown-event-platform" class="form-control">
                        <option value="zoom">Zoom Meeting</option>
                        <option value="google-meet">Google Meet</option>
                        <option value="microsoft-teams">Microsoft Teams</option>
                        <option value="other">Other Platform</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="countdown-event-link">Event Link</label>
                    <input type="url" id="countdown-event-link" class="form-control" 
                           placeholder="https://meet.google.com/xxx-xxxx-xxx">
                </div>
                
                <div class="form-group">
                    <label for="countdown-event-participants">Expected Participants</label>
                    <input type="number" id="countdown-event-participants" class="form-control" 
                           placeholder="Exampleï¼š200" min="0">
                </div>
                
                <div class="form-group">
                    <label for="countdown-event-theme">Event Theme Color</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <div class="color-option" data-color="#4361ee" style="background-color: #4361ee;"></div>
                        <div class="color-option" data-color="#f72585" style="background-color: #f72585;"></div>
                        <div class="color-option" data-color="#4cc9f0" style="background-color: #4cc9f0;"></div>
                        <div class="color-option" data-color="#7209b7" style="background-color: #7209b7;"></div>
                        <div class="color-option" data-color="#3a0ca3" style="background-color: #3a0ca3;"></div>
                    </div>
                    <input type="hidden" id="countdown-event-color" value="#4361ee">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Countdown Settings</button>
                    <button type="button" class="btn btn-outline" id="test-countdown-btn">
                        Test Countdown Display
                    </button>
                    <button type="button" class="btn btn-outline" id="clear-countdown-btn">
                        Clear Countdown
                    </button>
                </div>
            </form>
            
            <!-- å€’è®¡æ—¶é¢„è§ˆ -->
            <div class="countdown-preview" id="countdown-preview" style="margin-top: 3rem;">
                <h4>Countdown Preview</h4>
                <div class="preview-display">
                    <div class="preview-numbers">
                        <span class="preview-number">00</span>
                        <span class="preview-separator">:</span>
                        <span class="preview-number">00</span>
                        <span class="preview-separator">:</span>
                        <span class="preview-number">00</span>
                        <span class="preview-separator">:</span>
                        <span class="preview-number">00</span>
                    </div>
                    <div class="preview-labels">
                        <span>Days</span>
                        <span>Hours</span>
                        <span>Minutes</span>
                        <span>Seconds</span>
                    </div>
                </div>
            </div>
            
            <!-- å€’è®¡æ—¶çŠ¶æ€ç»Ÿè®¡ -->
            <div class="countdown-stats" style="margin-top: 3rem;">
                <h4>Countdown Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-views">0</div>
                        <div class="stat-label">Total Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-reminders">0</div>
                        <div class="stat-label">Active Reminders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="days-remaining">--</div>
                        <div class="stat-label">Days Remaining</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
        
        <!-- Profile Page -->
        <section id="profile-page" class="page">
            <div class="page-header">
                <h2>Personal Center</h2>
                <p>Manage your profile and exchange activity records</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="profile-info">Profile</button>
                <button class="tab" data-tab="profile-activity">Activity</button>
                <button class="tab" data-tab="profile-settings">Account Settings</button>
            </div>
            
            <div id="profile-info" class="tab-content active">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">U</div>
                    <div class="profile-info">
                        <h2 id="profile-name">User Name</h2>
                        <p id="profile-school">School: Not Set</p>
                        <p id="profile-grade">Grade: Not Set</p>
                        <p id="profile-email">Email: Not Set</p>
                        <div id="profile-interests">
                            <span class="badge badge-primary">äº¤æµæ´»åŠ¨</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-container">
                    <h3>Edit Profile</h3>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="edit-name">Name</label>
                            <input type="text" id="edit-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-school">School</label>
                            <select id="edit-school" class="form-control" required>
                                <option value="">Please select your school</option>
                                <option value="fyhs">Foon Yew High School</option>
                                <option value="kshs">Kaohsiung Municipal Kaohsiung Senior High School</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-grade">Grade</label>
                            <input type="text" id="edit-grade" class="form-control" placeholder="Example: Senior 1, Senior 2" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-interests">Interests (comma separated)</label>
                            <input type="text" id="edit-interests" class="form-control" placeholder="Example: Basketball, Painting, Programming">
                        </div>
                        <div class="form-group">
                            <label for="edit-bio">Bio</label>
                            <textarea id="edit-bio" class="form-control" rows="4" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-avatar">Avatar</label>
                            <div class="file-upload" id="avatar-upload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload avatar</p>
                                <p>Supports JPG and PNG formats, maximum 5MB.</p>
                                <input type="file" id="edit-avatar" accept="image/*" style="display: none;">
                            </div>
                            <div id="avatar-preview" style="margin-top: 10px; display: none;">
                                <img id="avatar-preview-img" style="max-width: 150px; border-radius: 50%;">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="profile-activity" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history"></i>
                        <h3>Activity History</h3>
                    </div>
                    <div class="card-body">
                        <div id="activity-history">
                            <p>No activity records available.</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-certificate"></i>
                        <h3>Achievement Badges</h3>
                    </div>
                    <div class="card-body">
                        <div id="achievement-badges">
                            <div class="empty-state">
                                <i class="fas fa-trophy"></i>
                                <p>No achievement badges available.</p>
                                <p>Participate in more exchange activities to unlock achievements.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="profile-settings" class="tab-content">
                <div class="form-container">
                    <h3>Account Settings</h3>
                    
                    <div class="form-group">
                        <label>Notification Settings</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="notify-announcements" checked> 
                                <span style="margin-left: 10px;">New Announcement Notifications</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="notify-events" checked> 
                                <span style="margin-left: 10px;">Event Reminders</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="notify-messages" checked> 
                                <span style="margin-left: 10px;">Message Notifications</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="change-password-btn" class="btn btn-outline">Change Password</button>
                    </div>
                    
                    <div class="form-group">
                        <button id="delete-account-btn" class="btn btn-outline" style="color: var(--danger); border-color: var(--danger);">Delete Account</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Admin Page -->
        <section id="admin-page" class="page">
            <div class="page-header">
                <h2>Admin Panel</h2>
                <p>Manage platform content, users, and exchange activities</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="admin-dashboard">Dashboard</button>
                <button class="tab" data-tab="admin-users">User Management</button>
                <button class="tab" data-tab="admin-content">Content Management</button>
                <button class="tab" data-tab="admin-settings">System Settings</button>
                <button class="tab" data-tab="admin-tracking">Task Tracking</button>
            </div>
            
            <div id="admin-dashboard" class="tab-content active">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>Platform Statistics</h3>
                        </div>
                        <div class="card-body">
                            <div id="admin-stats">
                                <p>Registered Users: <strong id="admin-total-users">0</strong></p>
                                <p>Active Today: <strong id="admin-active-today">0</strong></p>
                                <p>Total Announcements: <strong id="admin-total-announcements">0</strong></p>
                                <p>Total Posts: <strong id="admin-total-posts">0</strong></p>
                                <p>Total Events: <strong id="admin-total-events">0</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-bullhorn"></i>
                            <h3>Post Announcement</h3>
                        </div>
                        <div class="card-body">
                            <form id="admin-announcement-form">
                                <div class="form-group">
                                    <label for="admin-announcement-title">Announcement Title</label>
                                    <input type="text" id="admin-announcement-title" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="admin-announcement-content">Announcement Content</label>
                                    <textarea id="admin-announcement-content" class="form-control" rows="4" required></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Post Announcement</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>Create Event</h3>
                        </div>
                        <div class="card-body">
                            <form id="admin-event-form">
                                <div class="form-group">
                                    <label for="admin-event-title">Event Title</label>
                                    <input type="text" id="admin-event-title" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="admin-event-date">Event Date</label>
                                    <input type="date" id="admin-event-date" class="form-control" required>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Create Event</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="admin-users" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users-cog"></i>
                        <h3>User Management</h3>
                    </div>
                    <div class="card-body">
                        <div id="user-management">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="admin-content" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-comments"></i>
                        <h3>Exchange Wall Management</h3>
                    </div>
                    <div class="card-body">
                        <div id="admin-wall-posts">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Event Management</h3>
                    </div>
                    <div class="card-body">
                        <div id="admin-events">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

<!-- Task Tracking Content -->
<div id="admin-tracking" class="tab-content">
    <div class="card">
        <div class="card-header">
            <i class="fas fa-tasks"></i>
            <h3>Student Task Tracking</h3>
        </div>
        <div class="card-body">
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab active" data-tab="tracking-overview">Overview</button>
                <button class="tab" data-tab="tracking-tasks">Manage Tasks</button>
                <button class="tab" data-tab="tracking-students">Student Progress</button>
                <button class="tab" data-tab="tracking-reports">Reports</button>
            </div>
            
            <!-- Overview Tab -->
            <div id="tracking-overview" class="tab-content active">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user-check"></i>
                            <h3>Completion Statistics</h3>
                        </div>
                        <div class="card-body">
                            <div id="tracking-stats">
                                <p>Loading statistics...</p>
                            </div>
                        </div>
                    </div>
                    
<!-- Progress Overview Card - ä¿®æ”¹å -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-chart-line"></i>
        <h3>Progress Overview</h3>
    </div>
    <div class="card-body">
        <div id="progress-chart-container" style="height: 300px; position: relative;">
            <canvas id="progress-chart"></canvas>
            <div id="chart-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.9); z-index: 10;">
                <div class="spinner" style="width: 40px; height: 40px; margin-bottom: 15px;"></div>
                <p style="color: var(--gray); font-size: 0.95rem;">Loading chart data...</p>
            </div>
            <div id="chart-error" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.9); z-index: 10;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--warning); margin-bottom: 15px;"></i>
                <p style="color: var(--gray); margin-bottom: 15px;">Failed to load chart</p>
                <button class="btn btn-small btn-outline" onclick="chartManager.refresh()">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        </div>
    </div>
</div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clock"></i>
                            <h3>Recent Activity</h3>
                        </div>
                        <div class="card-body">
                            <div id="recent-tracked-activities" style="max-height: 300px; overflow-y: auto;">
                                <p>Loading recent activities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Manage Tasks Tab -->
            <div id="tracking-tasks" class="tab-content">
                <div class="form-container">
                    <h3>Manage Tracked Tasks</h3>
                    
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>Available Tasks</h4>
                            <button id="add-task-btn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add New Task
                            </button>
                        </div>
                        
                        <div id="tasks-list" class="tasks-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading tasks...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Student Progress Tab -->
            <div id="tracking-students" class="tab-content">
                <div class="form-container">
                    <h3>Student Task Progress</h3>
                    
                    <div class="form-group">
                        <label for="student-filter">Filter Students</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="student-filter" class="form-control" placeholder="Search by name or email" onkeyup="filterStudents()">
                            <select id="school-filter" class="form-control" onchange="filterStudents()">
                                <option value="">All Schools</option>
                                <option value="fyhs">Foon Yew High School</option>
                                <option value="kshs">Kaohsiung Senior High School</option>
                            </select>
                            <select id="completion-filter" class="form-control" onchange="filterStudents()">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                            </select>
                        </div>
                        
                        <div id="students-progress-list">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading student progress...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="tracking-reports" class="tab-content">
                <div class="form-container">
                    <h3>Tracking Reports</h3>
                    
                    <div class="form-group">
                        <label for="report-type">Report Type</label>
                        <select id="report-type" class="form-control">
                            <option value="completion">Completion Report</option>
                            <option value="progress">Progress Report</option>
                            <option value="comparison">School Comparison</option>
                            <option value="timeline">Timeline Analysis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="date-range">Date Range</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="start-date" class="form-control">
                            <input type="date" id="end-date" class="form-control" value="2026-12-31">
                            <button id="generate-report" class="btn btn-primary">Generate Report</button>
                        </div>
                    </div>
                    
                    <div id="report-output" style="margin-top: 30px;">
                        <div class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <p>Select parameters and generate a report</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
            
            <div id="admin-settings" class="tab-content">
                <div class="form-container">
                    <h3>System Settings</h3>
                    
                    <div class="form-group">
                        <label for="platform-name">Platform Name</label>
                        <input type="text" id="platform-name" class="form-control" value="Foon Yew High School - Kaohsiung Senior High School Online Exchange Platform">
                    </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <i class="fas fa-images"></i>
                    <h3>School Logo Management</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Foon Yew High School Logo</label>
                        <div class="file-upload" id="fyhs-logo-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload Foon Yew High School Logo</p>
                            <p>Recommended size: 200x200px, PNG format.</p>
                            <input type="file" id="fyhs-logo-input" accept="image/*" style="display: none;">
                        </div>
                        <div id="fyhs-logo-preview" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Kaohsiung Senior High School Logo</label>
                        <div class="file-upload" id="kshs-logo-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload Kaohsiung Senior High School Logo</p>
                            <p>Recommended size: 200x200px, PNG format.</p>
                            <input type="file" id="kshs-logo-input" accept="image/*" style="display: none;">
                        </div>
                        <div id="kshs-logo-preview" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button id="save-logos" class="btn btn-primary">Save Logo Settings</button>
                    </div>
                </div>
            </div>
                    
                    <div class="form-group">
                        <label for="welcome-message">Welcome Message</label>
                        <textarea id="welcome-message" class="form-control" rows="4">Welcome to the Two-School Exchange Platformï¼</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenance-mode">Maintenance Mode</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" id="maintenance-mode"> 
                                <span style="margin-left: 10px;">Enable Maintenance Mode</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="save-settings" class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

            
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="school-logos">
                <div class="school-logo">
    <div class="logo-image-container">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ac/Foon_yew_logo.png" id="fyhs-logo-img" alt="å®½æŸ”ä¸­å­¦" 
             style="width: 120px; height: 120px; object-fit: contain; border-radius: 8px;">
    </div>
    <div style="font-weight: 600; color: #e53935; margin-top: 0.5rem;">é©¬æ¥è¥¿äºšå®½æŸ”ä¸­å­¦</div>
    <div style="font-size: 0.9rem; opacity: 0.8;">Foon Yew High School</div>
</div>
                
                <!-- åˆä½œæ ‡å¿— -->
                <div class="school-logo">
                    <div class="logo-image-container" style="background: rgba(255, 255, 255, 0.1); padding: 20px;">
                        <i class="fas fa-handshake" style="color: var(--accent); font-size: 3.5rem;"></i>
                    </div>
                    <div style="font-weight: 600; margin-top: 0.5rem;">çº¿ä¸Šäº¤æµå¹³å°</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Online Exchange Platform</div>
                </div>
                
                <!-- é«˜é›„ä¸­å­¦ Logo -->
                <div class="school-logo">
    <div class="logo-image-container">
        <img src="https://upload.wikimedia.org/wikipedia/zh/thumb/9/9e/%E9%9B%84%E4%B8%AD%E6%A0%A1%E5%BE%BD.svg/1200px-%E9%9B%84%E4%B8%AD%E6%A0%A1%E5%BE%BD.svg.png" id="kshs-logo-img" alt="é«˜é›„ä¸­å­¦" 
             style="width: 120px; height: 120px; object-fit: contain; border-radius: 8px;">
    </div>
    <div style="font-weight: 600; color: #1565c0; margin-top: 0.5rem;">å°æ¹¾é«˜é›„é«˜çº§ä¸­å­¦</div>
    <div style="font-size: 0.9rem; opacity: 0.8;">Kaohsiung Senior High School</div>
</div>
                
                <div class="footer-links">
                    <a href="#" id="about-link">About Us</a>
                    <a href="#" id="privacy-link">Privacy Policy</a>
                    <a href="#" id="terms-link">Terms of Use</a>
                    <a href="#" id="contact-link">Contact Us</a>
                </div>
            </div>
            
        <div class="copyright">
            <!-- æ·»åŠ å¼€å‘è€…ä¿¡æ¯ -->
            <div style="margin-bottom: 10px;">
                <i class="fas fa-code" style="margin-right: 5px; color: var(--accent);"></i>
                <span>Developed by: <strong>Tan Jun Yuan</strong></span>
            </div>
            
            <div>
                &copy; 2026 Foon Yew High School - Kaohsiung Senior High School Online Exchange Platform. All rights reserved.
            </div>
            
            <div style="margin-top: 8px; font-size: 0.85rem; opacity: 0.7;">
                Version 2.0 | Last updated: January 2026
            </div>
        </div>
    </div>
</footer>
    
    <!-- Modals -->
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Login</h3>
                <button class="modal-close" data-modal="login-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email Address</label>
                        <input type="email" id="login-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" class="form-control" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Login</button>
                        <button type="button" class="btn btn-outline" data-modal="login-modal">Cancel</button>
                    </div>
                </form>
                
                <div class="auth-divider">
                    <span>Or sign in with</span>
                </div>
                
                <button id="google-login-btn" class="google-btn">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <p>Don't have an accountï¼Ÿ <a href="#" id="switch-to-register">Sign up</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Registration</h3>
                <button class="modal-close" data-modal="register-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">Name</label>
                        <input type="text" id="register-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email Address</label>
                        <input type="email" id="register-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">Confirm Password</label>
                        <input type="password" id="register-confirm-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="register-school">School Affiliation</label>
                        <select id="register-school" class="form-control" required>
                            <option value="">Please select your school</option>
                            <option value="fyhs">Foon Yew High School</option>
                            <option value="kshs">Kaohsiung Municipal Kaohsiung Senior High School</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="register-grade">Grade</label>
                        <input type="text" id="register-grade" class="form-control" placeholder="Example: Senior 1, Senior 2" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Register</button>
                        <button type="button" class="btn btn-outline" data-modal="register-modal">Cancel</button>
                    </div>
                </form>
                
                <div class="auth-divider">
                    <span>Or sign up with</span>
                </div>
                
                <button id="google-register-btn" class="google-btn">
                    <i class="fab fa-google"></i> Sign up with Google
                </button>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <p>Already have an account? <a href="#" id="switch-to-login">Login</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Note Modal -->
    <div id="add-note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Discussion Post</h3>
                <button class="modal-close" data-modal="add-note-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <div class="form-group">
                        <label for="note-title">Title (Optional)</label>
                        <input type="text" id="note-title" class="form-control" placeholder="Add a title to your post.">
                    </div>
                    <div class="form-group">
                        <label for="note-content">Content</label>
                        <textarea id="note-content" class="form-control" rows="5" placeholder="Share your thoughts, work, or interact with your exchange partners..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="note-color">Post Color</label>
                        <div style="display: flex; gap: 10px;">
                            <div class="note-color-option" data-color="yellow" style="background-color: #fffacd; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                            <div class="note-color-option" data-color="blue" style="background-color: #d0e7ff; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                            <div class="note-color-option" data-color="green" style="background-color: #d4edda; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                            <div class="note-color-option" data-color="pink" style="background-color: #f8d7da; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                        </div>
                        <input type="hidden" id="note-color-value" value="yellow">
                    </div>
                    <div class="form-group">
                        <label for="note-image">Upload Image (Optional)</label>
                        <div class="file-upload" id="note-image-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload image</p>
                            <p>Supports JPG and PNG formats, maximum 5MB.</p>
                            <input type="file" id="note-image" accept="image/*" style="display: none;">
                        </div>
                        <div id="image-preview" style="margin-top: 10px; display: none;">
                            <img id="image-preview-img" style="max-width: 200px; border-radius: 5px;">
                            <button type="button" id="remove-image" style="margin-left: 10px; color: var(--danger);">Remove Image</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Publish Post</button>
                        <button type="button" class="btn btn-outline" data-modal="add-note-modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close" data-modal="change-password-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" class="form-control" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Change Password</button>
                        <button type="button" class="btn btn-outline" data-modal="change-password-modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Event Detail Modal -->
    <div id="event-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="event-detail-title">Event Details</h3>
                <button class="modal-close" data-modal="event-detail-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="event-detail-content">
                    <!-- Event details will be loaded here -->
                </div>
                <div id="event-detail-actions" class="form-actions" style="margin-top: 20px;">
                    <!-- Action buttons will be added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ°æ‰€æœ‰ç°æœ‰æ¨¡æ€æ¡†ä¹‹åï¼Œ</body>æ ‡ç­¾ä¹‹å‰ -->

<!-- ç¼–è¾‘å…¬å‘Šæ¨¡æ€æ¡† -->
<div id="edit-announcement-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Announcement</h3>
            <button class="modal-close" data-modal="edit-announcement-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-announcement-form">
                <input type="hidden" id="edit-announcement-id">
                <div class="form-group">
                    <label for="edit-announcement-title">Announcement Title</label>
                    <input type="text" id="edit-announcement-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-announcement-content">Announcement Content</label>
                    <textarea id="edit-announcement-content" class="form-control" rows="6" required></textarea>
                </div>
                <div class="edit-log" id="announcement-edit-log"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline" data-modal="edit-announcement-modal">Cancel</button>
                    <button type="button" class="btn btn-undo" id="undo-announcement-changes">
                        <i class="fas fa-undo"></i> Undo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘è´´æ–‡æ¨¡æ€æ¡† -->
<div id="edit-note-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Post</h3>
            <button class="modal-close" data-modal="edit-note-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-note-form">
                <input type="hidden" id="edit-note-id">
                <input type="hidden" id="edit-note-color" value="yellow">
                <div class="form-group">
                    <label for="edit-note-title">Title (Optional)</label>
                    <input type="text" id="edit-note-title" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-note-content">Content</label>
                    <textarea id="edit-note-content" class="form-control" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-note-color-picker">Content Color</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="note-color-option edit" data-color="yellow" style="background-color: #fffacd; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                        <div class="note-color-option edit" data-color="blue" style="background-color: #d0e7ff; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                        <div class="note-color-option edit" data-color="green" style="background-color: #d4edda; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                        <div class="note-color-option edit" data-color="pink" style="background-color: #f8d7da; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid #ccc;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Image</label>
                    <div id="current-note-image" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group">
                    <label for="edit-note-image">Change Image (Optional)</label>
                    <div class="file-upload" id="edit-note-image-upload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload new image</p>
                        <p>Supports JPG and PNG formats, maximum 5MB.</p>
                        <input type="file" id="edit-note-image" accept="image/*" style="display: none;">
                    </div>
                    <div id="edit-image-preview" style="margin-top: 10px; display: none;">
                        <img id="edit-image-preview-img" style="max-width: 200px; border-radius: 5px;">
                        <button type="button" id="remove-edit-image" style="margin-left: 10px; color: var(--danger);">Remove new image</button>
                    </div>
                    <div id="image-actions" style="margin-top: 10px;">
                        <button type="button" class="btn btn-small btn-outline" id="remove-existing-image" style="color: var(--danger);">
                            <i class="fas fa-trash"></i> Remove existing image
                        </button>
                    </div>
                </div>
                <div class="edit-log" id="note-edit-log"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline" data-modal="edit-note-modal">Cancel</button>
                    <button type="button" class="btn btn-undo" id="undo-note-changes">
                        <i class="fas fa-undo"></i> Redo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘æ´»åŠ¨æ¨¡æ€æ¡† -->
<div id="edit-event-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Event</h3>
            <button class="modal-close" data-modal="edit-event-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-event-form">
                <input type="hidden" id="edit-event-id">
                <div class="form-group">
                    <label for="edit-event-title">Event Title</label>
                    <input type="text" id="edit-event-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-event-description">Event Description</label>
                    <textarea id="edit-event-description" class="form-control" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-event-date">Event Date</label>
                    <input type="date" id="edit-event-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-event-time">Event Time</label>
                    <input type="time" id="edit-event-time" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-event-type">Event Type</label>
                    <select id="edit-event-type" class="form-control">
                        <option value="academic">Academic Seminar</option>
                        <option value="cultural">Cultural Exchange</option>
                        <option value="competition">Joint Competition</option>
                        <option value="language">Language Exchange</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-event-school">Host School</label>
                    <select id="edit-event-school" class="form-control">
                        <option value="both">Joint by Both Schools</option>
                        <option value="fyhs">Foon Yew High School</option>
                        <option value="kshs">Kaohsiung Senior High School</option>
                    </select>
                </div>
                <div class="edit-log" id="event-edit-log"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-outline" data-modal="edit-event-modal">Cancel</button>
                    <button type="button" class="btn btn-undo" id="undo-event-changes">
                        <i class="fas fa-undo"></i> Redo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
<div id="confirm-delete-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="background: var(--gradient-secondary);">
            <h3>Confirm Deletion</h3>
            <button class="modal-close" data-modal="confirm-delete-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="delete-message">Are you sure you want to delete this item?</div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="confirm-delete-btn">Confirm Delete</button>
                <button type="button" class="btn btn-outline" data-modal="confirm-delete-modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
<div id="batch-actions" class="batch-actions">
    <div class="select-all">
        <input type="checkbox" id="select-all-items">
        <label for="select-all-items">Select all items</label>
        <span id="selected-count">0 items selected</span>
    </div>
    <div class="batch-buttons">
        <button id="batch-delete" class="btn btn-small" style="background-color: var(--danger); color: white;">
            <i class="fas fa-trash"></i> Batch Delete
        </button>
        <button id="clear-selection" class="btn btn-small btn-outline">
            Clear Selection
        </button>
    </div>
</div>

<!-- è‡ªåŠ¨ä¿å­˜çŠ¶æ€æç¤º -->
<div id="autosave-status" class="autosave-status">
    <i class="fas fa-save"></i>
    <span id="autosave-text">Saving changes...</span>
</div>

<!-- é”®ç›˜å¿«æ·é”®æç¤º -->
<div id="shortcut-hint" class="shortcut-hint">
    <div><kbd>Ctrl+S</kbd> Save</div>
    <div><kbd>Ctrl+Z</kbd> Undo</div>
    <div><kbd>Delete</kbd> Delete</div>
</div>

            <!-- Task Management Modal -->
<div id="task-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="task-modal-title">Manage Task</h3>
            <button class="modal-close" data-modal="task-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-name">Task Name *</label>
                    <input type="text" id="task-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="task-description">Task Description</label>
                    <textarea id="task-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="task-type">Task Type *</label>
                    <select id="task-type" class="form-control" required>
                        <option value="manual">Manual Tracking</option>
                        <option value="auto-registration">Auto: Registration</option>
                        <option value="auto-post">Auto: Wall Post</option>
                        <option value="auto-event">Auto: Event Participation</option>
                        <option value="auto-announcement">Auto: Read Announcement</option>
                        <option value="auto-profile">Auto: Profile Completion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-points">Points (Optional)</label>
                    <input type="number" id="task-points" class="form-control" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="task-deadline">Deadline (Optional)</label>
                    <input type="date" id="task-deadline" class="form-control">
                </div>
                <div class="form-group">
                    <label for="task-active">Status</label>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="task-active" checked> 
                            <span style="margin-left: 10px;">Active (Visible to students)</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Task</button>
                    <button type="button" class="btn btn-outline" data-modal="task-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Student Progress Detail Modal -->
<div id="student-progress-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="student-progress-title">Student Progress</h3>
            <button class="modal-close" data-modal="student-progress-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="student-progress-detail">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>
            
    <!-- Alert Container -->
    <div id="alert-container" style="position: fixed; top: 100px; right: 20px; z-index: 10000; max-width: 350px;"></div>
    
   <script>
    // Firebase Configuration - æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyD1FOM9GSgVTLd4p0JJEbFtrwHQlF751nM",
  authDomain: "fyhs-kshs-online-exchange.firebaseapp.com",
  projectId: "fyhs-kshs-online-exchange",
  storageBucket: "fyhs-kshs-online-exchange.firebasestorage.app",
  messagingSenderId: "67080755408",
  appId: "1:67080755408:web:7e02b55ff12162f456a6d5",
  measurementId: "G-BX3JHH3CDZ"
};

       // === åœ¨firebaseConfigä¹‹åæ·»åŠ  ===
const CLOUDINARY_CONFIG = {
    cloudName: 'dxtpm8o3j',
    // ä½¿ç”¨upload presetè€Œä¸æ˜¯APIå¯†é’¥
    uploadPreset: 'school_exchange', // æ‚¨éœ€è¦å…ˆåˆ›å»ºè¿™ä¸ªpreset
    apiKey: '771132298449885' // è¯·æ›¿æ¢ä¸ºæ–°çš„API Key
};
    
    // Initialize Firebase
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (error) {
        console.log("Firebase already initialized");
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // DOM Elements
    const pages = {
        dashboard: document.getElementById('dashboard-page'),
        announcements: document.getElementById('announcements-page'),
        wall: document.getElementById('wall-page'),
        calendar: document.getElementById('calendar-page'),
        profile: document.getElementById('profile-page'),
        admin: document.getElementById('admin-page'),
        countdown: document.getElementById('countdown-page')
    };
    
    const navLinks = document.querySelectorAll('.nav-link');
    const authButtons = document.getElementById('auth-buttons');
    const userProfile = document.getElementById('user-profile');
    const userName = document.getElementById('user-name');
    const userRole = document.getElementById('user-role');
    const userAvatar = document.getElementById('user-avatar');
    const adminMenu = document.getElementById('admin-menu');
    const adminBtn = document.getElementById('admin-btn');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const addNoteBtn = document.getElementById('add-note-btn');
    const userInfoBtn = document.getElementById('user-info-btn');
    
    // Modals
    const modals = {
        login: document.getElementById('login-modal'),
        register: document.getElementById('register-modal'),
        addNote: document.getElementById('add-note-modal'),
        changePassword: document.getElementById('change-password-modal'),
        eventDetail: document.getElementById('event-detail-modal')
    };
    
    // Forms
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const noteForm = document.getElementById('note-form');
    const profileForm = document.getElementById('profile-form');
    const changePasswordForm = document.getElementById('change-password-form');
    const eventForm = document.getElementById('event-form');
    const adminAnnouncementForm = document.getElementById('admin-announcement-form');
    const adminEventForm = document.getElementById('admin-event-form');
    
    // Current user state
    let currentUser = null;
    let isAdmin = false;
    let currentPage = 'dashboard';
    let currentCalendarDate = new Date();
    let editHistory = {
        announcements: {},
        notes: {},
        events: {}
    };
    let selectedItems = new Set();
    let autoSaveTimer = null;
    let progressChartInstance = null;

// å…¨å±€å›¾è¡¨ç®¡ç†
// ==================== å¢å¼ºç‰ˆ ChartManager ====================
const chartManager = {
    // çŠ¶æ€ç®¡ç†
    instance: null,
    isInitialized: false,
    isCreating: false,
    isDestroying: false,
    
    // åˆå§‹åŒ–ï¼ˆå¸¦ä¸‰é‡ä¿æŠ¤ï¼‰
        async initialize() {
        console.log('ChartManager.initialize() called');
        
        // ä¿æŠ¤1ï¼šæ­£åœ¨åˆ›å»ºä¸­ï¼Œè·³è¿‡
        if (this.isCreating) {
            console.warn('Chart is already being created, skipping...');
            return false;
        }
        
        // ä¿æŠ¤2ï¼šå·²ç»åˆå§‹åŒ–ä¸”å®ä¾‹å­˜åœ¨ï¼Œè·³è¿‡
        if (this.isInitialized && this.instance) {
            console.log('Chart already initialized, returning existing instance');
            return true;
        }
        
        // ========== å…³é”®ä¿®å¤ï¼šç¡®ä¿å®¹å™¨å¯è§ ==========
        const container = document.getElementById('progress-chart-container');
        if (container) {
            if (container.style.display === 'none' || window.getComputedStyle(container).display === 'none') {
                console.warn('Container was hidden, forcing display');
                container.style.display = 'block';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                
                // ç­‰å¾…æµè§ˆå™¨é‡æ–°æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // ç¡®ä¿å®¹å™¨æœ‰å°ºå¯¸
            if (container.clientWidth === 0 || container.clientHeight === 0) {
                container.style.width = '100%';
                container.style.height = '350px';
                container.style.minHeight = '350px';
            }
        }
        // ========== å…³é”®ä¿®å¤ç»“æŸ ==========
        
        // ä¿æŠ¤3ï¼šä½¿ç”¨ Chart.getChart() æ£€æŸ¥æ˜¯å¦å·²æœ‰å›¾è¡¨
        const canvas = document.getElementById('progress-chart');
        if (canvas && Chart) {
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                console.log('Found existing chart via Chart.getChart(), reusing');
                this.instance = existingChart;
                this.isInitialized = true;
                return true;
            }
        }
        
        this.isCreating = true;
        
        try {
            console.log('Creating new chart...');
            
            // æ‰§è¡Œåˆ›å»º
            await this.createChart();
            this.isInitialized = true;
            console.log('Chart initialization complete');
            
            return true;
        } catch (error) {
            console.error('Chart initialization failed:', error);
            this.showError();
            return false;
        } finally {
            this.isCreating = false;
        }
    },
    
    // åˆ›å»ºå›¾è¡¨å®ä¾‹ï¼ˆå¸¦åŒé‡æ£€æŸ¥ï¼‰
       async createChart() {
        console.log('ChartManager.createChart() called');
        
        try {
            const container = document.getElementById('progress-chart-container');
            const canvas = document.getElementById('progress-chart');
            
            if (!container || !canvas) {
                console.warn('Chart elements not found');
                return false;
            }
            
            // ========== åŒé‡æ£€æŸ¥å®¹å™¨å¯è§æ€§ ==========
            const computedStyle = window.getComputedStyle(container);
            if (computedStyle.display === 'none') {
                console.error('Container is still hidden! Forcing display...');
                container.style.display = 'block';
                container.style.visibility = 'visible';
                
                // ç­‰å¾…é‡æ–°æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // ç¡®ä¿å®¹å™¨æœ‰å°ºå¯¸
            if (container.clientWidth === 0) {
                container.style.width = '100%';
            }
            if (container.clientHeight === 0) {
                container.style.height = '350px';
                container.style.minHeight = '350px';
            }
            // ========================================
            
            // æ£€æŸ¥å·²æœ‰å›¾è¡¨
            if (Chart) {
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    console.log('Chart already exists, reusing');
                    this.instance = existingChart;
                    
                    // æ›´æ–°æ•°æ®
                    const chartData = await this.getChartData();
                    existingChart.data = chartData;
                    existingChart.update();
                    
                    return true;
                }
            }
            
            // æ¸…ç†æ—§å®ä¾‹
            if (this.instance) {
                try {
                    this.instance.destroy();
                } catch (e) {}
                this.instance = null;
            }
            
            // è®¾ç½®Canvaså°ºå¯¸
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            console.log('Canvas dimensions:', {
                width: canvas.width,
                height: canvas.height,
                containerWidth,
                containerHeight
            });
            
            // è·å–æ•°æ®å¹¶åˆ›å»ºå›¾è¡¨
            this.showLoading();
            const chartData = await this.getChartData();
            const ctx = canvas.getContext('2d');
            
            this.instance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            this.hideLoading();
            console.log('Chart created successfully');
            return true;
            
        } catch (error) {
            console.error('Chart creation error:', error);
            this.showError();
            return false;
        }
    },
    
    // è·å–å›¾è¡¨æ•°æ®
    async getChartData() {
        try {
            console.log('Fetching chart data...');
            
            const tasks = await taskTracking.getAllTasks();
            const students = await db.collection('users').get();
            
            if (!tasks || tasks.length === 0) {
                console.warn('No tasks found for chart');
                return this.getEmptyChartData();
            }
            
            const taskNames = [];
            const completionCounts = [];
            
            for (const task of tasks) {
                const completions = await db.collection('taskProgress')
                    .where('taskId', '==', task.id)
                    .where('completed', '==', true)
                    .get();
                
                taskNames.push(task.name);
                completionCounts.push(completions.size);
            }
            
            // å¦‚æœæ‰€æœ‰æ•°æ®éƒ½æ˜¯0ï¼Œæ˜¾ç¤ºå ä½ä¿¡æ¯
            const totalCompletions = completionCounts.reduce((a, b) => a + b, 0);
            if (totalCompletions === 0) {
                console.log('No completion data yet, showing empty chart');
                return this.getEmptyChartData();
            }
            
            return {
                labels: taskNames,
                datasets: [{
                    label: 'Number of Completions',
                    data: completionCounts,
                    backgroundColor: 'rgba(67, 97, 238, 0.6)',
                    borderColor: 'rgba(67, 97, 238, 1)',
                    borderWidth: 2,
                    borderRadius: 5,
                    hoverBackgroundColor: 'rgba(67, 97, 238, 0.8)'
                }]
            };
            
        } catch (error) {
            console.error('Error getting chart data:', error);
            return this.getEmptyChartData();
        }
    },
    
    // ç©ºå›¾è¡¨æ•°æ®
    getEmptyChartData() {
        return {
            labels: ['No Data Available'],
            datasets: [{
                label: 'No completions yet',
                data: [1],
                backgroundColor: 'rgba(200, 200, 200, 0.3)',
                borderColor: 'rgba(200, 200, 200, 0.5)',
                borderWidth: 1
            }]
        };
    },
    
    // æ˜¾ç¤ºå›¾è¡¨
    show() {
        console.log('ChartManager.show() called');
        
        if (!this.isInitialized) {
            console.log('Chart not initialized, initializing first...');
            this.initialize();
            return;
        }
        
        const container = document.getElementById('progress-chart-container');
        if (container) {
            container.style.display = 'block';
            console.log('Chart container shown');
        }
        
        // ç¡®ä¿å›¾è¡¨å¯è§æ—¶æ›´æ–°å°ºå¯¸
        setTimeout(() => this.refresh(), 100);
    },
    
    // éšè—å›¾è¡¨
    hide() {
        console.log('ChartManager.hide() called');
        
        const container = document.getElementById('progress-chart-container');
        if (container) {
            container.style.display = 'none';
            console.log('Chart container hidden');
        }
    },
    
    // åˆ·æ–°æ•°æ®
    async refresh() {
        console.log('ChartManager.refresh() called');
        
        if (!this.instance || !this.isInitialized) {
            console.log('Chart not ready for refresh, initializing...');
            await this.initialize();
            return;
        }
        
        try {
            this.showLoading();
            
            const chartData = await this.getChartData();
            
            // å®‰å…¨æ›´æ–°æ•°æ®
            if (this.instance && !this.instance.destroyed) {
                this.instance.data = chartData;
                this.instance.update('none'); // ä½¿ç”¨ 'none' é˜²æ­¢åŠ¨ç”»å†²çª
                console.log('Chart data refreshed');
            }
            
            this.hideLoading();
            
        } catch (error) {
            console.error('Error refreshing chart:', error);
            this.showError();
        }
    },
    
    // å®‰å…¨é”€æ¯
    destroy() {
        console.log('ChartManager.destroy() called');
        
        if (this.isDestroying) {
            console.warn('Already destroying chart, skipping...');
            return;
        }
        
        this.isDestroying = true;
        
        try {
            // ä½¿ç”¨ Chart.getChart() æ‰¾åˆ°æ‰€æœ‰å®ä¾‹
            const canvas = document.getElementById('progress-chart');
            if (canvas && Chart) {
                const chartInstance = Chart.getChart(canvas);
                if (chartInstance) {
                    console.log('Destroying chart via Chart.getChart()');
                    chartInstance.destroy();
                }
            }
            
            // é”€æ¯è‡ªå·±çš„å®ä¾‹å¼•ç”¨
            if (this.instance) {
                try {
                    this.instance.destroy();
                    console.log('Chart instance destroyed');
                } catch (e) {
                    console.error('Error destroying chart instance:', e);
                }
                this.instance = null;
            }
            
            this.isInitialized = false;
            console.log('ChartManager reset complete');
            
        } finally {
            this.isDestroying = false;
        }
    },
    
    // å®Œå…¨é‡ç½®
    reset() {
        console.log('ChartManager.reset() called');
        this.destroy();
        this.isInitialized = false;
        this.isCreating = false;
    },
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading() {
        const loading = document.getElementById('chart-loading');
        if (loading) {
            loading.style.display = 'flex';
        }
        const error = document.getElementById('chart-error');
        if (error) {
            error.style.display = 'none';
        }
    },
    
    // éšè—åŠ è½½çŠ¶æ€
    hideLoading() {
        const loading = document.getElementById('chart-loading');
        if (loading) {
            loading.style.display = 'none';
        }
    },
    
    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    showError() {
        const error = document.getElementById('chart-error');
        if (error) {
            error.style.display = 'flex';
        }
        const loading = document.getElementById('chart-loading');
        if (loading) {
            loading.style.display = 'none';
        }
    },
    
    // æ£€æŸ¥çŠ¶æ€
    getStatus: function() {
        return {
            isInitialized: this.isInitialized,
            isCreating: this.isCreating,
            isDestroying: this.isDestroying,
            instanceExists: !!this.instance,
            canvasExists: !!document.getElementById('progress-chart'),
            chartOnCanvas: Chart ? !!Chart.getChart(document.getElementById('progress-chart')) : false
        };
    },
    
    // ==== æ–°å¢ï¼šè°ƒè¯•å‡½æ•° ====
    debug: function() {
        const status = this.getStatus();
        console.log('=== ChartManager Debug Info ===');
        console.log('Status:', status);
        
        if (status.canvasExists) {
            const canvas = document.getElementById('progress-chart');
            console.log('Canvas dimensions:', {
                width: canvas.width,
                height: canvas.height,
                offsetWidth: canvas.offsetWidth,
                offsetHeight: canvas.offsetHeight,
                styleWidth: canvas.style.width,
                styleHeight: canvas.style.height
            });
        }
        
        if (Chart && status.chartOnCanvas) {
            console.log('Chart.js instances count:', Object.keys(Chart.instances || {}).length);
        }
        
        return status;
    }
};
       
       function initImageLazyLoading() {
    const lazyImages = document.querySelectorAll('img.lazy-load');
    
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-load');
                    }
                    observer.unobserve(img);
                }
            });
        });
        
        lazyImages.forEach(img => imageObserver.observe(img));
    } else {
        // å›é€€æ–¹æ¡ˆï¼šç›´æ¥åŠ è½½æ‰€æœ‰å›¾ç‰‡
        lazyImages.forEach(img => {
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.classList.remove('lazy-load');
            }
        });
    }
}
       
    // Initialize the application
   document.addEventListener('DOMContentLoaded', function() {
    // ä¿®å¤ç™»å½•æŒ‰é’®ç‚¹å‡»
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Login button clicked'); // è°ƒè¯•ä¿¡æ¯
            openModal('login-modal');
        });
    }
    
    // ä¿®å¤æ³¨å†ŒæŒ‰é’®ç‚¹å‡»
    const registerBtn = document.getElementById('register-btn');
    if (registerBtn) {
        registerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Register button clicked'); // è°ƒè¯•ä¿¡æ¯
            openModal('register-modal');
        });
    }
    
    // ç¡®ä¿ addNoteBtn æ­£ç¡®ç»‘å®šäº‹ä»¶
    const addNoteBtn = document.getElementById('add-note-btn');
    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser) {
                openModal('add-note-modal');
            } else {
                showAlert('Please log in first to add a post.', 'error');
                openModal('login-modal');
            }
        });
    }

       

    // ä¿®å¤ç©ºå¢™çš„æ·»åŠ æŒ‰é’®
    document.addEventListener('click', function(e) {
        if (e.target.closest('#empty-wall-add-btn') || e.target.closest('#wall-add-btn')) {
            if (currentUser) {
                openModal('add-note-modal');
            } else {
                showAlert('Please log in first to add a post.', 'error');
                openModal('login-modal');
            }
        }
    });

    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ®‹ç•™å›¾è¡¨
    cleanupCharts();
    
    // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
    setTimeout(() => {
        if (window.taskTracking) {
            taskTracking.initialize();
        }
        initTaskTracking();
        
    }, 2000);
       
        setTimeout(() => {
        initImageLazyLoading();
    }, 500);
    // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
       initExchangeLinks();
    initEventListeners();
    initAuthStateListener();
    initTabs();
    generateCalendar(new Date());
    loadDashboardData();
    
    // æ–°å¢ï¼šåˆå§‹åŒ–å€’è®¡æ—¶é¡µé¢
    initCountdownPage();
    
    // æ–°å¢ï¼šåˆå§‹åŒ–Firestoreé»˜è®¤æ•°æ®
    initializeFirestore();
});

       let exchangeLinks = [
    {
        id: 'link-1',
        title: 'School Culture Exchange 2026',
        url: 'https://padlet.com/jb220202/fyhs-kshs-exchange-online-2026-school-culture-22-1-26-canbxnwed0c3x8d2',
        description: 'Padlet for sharing and discussing school culture between FYHS and KSHS',
        createdAt: new Date('2026-01-05'),
        createdBy: 'Admin'
    },
    {
        id: 'link-2',
        title: 'Self Introduction Exchange',
        url: 'https://padlet.com/jb220202/self-introduction-fyhs-kshs-exchange-online-202-m6gvpozj5zaesseb',
        description: 'Students introduce themselves to their exchange partners',
        createdAt: new Date('2026-01-05'),
        createdBy: 'Admin'
    }
];

// åˆå§‹åŒ–Exchange LinksåŠŸèƒ½
function initExchangeLinks() {
    // åŠ è½½ç°æœ‰é“¾æ¥
    renderExchangeLinks();
    
    // è®¾ç½®ç®¡ç†å‘˜æ§åˆ¶æŒ‰é’®
    const manageLinksBtn = document.getElementById('manage-links-btn');
    if (manageLinksBtn) {
        manageLinksBtn.addEventListener('click', toggleLinksManagement);
    }
    
    // è®¾ç½®æ·»åŠ é“¾æ¥è¡¨å•
    const addLinkForm = document.getElementById('add-link-form');
    if (addLinkForm) {
        addLinkForm.addEventListener('submit', handleAddLink);
    }
    
    // è®¾ç½®ç¼–è¾‘é“¾æ¥è¡¨å•
    const editLinkForm = document.getElementById('edit-link-form');
    if (editLinkForm) {
        editLinkForm.addEventListener('submit', handleEditLink);
    }
}

// æ¸²æŸ“Exchange Links
function renderExchangeLinks() {
    const linksDisplay = document.getElementById('exchange-links-display');
    if (!linksDisplay) return;
    
    if (exchangeLinks.length === 0) {
        linksDisplay.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-link"></i>
                <p>No exchange links available yet</p>
                ${window.isAdmin ? '<p>Click "Manage Links" to add new links</p>' : ''}
            </div>
        `;
        return;
    }
    
    let html = '';
    exchangeLinks.forEach(link => {
        html += `
            <div class="link-item" data-link-id="${link.id}">
                <div class="link-header">
                    <h4>${link.title}</h4>
                    ${link.description ? `<p>${link.description}</p>` : ''}
                    ${window.isAdmin ? `
                        <div class="link-actions" style="margin-top: 10px;">
                            <button class="btn btn-small btn-outline edit-link-btn" data-link-id="${link.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-small btn-outline delete-link-btn" data-link-id="${link.id}" style="color: var(--danger); border-color: var(--danger); margin-left: 5px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    ` : ''}
                </div>
                <div class="link-content">
                    <div class="link-iframe-container">
                        <iframe 
                            src="${link.url}" 
                            class="link-iframe"
                            allow="camera;microphone;display-capture"
                            loading="lazy"
                            title="${link.title}">
                        </iframe>
                    </div>
                </div>
                <div class="link-footer">
                    <span>Added by: ${link.createdBy} | Date: ${formatDate(link.createdAt)}</span>
                </div>
            </div>
        `;
    });
    
    linksDisplay.innerHTML = html;
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    if (window.isAdmin) {
        document.querySelectorAll('.edit-link-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const linkId = this.getAttribute('data-link-id');
                editLink(linkId);
            });
        });
        
        document.querySelectorAll('.delete-link-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const linkId = this.getAttribute('data-link-id');
                deleteLink(linkId);
            });
        });
    }
}

// åˆ‡æ¢é“¾æ¥ç®¡ç†ç•Œé¢
function toggleLinksManagement() {
    const managementSection = document.getElementById('links-management');
    if (managementSection) {
        managementSection.classList.toggle('active');
        renderLinksManagement();
    } else {
        // åˆ›å»ºç®¡ç†ç•Œé¢
        createLinksManagementUI();
    }
}

// åˆ›å»ºé“¾æ¥ç®¡ç†UI
function createLinksManagementUI() {
    const linksContainer = document.querySelector('.exchange-links-container');
    
    const managementHTML = `
        <div id="links-management" class="links-management active">
            <h4>Manage Exchange Links</h4>
            
            <!-- æ·»åŠ æ–°é“¾æ¥è¡¨å• -->
            <div class="link-form-container">
                <h5>Add New Link</h5>
                <form id="add-link-form">
                    <div class="form-group">
                        <label for="new-link-title">Link Title *</label>
                        <input type="text" id="new-link-title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-link-url">Link URL *</label>
                        <input type="url" id="new-link-url" class="form-control" required placeholder="https://padlet.com/...">
                    </div>
                    <div class="form-group">
                        <label for="new-link-description">Description</label>
                        <textarea id="new-link-description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add Link</button>
                        <button type="button" class="btn btn-outline" id="cancel-add-link">Cancel</button>
                    </div>
                </form>
            </div>
            
            <!-- ç°æœ‰é“¾æ¥åˆ—è¡¨ -->
            <div class="existing-links-list">
                <h5>Existing Links</h5>
                <div id="links-list">
                    <!-- é“¾æ¥åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    `;
    
    linksContainer.insertAdjacentHTML('beforeend', managementHTML);
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('add-link-form').addEventListener('submit', handleAddLink);
    document.getElementById('cancel-add-link').addEventListener('click', toggleLinksManagement);
    
    // æ¸²æŸ“é“¾æ¥åˆ—è¡¨
    renderLinksList();
}

// æ¸²æŸ“é“¾æ¥åˆ—è¡¨ï¼ˆç”¨äºç®¡ç†ç•Œé¢ï¼‰
function renderLinksList() {
    const linksList = document.getElementById('links-list');
    if (!linksList) return;
    
    if (exchangeLinks.length === 0) {
        linksList.innerHTML = '<p>No links added yet</p>';
        return;
    }
    
    let html = '';
    exchangeLinks.forEach(link => {
        html += `
            <div class="link-list-item" data-link-id="${link.id}">
                <div class="link-list-item-info">
                    <h5>${link.title}</h5>
                    <p>${link.url.substring(0, 50)}...</p>
                    <small>Added: ${formatDate(link.createdAt)}</small>
                </div>
                <div class="link-list-item-actions">
                    <button class="btn btn-small edit-link-in-list" data-link-id="${link.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-small delete-link-in-list" data-link-id="${link.id}" style="color: var(--danger);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    linksList.innerHTML = html;
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.querySelectorAll('.edit-link-in-list').forEach(btn => {
        btn.addEventListener('click', function() {
            const linkId = this.getAttribute('data-link-id');
            editLink(linkId);
        });
    });
    
    document.querySelectorAll('.delete-link-in-list').forEach(btn => {
        btn.addEventListener('click', function() {
            const linkId = this.getAttribute('data-link-id');
            deleteLink(linkId);
        });
    });
}

// å¤„ç†æ·»åŠ é“¾æ¥
async function handleAddLink(e) {
    e.preventDefault();
    
    if (!window.isAdmin) {
        showAlert('Only administrators can add links', 'error');
        return;
    }
    
    const title = document.getElementById('new-link-title').value;
    const url = document.getElementById('new-link-url').value;
    const description = document.getElementById('new-link-description').value;
    
    if (!title || !url) {
        showAlert('Please fill in title and URL', 'error');
        return;
    }
    
    try {
        // éªŒè¯URLæ ¼å¼
        try {
            new URL(url);
        } catch (err) {
            showAlert('Please enter a valid URL', 'error');
            return;
        }
        
        const newLink = {
            id: 'link-' + Date.now(),
            title: title,
            url: url,
            description: description,
            createdAt: new Date(),
            createdBy: window.currentUser ? window.currentUser.displayName || window.currentUser.email : 'Admin'
        };
        
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä¿å­˜åˆ°æ•°æ®åº“
        // ç°åœ¨å…ˆæ·»åŠ åˆ°æœ¬åœ°æ•°ç»„
        exchangeLinks.push(newLink);
        
        // æ›´æ–°UI
        renderExchangeLinks();
        renderLinksList();
        
        // é‡ç½®è¡¨å•
        e.target.reset();
        
        showAlert('Link added successfully', 'success');
        
    } catch (error) {
        console.error('Error adding link:', error);
        showAlert(`Failed to add link: ${error.message}`, 'error');
    }
}

// ç¼–è¾‘é“¾æ¥
function editLink(linkId) {
    const link = exchangeLinks.find(l => l.id === linkId);
    if (!link) return;
    
    // åˆ›å»ºæˆ–æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
    if (!document.getElementById('edit-link-modal')) {
        createEditLinkModal();
    }
    
    // å¡«å……è¡¨å•æ•°æ®
    document.getElementById('edit-link-id').value = link.id;
    document.getElementById('edit-link-title').value = link.title;
    document.getElementById('edit-link-url').value = link.url;
    document.getElementById('edit-link-description').value = link.description || '';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    openModal('edit-link-modal');
}

// åˆ›å»ºç¼–è¾‘é“¾æ¥æ¨¡æ€æ¡†
function createEditLinkModal() {
    const modalHTML = `
        <div id="edit-link-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Exchange Link</h3>
                    <button class="modal-close" data-modal="edit-link-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-link-form">
                        <input type="hidden" id="edit-link-id">
                        <div class="form-group">
                            <label for="edit-link-title">Link Title</label>
                            <input type="text" id="edit-link-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-link-url">Link URL</label>
                            <input type="url" id="edit-link-url" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-link-description">Description</label>
                            <textarea id="edit-link-description" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-outline" data-modal="edit-link-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // è®¾ç½®å…³é—­æŒ‰é’®äº‹ä»¶
    document.querySelector('#edit-link-modal .modal-close').addEventListener('click', function() {
        closeModal('edit-link-modal');
    });
    
    // è®¾ç½®è¡¨å•æäº¤äº‹ä»¶
    document.getElementById('edit-link-form').addEventListener('submit', handleEditLink);
    
    // è®¾ç½®ç‚¹å‡»å¤–éƒ¨å…³é—­
    document.getElementById('edit-link-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal('edit-link-modal');
        }
    });
}

// å¤„ç†ç¼–è¾‘é“¾æ¥
async function handleEditLink(e) {
    e.preventDefault();
    
    if (!window.isAdmin) {
        showAlert('Only administrators can edit links', 'error');
        return;
    }
    
    const linkId = document.getElementById('edit-link-id').value;
    const title = document.getElementById('edit-link-title').value;
    const url = document.getElementById('edit-link-url').value;
    const description = document.getElementById('edit-link-description').value;
    
    if (!title || !url) {
        showAlert('Please fill in title and URL', 'error');
        return;
    }
    
    try {
        // éªŒè¯URLæ ¼å¼
        try {
            new URL(url);
        } catch (err) {
            showAlert('Please enter a valid URL', 'error');
            return;
        }
        
        // æŸ¥æ‰¾å¹¶æ›´æ–°é“¾æ¥
        const linkIndex = exchangeLinks.findIndex(l => l.id === linkId);
        if (linkIndex !== -1) {
            exchangeLinks[linkIndex] = {
                ...exchangeLinks[linkIndex],
                title: title,
                url: url,
                description: description,
                updatedAt: new Date()
            };
            
            // æ›´æ–°UI
            renderExchangeLinks();
            renderLinksList();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal('edit-link-modal');
            
            showAlert('Link updated successfully', 'success');
        } else {
            showAlert('Link not found', 'error');
        }
        
    } catch (error) {
        console.error('Error updating link:', error);
        showAlert(`Failed to update link: ${error.message}`, 'error');
    }
}

// åˆ é™¤é“¾æ¥
async function deleteLink(linkId) {
    if (!window.isAdmin) {
        showAlert('Only administrators can delete links', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this link? This action cannot be undone.')) {
        return;
    }
    
    try {
        // ä»æ•°ç»„ä¸­åˆ é™¤
        exchangeLinks = exchangeLinks.filter(l => l.id !== linkId);
        
        // æ›´æ–°UI
        renderExchangeLinks();
        
        // å¦‚æœç®¡ç†ç•Œé¢å·²æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°å®ƒ
        if (document.getElementById('links-list')) {
            renderLinksList();
        }
        
        showAlert('Link deleted successfully', 'success');
        
    } catch (error) {
        console.error('Error deleting link:', error);
        showAlert(`Failed to delete link: ${error.message}`, 'error');
    }
}
    
    // Initialize Firebase collections with default data
   async function initializeFirestore() {
    try {
        // Check if we need to create default data
        const announcementsSnapshot = await db.collection('announcements').limit(1).get();
        
        if (announcementsSnapshot.empty) {
            // Create default announcements
            const defaultAnnouncements = [
                {
                    title: 'Welcome to the Two-School Exchange Platform.',
                    content: 'Welcome students from Foon Yew High School, Malaysia, and Kaohsiung Municipal Kaohsiung Senior High School, Taiwan, to join our online exchange platform! This platform aims to promote cultural exchange and academic cooperation between the two schools.',
                    authorName: 'Platform Administrator',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                },
                {
                    title: 'Notice: The 1st Online Debating Competition',
                    content: 'Registration for the joint online debating competition organized by both schools will open next month, with the theme "The Impact of Technological Development on Traditional Culture." Interested students, please contact your respective school representatives by the end of this month.',
                    authorName: 'Platform Administrator',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                },
                {
                    title: 'Language Exchange Partner Matching Feature Now Live',
                    content: 'The new Language Exchange Partner Matching System is now live! Interested students, please go to the User Center to set your language learning preferences. The system will match you with a partner based on your interests and language proficiency.',
                    authorName: 'Platform Administrator',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                }
            ];
            
            // Add default announcements
            for (const announcement of defaultAnnouncements) {
                await db.collection('announcements').add(announcement);
            }
            
            // Create default events
            const defaultEvents = [
                {
                    title: 'Preliminary Round of the Online Debating Competition',
                    description: 'Preliminary Round of the Joint Debating Competition: "The Impact of Technological Development on Traditional Culture"',
                    date: new Date(new Date().setDate(new Date().getDate() + 7)),
                    time: '14:00',
                    type: 'competition',
                    school: 'both',
                    authorName: 'Platform Administrator',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                },
                {
                    title: 'Cultural Sharing Session: Festivals in Malaysia',
                    description: 'Sharing Session by Foon Yew High School Students: Traditional Festivals and Culture of Malaysia',
                    date: new Date(new Date().setDate(new Date().getDate() + 14)),
                    time: '16:00',
                    type: 'cultural',
                    school: 'fyhs',
                    authorName: 'Platform Administrator',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                },
                {
                    title: 'Language Exchange Partner Meetup',
                    description: 'Inaugural Online Meetup for Language Exchange Partners',
                    date: new Date(new Date().setDate(new Date().getDate() + 21)),
                    time: '15:00',
                    type: 'language',
                    school: 'both',
                    authorName: 'Platform Administrator',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                }
            ];
            
            // Add default events
            for (const event of defaultEvents) {
                await db.collection('events').add(event);
            }
            
            // Create default countdown settings
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30); // 30å¤©å
            
            const defaultCountdown = {
                eventName: 'The 1st Online Cultural Exchange Conference',
                eventDescription: 'The Inaugural Online Cultural Exchange between Foon Yew High School, Malaysia, and Kaohsiung Municipal Kaohsiung Senior High School, Taiwan, featuring academic sharing, cultural showcases, and interactive sessions.',
                eventDate: firebase.firestore.Timestamp.fromDate(defaultDate),
                eventTime: '14:00',
                eventPlatform: 'zoom',
                eventLink: '',
                participants: 200,
                themeColor: '#4361ee',
                views: 0,
                reminders: 0,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: 'system',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('countdown').doc('current').set(defaultCountdown);
            
            // Create default past events in history
            const pastEvents = [
                {
                    eventName: 'Platform Launch Ceremony',
                    eventDescription: 'Official Launch Ceremony of the Joint School Online Exchange Platform',
                    eventDate: firebase.firestore.Timestamp.fromDate(new Date(new Date().setDate(new Date().getDate() - 15))),
                    eventTime: '10:00',
                    eventPlatform: 'google-meet',
                    participants: 150,
                    themeColor: '#3a0ca3',
                    isActive: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                },
                {
                    eventName: 'Faculty Discussion Session',
                    eventDescription: 'Teaching Experience Sharing and Exchange among Faculty of Both Schools',
                    eventDate: firebase.firestore.Timestamp.fromDate(new Date(new Date().setDate(new Date().getDate() - 7))),
                    eventTime: '15:00',
                    eventPlatform: 'microsoft-teams',
                    participants: 80,
                    themeColor: '#7209b7',
                    isActive: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                }
            ];
            
            // Add to history
            for (const event of pastEvents) {
                await db.collection('countdownHistory').add(event);
            }
            
            console.log('Default data created successfully');
        }
        
        // ç¡®ä¿å€’è®¡æ—¶æ–‡æ¡£å­˜åœ¨ï¼ˆå³ä½¿å·²æœ‰å…¶ä»–æ•°æ®ï¼‰
        const countdownDoc = await db.collection('countdown').doc('current').get();
        if (!countdownDoc.exists) {
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            
            const defaultCountdown = {
                eventName: 'Online Cultural Exchange Conference',
                eventDescription: 'Online Cultural Exchange between Foon Yew High School, Malaysia and Kaohsiung Municipal Kaohsiung Senior High School, Taiwan',
                eventDate: firebase.firestore.Timestamp.fromDate(defaultDate),
                eventTime: '14:00',
                eventPlatform: 'zoom',
                eventLink: '',
                participants: 150,
                themeColor: '#4361ee',
                views: 0,
                reminders: 0,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: 'system',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('countdown').doc('current').set(defaultCountdown);
            console.log('Default countdown created');
        }
        
    } catch (error) {
        console.error('Error initializing Firestore:', error);
    }
}
    
    // Event Listeners
    function initEventListeners() {
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page') || this.getAttribute('href').substring(1);
                navigateTo(pageId);
            });
        });
        
        // Auth buttons
        loginBtn.addEventListener('click', () => openModal('login'));
        registerBtn.addEventListener('click', () => openModal('register'));
        logoutBtn.addEventListener('click', handleLogout);
        userInfoBtn.addEventListener('click', () => navigateTo('profile'));
        
        // Admin button
        adminBtn.addEventListener('click', () => navigateTo('admin'));

            const editNoteForm = document.getElementById('edit-note-form');
    if (editNoteForm) {
        editNoteForm.addEventListener('submit', handleEditNote);
    }
    
    // ç¡®ä¿åœ¨DOMåŠ è½½åç»‘å®š
    document.addEventListener('DOMContentLoaded', function() {
        // ç»‘å®šæ¨¡æ€æ¡†è¡¨å•æäº¤
        const editNoteForm = document.getElementById('edit-note-form');
        if (editNoteForm) {
            editNoteForm.addEventListener('submit', handleEditNote);
        }
        
        // ç»‘å®šç¼–è¾‘æŒ‰é’®ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        document.addEventListener('click', function(e) {
            if (e.target.closest('.edit-note')) {
                e.preventDefault();
                const noteId = e.target.closest('.edit-note').getAttribute('data-note-id');
                if (noteId) {
                    openEditNoteModalById(noteId);
                }
            }
        });
    });
        
        // Modal close buttons
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', function() {
                const modalId = this.getAttribute('data-modal');
                closeModal(modalId);
            });
        });
        
        // Switch between login and register modals
        document.getElementById('switch-to-register').addEventListener('click', function(e) {
            e.preventDefault();
            closeModal('login');
            openModal('register');
        });
        
        document.getElementById('switch-to-login').addEventListener('click', function(e) {
            e.preventDefault();
            closeModal('register');
            openModal('login');
        });
        
        // Close modals when clicking outside
        Object.values(modals).forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });
            // Edit announcement form submission
    const editAnnouncementForm = document.getElementById('edit-announcement-form');
    if (editAnnouncementForm) {
        editAnnouncementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const announcementId = document.getElementById('edit-announcement-id').value;
            const title = document.getElementById('edit-announcement-title').value;
            const content = document.getElementById('edit-announcement-content').value;
            
            if (!title || !content) {
                showAlert('Please fill in title and content', 'error');
                return;
            }
            
            try {
                if (window.demoAnnouncements) {
                    // Update demo data
                    const index = parseInt(announcementId.replace('announcement-', ''));
                    if (window.demoAnnouncements[index]) {
                        window.demoAnnouncements[index].title = title;
                        window.demoAnnouncements[index].content = content;
                        window.demoAnnouncements[index].updatedAt = new Date();
                        
                        // Reload announcements
                        loadAnnouncements();
                        
                        // Close modal
                        closeModal('edit-announcement-modal');
                        
                        showAlert('Announcement updated successfully (Demo mode)', 'success');
                    }
                } else if (db) {
                    // Update in Firebase
                    await db.collection('announcements').doc(announcementId).update({
                        title: title,
                        content: content,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Reload announcements
                    loadAnnouncements();
                    
                    // Close modal
                    closeModal('edit-announcement-modal');
                    
                    showAlert('Announcement updated successfully', 'success');
                }
            } catch (error) {
                console.error('Error updating announcement:', error);
                showAlert(`Error updating announcement: ${error.message}`, 'error');
            }
        });
    }
        // Form submissions
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        noteForm.addEventListener('submit', handleAddNote);
        profileForm.addEventListener('submit', handleUpdateProfile);
        changePasswordForm.addEventListener('submit', handleChangePassword);
        eventForm.addEventListener('submit', handleAddEvent);
        adminAnnouncementForm.addEventListener('submit', handleAdminAddAnnouncement);
        adminEventForm.addEventListener('submit', handleAdminAddEvent);
        
        // Google login buttons
        document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
        document.getElementById('google-register-btn').addEventListener('click', handleGoogleLogin);
        
        // Add note button
        addNoteBtn.addEventListener('click', () => openModal('add-note'));
        
        // Note color selection
        document.querySelectorAll('.note-color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.note-color-option').forEach(opt => {
                    opt.style.borderColor = '#ccc';
                });
                this.style.borderColor = '#2c5aa0';
                document.getElementById('note-color-value').value = this.getAttribute('data-color');
            });
        });
        
        // File uploads
        document.getElementById('avatar-upload').addEventListener('click', function() {
            document.getElementById('edit-avatar').click();
        });
        
        document.getElementById('edit-avatar').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('avatar-preview-img').src = event.target.result;
                    document.getElementById('avatar-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('note-image-upload').addEventListener('click', function() {
            document.getElementById('note-image').click();
        });
        
        document.getElementById('note-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('image-preview-img').src = event.target.result;
                    document.getElementById('image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('remove-image').addEventListener('click', function() {
            document.getElementById('note-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
        });
        
        // Calendar navigation
        document.getElementById('prev-month').addEventListener('click', function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            generateCalendar(currentCalendarDate);
            loadCalendarEvents();
        });
        
        document.getElementById('next-month').addEventListener('click', function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            generateCalendar(currentCalendarDate);
            loadCalendarEvents();
        });
        
        document.getElementById('today-btn').addEventListener('click', function() {
            currentCalendarDate = new Date();
            generateCalendar(currentCalendarDate);
            loadCalendarEvents();
        });
        
        // Event form cancel button
        document.getElementById('cancel-event').addEventListener('click', function() {
            document.querySelector('[data-tab="view-calendar"]').click();
            eventForm.reset();
        });
        
        // Change password button
        document.getElementById('change-password-btn').addEventListener('click', function() {
            openModal('changePassword');
        });
        
        // Delete account button
        document.getElementById('delete-account-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone!')) {
                deleteAccount();
            }
        });
        
        // Admin settings
        document.getElementById('save-settings').addEventListener('click', saveAdminSettings);
        
        // Feature buttons on dashboard
        document.getElementById('academic-btn').addEventListener('click', function() {
            navigateTo('calendar');
            showAlert('Academic seminars can be found in the calendar.', 'info');
        });
        
        document.getElementById('competition-btn').addEventListener('click', function() {
            navigateTo('calendar');
            showAlert('Joint competition can be found in the calendar.', 'info');
        });
        
        document.getElementById('language-btn').addEventListener('click', function() {
            navigateTo('wall');
            showAlert('Language exchange partners can be found on the Communication Wall.', 'info');
        });
        
        // Footer links
        document.getElementById('about-link').addEventListener('click', function(e) {
            e.preventDefault();
            showAlert('About Us: This is an online platform dedicated to promoting cultural exchange between the two schools.', 'info');
        });
        
        document.getElementById('privacy-link').addEventListener('click', function(e) {
            e.preventDefault();
            showAlert('Privacy Policy: We are committed to protecting user privacy and data security.', 'info');
        });
        
        document.getElementById('terms-link').addEventListener('click', function(e) {
            e.preventDefault();
            showAlert('Terms of Use: Please abide by the platform rules and interact respectfully.', 'info');
        });
        
        document.getElementById('contact-link').addEventListener('click', function(e) {
            e.preventDefault();
            showAlert('Contact Us: If you have any questions, please email us at tanjunyuanfoonyew@gmail.com', 'info');
        });
        
        // Dashboard buttons that navigate to other pages
        document.querySelectorAll('[data-page]').forEach(btn => {
            if (btn.tagName === 'BUTTON' && btn.getAttribute('data-page')) {
                btn.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    navigateTo(page);
                });
            }
        });

            document.getElementById('edit-announcement-form').addEventListener('submit', handleEditAnnouncement);
    document.getElementById('edit-note-form').addEventListener('submit', handleEditNote);
    document.getElementById('edit-event-form').addEventListener('submit', handleEditEvent);
    
    // æ’¤é”€æŒ‰é’®
    document.getElementById('undo-announcement-changes').addEventListener('click', () => undoChanges('announcement'));
    document.getElementById('undo-note-changes').addEventListener('click', () => undoChanges('note'));
    document.getElementById('undo-event-changes').addEventListener('click', () => undoChanges('event'));
    
    // ç¼–è¾‘é¢œè‰²é€‰æ‹©
    document.querySelectorAll('.note-color-option.edit').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.note-color-option.edit').forEach(opt => {
                opt.style.borderColor = '#ccc';
            });
            this.style.borderColor = '#2c5aa0';
            document.getElementById('edit-note-color').value = this.getAttribute('data-color');
        });
    });
    
    // ç¼–è¾‘å›¾ç‰‡ä¸Šä¼ 
    document.getElementById('edit-note-image-upload').addEventListener('click', function() {
        document.getElementById('edit-note-image').click();
    });
    
    document.getElementById('edit-note-image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('edit-image-preview-img').src = event.target.result;
                document.getElementById('edit-image-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    document.getElementById('remove-edit-image').addEventListener('click', function() {
        document.getElementById('edit-note-image').value = '';
        document.getElementById('edit-image-preview').style.display = 'none';
    });
    
    document.getElementById('remove-existing-image').addEventListener('click', function() {
        document.getElementById('current-note-image').innerHTML = '<p style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> å›¾ç‰‡å°†åœ¨ä¿å­˜ååˆ é™¤</p>';
    });
    
    // æ‰¹é‡æ“ä½œ
    document.getElementById('batch-delete').addEventListener('click', handleBatchDelete);
    document.getElementById('clear-selection').addEventListener('click', clearSelection);
    document.getElementById('select-all-items').addEventListener('change', toggleSelectAll);
    
    // ç¡®è®¤åˆ é™¤
    document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // è‡ªåŠ¨ä¿å­˜
    document.getElementById('edit-announcement-content').addEventListener('input', () => scheduleAutoSave('announcement'));
    document.getElementById('edit-note-content').addEventListener('input', () => scheduleAutoSave('note'));
    document.getElementById('edit-event-description').addEventListener('input', () => scheduleAutoSave('event'));
    
    // æ˜¾ç¤ºå¿«æ·é”®æç¤º
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.key === 'Delete') {
            showShortcutHint();
        }
    });

        // ä¿®å¤ï¼šæ·»åŠ äº‹ä»¶å§”æ‰˜æ¥å¤„ç†åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®
document.addEventListener('click', function(e) {
    // å¤„ç†"æš‚æ— å…¬å‘Š"çš„æ·»åŠ æŒ‰é’®
    if (e.target.closest('#empty-announcement-add-btn') || 
        e.target.closest('#announcement-empty-add-btn') ||
        (e.target.textContent && e.target.textContent.includes('Add the first announcement'))) {
        e.preventDefault();
        if (currentUser && isAdmin) {
            // å¯¼èˆªåˆ°ç®¡ç†å‘˜é¢æ¿å‘å¸ƒå…¬å‘Š
            navigateTo('admin');
            showAlert('Please post announcements in the Admin Panel.', 'info');
        } else if (currentUser) {
            showAlert('Only administrators can post announcements.', 'error');
        } else {
            showAlert('Please log in first.', 'error');
            openModal('login');
        }
    }
    
    // å¤„ç†äº¤æµå¢™çš„æ·»åŠ æŒ‰é’®
    if (e.target.closest('#empty-wall-add-btn') || 
        e.target.closest('#wall-add-btn') ||
        (e.target.textContent && e.target.textContent.includes('Add the first post'))) {
        e.preventDefault();
        if (currentUser) {
            openModal('add-note-modal');
        } else {
            showAlert('Please log in first to add a post.', 'error');
            openModal('login');
        }
    }
});
        initLogoManagement();
    }

       // ä¿®å¤ï¼šé€šç”¨æ¨¡æ€æ¡†å…³é—­å¤„ç†
function setupModalCloseHandlers() {
    // 1. å¤„ç† modal-close æŒ‰é’®
    document.addEventListener('click', function(e) {
        const closeBtn = e.target.closest('.modal-close');
        if (closeBtn) {
            e.preventDefault();
            e.stopPropagation();
            const modalId = closeBtn.getAttribute('data-modal');
            closeModal(modalId);
            return;
        }
        
        // 2. å¤„ç†å¸¦æœ‰ data-modal å±æ€§çš„å–æ¶ˆæŒ‰é’®
        if (e.target.matches('[data-modal]') && e.target.textContent.includes('Cancel')) {
            e.preventDefault();
            e.stopPropagation();
            const modalId = e.target.getAttribute('data-modal');
            closeModal(modalId);
            return;
        }
        
        // 3. å¤„ç†æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
        if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
            e.preventDefault();
            closeModal(e.target.id);
            return;
        }
    });
}

// åœ¨ initEventListeners ä¸­è°ƒç”¨
setupModalCloseHandlers();

       function openEditAnnouncementModal(announcementId, announcementData) {
        // ç¡®ä¿æ•°æ®æ˜¯å¯¹è±¡
        if (typeof announcementData === 'string') {
            try {
                announcementData = JSON.parse(announcementData);
            } catch (e) {
                console.error('Error parsing announcement data:', e);
                announcementData = {};
            }
        }
        
        // å¡«å……è¡¨å•
        document.getElementById('edit-announcement-id').value = announcementId;
        document.getElementById('edit-announcement-title').value = announcementData.title || '';
        document.getElementById('edit-announcement-content').value = announcementData.content || '';
        
        // ä¿å­˜åˆå§‹çŠ¶æ€
        saveEditState('announcement', announcementId, {
            title: announcementData.title || '',
            content: announcementData.content || ''
        });
        
        // æ˜¾ç¤ºç¼–è¾‘æ—¥å¿—
        displayEditLog('announcement', announcementId);
        
        // æ‰“å¼€æ¨¡æ€æ¡†
        openModal('edit-announcement-modal');
    }

       // === å›¾ç‰‡ä¸Šä¼ å‡½æ•° ===
// === å›¾ç‰‡ä¸Šä¼ å‡½æ•° ===
async function uploadToCloudinary(file, folder = 'general') {
    try {
        console.log('å¼€å§‹ä¸Šä¼ åˆ°Cloudinary:', file.name, file.size);
        
        // éªŒè¯æ–‡ä»¶
        if (!file.type.match('image.*')) {
            throw new Error('åªæ”¯æŒå›¾ç‰‡æ–‡ä»¶');
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
            throw new Error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB');
        }
        
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        showAlert(`æ­£åœ¨ä¸Šä¼ å›¾ç‰‡: ${file.name}...`, 'info');
        
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'school_exchange'); // ç¡®ä¿é¢„è®¾åç§°æ­£ç¡®
        formData.append('cloud_name', 'dxtpm8o3j');
        
        // æ·»åŠ æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¯é€‰ï¼‰
        const userFolder = currentUser ? `users/${currentUser.uid}` : 'anonymous';
        formData.append('folder', `fyhs-kshs-exchange/${folder}/${userFolder}`);
        
        // æ·»åŠ æ—¶é—´æˆ³ä»¥é˜²æ­¢ç¼“å­˜é—®é¢˜
        formData.append('timestamp', Date.now());
        
        console.log('ä¸Šä¼ å‚æ•°:', {
            cloud_name: 'dxtpm8o3j',
            upload_preset: 'school_exchange',
            folder: `fyhs-kshs-exchange/${folder}/${userFolder}`
        });
        
        // ä¸Šä¼ åˆ°Cloudinary
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/dxtpm8o3j/image/upload`,
            {
                method: 'POST',
                body: formData
            }
        );
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Cloudinaryé”™è¯¯å“åº”:', errorText);
            
            try {
                const errorJson = JSON.parse(errorText);
                throw new Error(`ä¸Šä¼ å¤±è´¥: ${errorJson.error?.message || errorText}`);
            } catch (e) {
                throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`);
            }
        }
        
        const result = await response.json();
        console.log('Cloudinaryä¸Šä¼ æˆåŠŸ:', result);
        
        // æ„å»ºå¤šç§å°ºå¯¸çš„å›¾ç‰‡URL
        const baseUrl = result.secure_url;
        const publicId = result.public_id;
        
        // ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå®½åº¦300pxï¼‰
        const thumbnailUrl = baseUrl.replace('/upload/', '/upload/w_300,c_scale/');
        
        // ç”Ÿæˆä¸­ç­‰å°ºå¯¸å›¾ç‰‡ï¼ˆå®½åº¦800pxï¼‰
        const mediumUrl = baseUrl.replace('/upload/', '/upload/w_800,c_scale/');
        
        return {
            url: baseUrl,
            thumbnail: thumbnailUrl,
            medium: mediumUrl,
            publicId: publicId,
            width: result.width,
            height: result.height,
            format: result.format,
            size: result.bytes
        };
        
    } catch (error) {
        console.error('Cloudinaryä¸Šä¼ é”™è¯¯:', error);
        throw error;
    }
}

       // === å¤‡é€‰ä¸Šä¼ å‡½æ•°ï¼šä½¿ç”¨Firebase Storage ===
async function uploadToFirebaseStorage(file, folder = 'general') {
    try {
        console.log('ä¸Šä¼ åˆ°Firebase Storage:', file.name);
        
        // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name.replace(/\s+/g, '_')}`;
        
        // åˆ›å»ºå­˜å‚¨å¼•ç”¨
        const storageRef = storage.ref();
        const filePath = `${folder}/${currentUser.uid}/${fileName}`;
        const fileRef = storageRef.child(filePath);
        
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        showAlert(`æ­£åœ¨ä¸Šä¼ å›¾ç‰‡: ${file.name}...`, 'info');
        
        // ä¸Šä¼ æ–‡ä»¶
        const uploadTask = fileRef.put(file);
        
        // ç­‰å¾…ä¸Šä¼ å®Œæˆ
        const snapshot = await uploadTask;
        
        // è·å–ä¸‹è½½URL
        const downloadURL = await snapshot.ref.getDownloadURL();
        
        console.log('Firebaseä¸Šä¼ æˆåŠŸ:', downloadURL);
        
        return {
            url: downloadURL,
            thumbnail: downloadURL, // Firebaseæ²¡æœ‰å†…ç½®ç¼©ç•¥å›¾ï¼Œå¯ä»¥ç¨åå¤„ç†
            medium: downloadURL,
            path: filePath,
            size: file.size,
            type: file.type
        };
        
    } catch (error) {
        console.error('Firebase Storageä¸Šä¼ é”™è¯¯:', error);
        throw error;
    }
}
// === å‹ç¼©å›¾ç‰‡å‡½æ•° ===
async function compressImage(file, maxWidth = 1200, quality = 0.8) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // è®¡ç®—æ–°å°ºå¯¸
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(
                    (blob) => resolve(new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    })),
                    'image/jpeg',
                    quality
                );
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// æ‰“å¼€ç¼–è¾‘è´´æ–‡æ¨¡æ€æ¡†
function openEditNoteModal(noteId, noteData) {
    console.log('Opening edit modal for note:', noteId);
    
    // ç¡®ä¿æ¨¡æ€æ¡†å…ƒç´ å­˜åœ¨
    const modal = document.getElementById('edit-note-modal');
    if (!modal) {
        console.error('Edit note modal not found');
        return;
    }
    
    // å¡«å……è¡¨å•
    document.getElementById('edit-note-id').value = noteId;
    document.getElementById('edit-note-title').value = noteData.title || '';
    document.getElementById('edit-note-content').value = noteData.content || '';
    document.getElementById('edit-note-color').value = noteData.color || 'yellow';
    
    // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨
    const color = noteData.color || 'yellow';
    document.querySelectorAll('.note-color-option.edit').forEach(opt => {
        opt.style.borderColor = opt.getAttribute('data-color') === color ? '#2c5aa0' : '#ccc';
    });
    
    // æ˜¾ç¤ºå½“å‰å›¾ç‰‡
    const currentImageDiv = document.getElementById('current-note-image');
    if (noteData.imageUrl) {
        currentImageDiv.innerHTML = `
            <img src="${noteData.imageUrl}" alt="Current Image" style="max-width: 200px; border-radius: 5px;">
        `;
        document.getElementById('image-actions').style.display = 'block';
    } else {
        currentImageDiv.innerHTML = '<p>No image</p>';
        document.getElementById('image-actions').style.display = 'none';
    }
    
    // æ¸…é™¤æ–‡ä»¶è¾“å…¥
    const fileInput = document.getElementById('edit-note-image');
    if (fileInput) fileInput.value = '';
    
    // æ¸…é™¤å›¾ç‰‡é¢„è§ˆ
    const imagePreview = document.getElementById('edit-image-preview');
    if (imagePreview) imagePreview.style.display = 'none';
    
    // æ‰“å¼€æ¨¡æ€æ¡†
    openModal('edit-note-modal');
}
// æ‰“å¼€ç¼–è¾‘æ´»åŠ¨æ¨¡æ€æ¡†
function openEditEventModal(eventId, eventData) {
    document.getElementById('edit-event-id').value = eventId;
    document.getElementById('edit-event-title').value = eventData.title;
    document.getElementById('edit-event-description').value = eventData.description || '';
    
    const eventDate = eventData.date?.toDate();
    if (eventDate) {
        document.getElementById('edit-event-date').value = eventDate.toISOString().split('T')[0];
    }
    
    document.getElementById('edit-event-time').value = eventData.time || '';
    document.getElementById('edit-event-type').value = eventData.type || 'other';
    document.getElementById('edit-event-school').value = eventData.school || 'both';
    
    // ä¿å­˜åˆå§‹çŠ¶æ€
    saveEditState('event', eventId, {
        title: eventData.title,
        description: eventData.description || '',
        date: eventDate,
        time: eventData.time || '',
        type: eventData.type || 'other',
        school: eventData.school || 'both'
    });
    
    // æ˜¾ç¤ºç¼–è¾‘æ—¥å¿—
    displayEditLog('event', eventId);
    
    openModal('edit-event-modal');
}

// å¤„ç†ç¼–è¾‘å…¬å‘Š
async function handleEditAnnouncement(e) {
        e.preventDefault();
        
        const announcementId = document.getElementById('edit-announcement-id').value;
        const title = document.getElementById('edit-announcement-title').value;
        const content = document.getElementById('edit-announcement-content').value;
        
        if (!title.trim() || !content.trim()) {
            showAlert('Please fill in the title and content.', 'error');
            return;
        }
        
        try {
            await db.collection('announcements').doc(announcementId).update({
                title: title,
                content: content,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.uid
            });
            
            // è®°å½•ç¼–è¾‘å†å²
            await recordEditHistory('announcements', announcementId, {
                title: title,
                content: content,
                editedBy: currentUser.uid,
                editedAt: new Date()
            });
            
            closeModal('edit-announcement-modal');
            showAlert('The latest announcement is now live.', 'success');
            
            // åˆ·æ–°é¡µé¢æ•°æ®
            if (currentPage === 'announcements') {
                loadAnnouncements();
            }
            if (currentPage === 'dashboard') {
                loadDashboardData();
            }
            
        } catch (error) {
            console.error('Error updating announcement:', error);
            showAlert(`Failed to update announcement: ${error.message}`, 'error');
        }
    }

// å¤„ç†ç¼–è¾‘è´´æ–‡
async function handleEditNote(e) {
    e.preventDefault();
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
    
    console.log('Editing note...');
    
    const noteId = document.getElementById('edit-note-id').value;
    const title = document.getElementById('edit-note-title').value;
    const content = document.getElementById('edit-note-content').value;
    const color = document.getElementById('edit-note-color').value;
    const imageFile = document.getElementById('edit-note-image').files[0];
    const removeImage = document.getElementById('current-note-image').innerHTML.includes('Will be deleted after saving');
    
    // éªŒè¯è¾“å…¥
    if (!content.trim()) {
        showAlert('Please enter post content.', 'error');
        return;
    }
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
        
        let imageUrl = null;
        const updateData = {
            title: title || '',
            content: content,
            color: color,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.uid,
            lastEdited: new Date()
        };
        
        // å¤„ç†å›¾ç‰‡
        if (imageFile) {
            try {
                // å‹ç¼©å¹¶ä¸Šä¼ å›¾ç‰‡
                const compressedFile = await compressImage(imageFile);
                
                // å°è¯•ä½¿ç”¨Cloudinary
                let imageData;
                try {
                    imageData = await uploadToCloudinary(compressedFile, 'wall-posts');
                } catch (cloudinaryError) {
                    console.log('Cloudinary failed, using Firebase Storage:', cloudinaryError);
                    imageData = await uploadToFirebaseStorage(compressedFile, 'wall-posts');
                }
                
                updateData.imageUrl = imageData.url;
                updateData.imageData = {
                    url: imageData.url,
                    thumbnail: imageData.thumbnail || imageData.url,
                    publicId: imageData.publicId || imageData.path,
                    storageProvider: imageData.publicId ? 'cloudinary' : 'firebase'
                };
                
                // åˆ é™¤æ—§å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                const oldNote = await db.collection('wallPosts').doc(noteId).get();
                const oldData = oldNote.data();
                if (oldData.imageUrl) {
                    try {
                        if (oldData.imageData?.storageProvider === 'cloudinary') {
                            // Cloudinaryå›¾ç‰‡éœ€è¦Cloud Functionåˆ é™¤
                            console.log('Note: Cloudinary images should be deleted via Cloud Function');
                        } else {
                            const oldImageRef = storage.refFromURL(oldData.imageUrl);
                            await oldImageRef.delete();
                        }
                    } catch (deleteError) {
                        console.error('Error deleting old image:', deleteError);
                    }
                }
                
            } catch (uploadError) {
                console.error('Error uploading image:', uploadError);
                showAlert('Failed to upload image, saving text only.', 'warning');
            }
        } else if (removeImage) {
            // åˆ é™¤ç°æœ‰å›¾ç‰‡
            const oldNote = await db.collection('wallPosts').doc(noteId).get();
            const oldData = oldNote.data();
            if (oldData.imageUrl) {
                try {
                    if (oldData.imageData?.storageProvider === 'cloudinary') {
                        console.log('Note: Cloudinary images should be deleted via Cloud Function');
                    } else {
                        const oldImageRef = storage.refFromURL(oldData.imageUrl);
                        await oldImageRef.delete();
                    }
                } catch (deleteError) {
                    console.error('Error deleting image:', deleteError);
                }
            }
            updateData.imageUrl = null;
            updateData.imageData = null;
        } else {
            // ä¿ç•™ç°æœ‰å›¾ç‰‡
            const oldNote = await db.collection('wallPosts').doc(noteId).get();
            const oldData = oldNote.data();
            if (oldData.imageUrl) {
                updateData.imageUrl = oldData.imageUrl;
                updateData.imageData = oldData.imageData;
            }
        }
        
        // æ›´æ–°è´´æ–‡
        await db.collection('wallPosts').doc(noteId).update(updateData);
        
        console.log('Note updated successfully');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // å…³é—­æ¨¡æ€æ¡†
        closeModal('edit-note-modal');
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showAlert('Post updated successfully', 'success');
        
        // åˆ·æ–°é¡µé¢æ•°æ®ï¼ˆä½¿ç”¨å»¶è¿Ÿç¡®ä¿DOMç¨³å®šï¼‰
        setTimeout(() => {
            if (currentPage === 'wall') {
                loadWallPosts();
            }
        }, 500);
        
    } catch (error) {
        console.error('Error updating note:', error);
        showAlert(`Failed to update post: ${error.message}`, 'error');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = 'Save Changes';
            submitBtn.disabled = false;
        }
    }
}

// å¤„ç†ç¼–è¾‘æ´»åŠ¨
async function handleEditEvent(e) {
    e.preventDefault();
    
    const eventId = document.getElementById('edit-event-id').value;
    const title = document.getElementById('edit-event-title').value;
    const description = document.getElementById('edit-event-description').value;
    const date = document.getElementById('edit-event-date').value;
    const time = document.getElementById('edit-event-time').value;
    const type = document.getElementById('edit-event-type').value;
    const school = document.getElementById('edit-event-school').value;
    
    try {
        const eventDate = new Date(date);
        if (time) {
            const [hours, minutes] = time.split(':');
            eventDate.setHours(hours, minutes);
        }
        
        await db.collection('events').doc(eventId).update({
            title: title,
            description: description,
            date: eventDate,
            time: time || '',
            type: type,
            school: school,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.uid,
            lastEdited: new Date()
        });
        
        // è®°å½•ç¼–è¾‘å†å²
        await recordEditHistory('events', eventId, {
            title: title,
            description: description,
            date: eventDate,
            time: time || '',
            type: type,
            school: school,
            editedBy: currentUser.uid,
            editedAt: new Date()
        });
        
        closeModal('edit-event-modal');
        showAlert('Event updated successfully', 'success');
        
        // åˆ·æ–°é¡µé¢æ•°æ®
        if (currentPage === 'calendar') {
            loadCalendarEvents();
        }
        
    } catch (error) {
        console.error('Error updating event:', error);
        showAlert(`Failed to update event: ${error.message}`, 'error');
    }
}

// ä¿å­˜ç¼–è¾‘çŠ¶æ€ï¼ˆç”¨äºæ’¤é”€åŠŸèƒ½ï¼‰
function saveEditState(type, id, data) {
    if (!editHistory[type]) {
        editHistory[type] = {};
    }
    editHistory[type][id] = {
        timestamp: new Date(),
        data: {...data}
    };
}

// æ’¤é”€æ›´æ”¹
async function undoChanges(type) {
    let modalId, formId, idField;
    
    switch(type) {
        case 'announcement':
            modalId = 'edit-announcement-modal';
            formId = 'edit-announcement-form';
            idField = 'edit-announcement-id';
            break;
        case 'note':
            modalId = 'edit-note-modal';
            formId = 'edit-note-form';
            idField = 'edit-note-id';
            break;
        case 'event':
            modalId = 'edit-event-modal';
            formId = 'edit-event-form';
            idField = 'edit-event-id';
            break;
    }
    
    const id = document.getElementById(idField).value;
    const originalData = editHistory[type]?.[id]?.data;
    
    if (!originalData) {
        showAlert('No reversible changes found.', 'warning');
        return;
    }
    
    // æ¢å¤åŸå§‹æ•°æ®åˆ°è¡¨å•
    if (type === 'announcement') {
        document.getElementById('edit-announcement-title').value = originalData.title;
        document.getElementById('edit-announcement-content').value = originalData.content;
    } else if (type === 'note') {
        document.getElementById('edit-note-title').value = originalData.title;
        document.getElementById('edit-note-content').value = originalData.content;
        document.getElementById('edit-note-color').value = originalData.color;
        
        document.querySelectorAll('.note-color-option.edit').forEach(opt => {
            opt.style.borderColor = opt.getAttribute('data-color') === originalData.color ? '#2c5aa0' : '#ccc';
        });
        
        if (originalData.imageUrl) {
            document.getElementById('current-note-image').innerHTML = `
                <img src="${originalData.imageUrl}" alt="Current Image" style="max-width: 200px; border-radius: 5px;">
            `;
        }
    } else if (type === 'event') {
        document.getElementById('edit-event-title').value = originalData.title;
        document.getElementById('edit-event-description').value = originalData.description;
        
        if (originalData.date) {
            document.getElementById('edit-event-date').value = originalData.date.toISOString().split('T')[0];
        }
        
        document.getElementById('edit-event-time').value = originalData.time;
        document.getElementById('edit-event-type').value = originalData.type;
        document.getElementById('edit-event-school').value = originalData.school;
    }
    
    showAlert('æ›´æ”¹å·²æ’¤é”€', 'success');
}

// æ˜¾ç¤ºç¼–è¾‘æ—¥å¿—
// æ˜¾ç¤ºç¼–è¾‘æ—¥å¿—
async function displayEditLog(collection, docId) {
    const logContainer = document.getElementById(`${collection}-edit-log`);
    
    try {
        let historyCollection;
        
        // æ ¹æ®ç±»å‹ç¡®å®šæ­£ç¡®çš„é›†åˆåç§°
        switch(collection) {
            case 'announcement':
                historyCollection = 'announcementHistory';
                break;
            case 'note':
                historyCollection = 'noteHistory'; // ä½¿ç”¨æ‚¨åˆ›å»ºçš„é›†åˆ
                break;
            case 'event':
                historyCollection = 'eventHistory';
                break;
        }
        
        if (!historyCollection) {
            logContainer.innerHTML = '<p>No edit history available.</p>';
            return;
        }
        
        const historySnapshot = await db.collection(historyCollection)
            .where('docId', '==', docId)
            .orderBy('editedAt', 'desc')
            .limit(5)
            .get();
        
        if (historySnapshot.empty) {
            logContainer.innerHTML = '<p>No edit history available.</p>';
            return;
        }
        
        let html = '<strong>ç¼–è¾‘å†å²:</strong><ul style="margin-top: 10px; padding-left: 20px;">';
        
        historySnapshot.forEach(doc => {
            const history = doc.data();
            const date = history.editedAt?.toDate();
            html += `
                <li style="margin-bottom: 5px; font-size: 0.9rem;">
                    ${date ? formatDateTime(date) : 'Time Unknown'} 
                    - Edited by ${history.editedByName || 'User'}
                </li>
            `;
        });
        
        html += '</ul>';
        logContainer.innerHTML = html;
    } catch (error) {
        console.error('Error loading edit history:', error);
        logContainer.innerHTML = '<p>Failed to load edit history</p>';
    }
}

// è®°å½•ç¼–è¾‘å†å²
async function recordEditHistory(collection, docId, data) {
    try {
        let historyCollection;
        
        // æ ¹æ®ç±»å‹ç¡®å®šæ­£ç¡®çš„é›†åˆåç§°
        switch(collection) {
            case 'announcements':
                historyCollection = 'announcementHistory';
                break;
            case 'wallPosts':
                historyCollection = 'noteHistory';
                break;
            case 'events':
                historyCollection = 'eventHistory';
                break;
        }
        
        if (!historyCollection) return;
        
        await db.collection(historyCollection).add({
            docId: docId,
            ...data,
            editedByName: userName.textContent,
            editedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error recording edit history:', error);
    }
}

// ==================== æ–°å¢ï¼šåˆ é™¤åŠŸèƒ½å¢å¼º ====================

// æ‰“å¼€åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
function openDeleteConfirmation(itemId, itemType, itemName) {
    const modal = document.getElementById('confirm-delete-modal');
    const message = document.getElementById('delete-message');
    
    modal.setAttribute('data-delete-id', itemId);
    modal.setAttribute('data-delete-type', itemType);
    
    message.textContent = `Are you sure you want to delete "${itemName}"? This action cannot be undone.`;
    
    openModal('confirm-delete-modal');
}

// ç¡®è®¤åˆ é™¤
async function confirmDelete() {
    const modal = document.getElementById('confirm-delete-modal');
    const itemId = modal.getAttribute('data-delete-id');
    const itemType = modal.getAttribute('data-delete-type');
    
    closeModal('confirm-delete-modal');
    
    try {
        switch(itemType) {
            case 'announcement':
                await deleteAnnouncement(itemId);
                break;
            case 'note':
                await deleteWallPost(itemId);
                break;
            case 'event':
                await deleteEvent(itemId);
                break;
        }
        
        showAlert('Deleted successfully', 'success');
    } catch (error) {
        showAlert(`Delete failed: ${error.message}`, 'error');
    }
}

       function editAnnouncement(announcementId) {
    let announcement;
    
    // Find the announcement in demo data or Firebase
    if (window.demoAnnouncements) {
        // For demo data
        const index = parseInt(announcementId.replace('announcement-', ''));
        announcement = window.demoAnnouncements[index];
        
        if (announcement) {
            // Populate edit form
            document.getElementById('edit-announcement-id').value = announcementId;
            document.getElementById('edit-announcement-title').value = announcement.title;
            document.getElementById('edit-announcement-content').value = announcement.content;
            
            // Show edit modal
            openModal('edit-announcement-modal');
        }
    } else if (db) {
        // For Firebase data
        db.collection('announcements').doc(announcementId).get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Populate edit form
                    document.getElementById('edit-announcement-id').value = announcementId;
                    document.getElementById('edit-announcement-title').value = data.title;
                    document.getElementById('edit-announcement-content').value = data.content;
                    
                    // Show edit modal
                    openModal('edit-announcement-modal');
                } else {
                    showAlert('Announcement not found', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading announcement:', error);
                showAlert('Error loading announcement', 'error');
            });
    }
}

// Handle edit announcement form submission
document.getElementById('edit-announcement-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const announcementId = document.getElementById('edit-announcement-id').value;
    const title = document.getElementById('edit-announcement-title').value;
    const content = document.getElementById('edit-announcement-content').value;
    
    if (!title || !content) {
        showAlert('Please fill in title and content', 'error');
        return;
    }
    
    try {
        if (window.demoAnnouncements) {
            // Update demo data
            const index = parseInt(announcementId.replace('announcement-', ''));
            if (window.demoAnnouncements[index]) {
                window.demoAnnouncements[index].title = title;
                window.demoAnnouncements[index].content = content;
                window.demoAnnouncements[index].updatedAt = new Date();
                
                // Reload announcements
                loadAnnouncements();
                
                // Close modal
                closeModal('edit-announcement-modal');
                
                showAlert('Announcement updated successfully (Demo mode)', 'success');
            }
        } else if (db) {
            // Update in Firebase
            await db.collection('announcements').doc(announcementId).update({
                title: title,
                content: content,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Reload announcements
            loadAnnouncements();
            
            // Close modal
            closeModal('edit-announcement-modal');
            
            showAlert('Announcement updated successfully', 'success');
        }
    } catch (error) {
        console.error('Error updating announcement:', error);
        showAlert(`Error updating announcement: ${error.message}`, 'error');
    }
});


// åˆ é™¤å…¬å‘Š
// Delete announcement function
async function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
    }
    
    try {
        if (window.demoAnnouncements) {
            // Delete from demo data
            const index = parseInt(announcementId.replace('announcement-', ''));
            if (window.demoAnnouncements[index]) {
                window.demoAnnouncements.splice(index, 1);
                
                // Reload announcements
                loadAnnouncements();
                
                showAlert('Announcement deleted successfully (Demo mode)', 'success');
            }
        } else if (db) {
            // Delete from Firebase
            await db.collection('announcements').doc(announcementId).delete();
            
            // Reload announcements
            loadAnnouncements();
            
            showAlert('Announcement deleted successfully', 'success');
        }
    } catch (error) {
        console.error('Error deleting announcement:', error);
        showAlert(`Error deleting announcement: ${error.message}`, 'error');
    }
}
// ==================== æ–°å¢ï¼šæ‰¹é‡æ“ä½œåŠŸèƒ½ ====================

// è®¾ç½®æ‰¹é‡æ“ä½œ
function setupBatchOperations() {
    const batchActions = document.getElementById('batch-actions');
    
    // ç›‘å¬é€‰æ‹©æ¡†å˜åŒ–
    document.addEventListener('click', function(e) {
        if (e.target.matches('.item-checkbox')) {
            const itemId = e.target.getAttribute('data-id');
            const itemType = e.target.getAttribute('data-type');
            
            if (e.target.checked) {
                selectedItems.add(`${itemType}_${itemId}`);
            } else {
                selectedItems.delete(`${itemType}_${itemId}`);
            }
            
            updateBatchUI();
        }
    });
}

// æ›´æ–°æ‰¹é‡æ“ä½œUI
function updateBatchUI() {
    const batchActions = document.getElementById('batch-actions');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedItems.size > 0) {
        batchActions.classList.add('active');
        selectedCount.textContent = `${selectedItems.size} items selected`;
    } else {
        batchActions.classList.remove('active');
    }
    
    // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    const allChecked = allCheckboxes.length > 0 && 
        Array.from(allCheckboxes).every(checkbox => checkbox.checked);
    
    document.getElementById('select-all-items').checked = allChecked;
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰
function toggleSelectAll(e) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
        const itemId = checkbox.getAttribute('data-id');
        const itemType = checkbox.getAttribute('data-type');
        
        if (e.target.checked) {
            selectedItems.add(`${itemType}_${itemId}`);
        } else {
            selectedItems.delete(`${itemType}_${itemId}`);
        }
    });
    
    updateBatchUI();
}

// æ‰¹é‡åˆ é™¤
async function handleBatchDelete() {
    if (selectedItems.size === 0) {
        showAlert('Please select the items you want to delete first.', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the ${selectedItems.size} selected items?`)) {
        return;
    }
    
    try {
        const deletePromises = [];
        
        for (const itemKey of selectedItems) {
            const [itemType, itemId] = itemKey.split('_');
            
            switch(itemType) {
                case 'announcement':
                    deletePromises.push(deleteAnnouncement(itemId));
                    break;
                case 'note':
                    deletePromises.push(deleteWallPost(itemId));
                    break;
                case 'event':
                    deletePromises.push(deleteEvent(itemId));
                    break;
            }
        }
        
        await Promise.all(deletePromises);
        
        // æ¸…é™¤é€‰æ‹©
        clearSelection();
        
        showAlert(`Successfully deleted ${selectedItems.size} items`, 'success');
        
    } catch (error) {
        console.error('Error in batch delete:', error);
        showAlert('An error occurred during bulk deletion.', 'error');
    }
}

// æ¸…é™¤é€‰æ‹©
function clearSelection() {
    selectedItems.clear();
    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBatchUI();
}

// ==================== æ–°å¢ï¼šé”®ç›˜å¿«æ·é”® ====================

// å¤„ç†é”®ç›˜å¿«æ·é”®
function handleKeyboardShortcuts(e) {
    // ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å¯ç”¨
    const activeModal = document.querySelector('.modal.active');
    if (!activeModal) return;
    
    // Ctrl+S ä¿å­˜
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        
        switch(activeModal.id) {
            case 'edit-announcement-modal':
                document.getElementById('edit-announcement-form').dispatchEvent(new Event('submit'));
                break;
            case 'edit-note-modal':
                document.getElementById('edit-note-form').dispatchEvent(new Event('submit'));
                break;
            case 'edit-event-modal':
                document.getElementById('edit-event-form').dispatchEvent(new Event('submit'));
                break;
        }
    }
    
    // Ctrl+Z æ’¤é”€
    if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        
        switch(activeModal.id) {
            case 'edit-announcement-modal':
                undoChanges('announcement');
                break;
            case 'edit-note-modal':
                undoChanges('note');
                break;
            case 'edit-event-modal':
                undoChanges('event');
                break;
        }
    }
    
    // Delete é”®åˆ é™¤
    if (e.key === 'Delete' && selectedItems.size > 0) {
        e.preventDefault();
        handleBatchDelete();
    }
}

// ==================== æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜åŠŸèƒ½ ====================

// å®‰æ’è‡ªåŠ¨ä¿å­˜
function scheduleAutoSave(type) {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    showAutoSaveStatus('Saving changes...', 'saving');
    
    autoSaveTimer = setTimeout(() => {
        autoSaveContent(type);
    }, 2000); // 2ç§’åè‡ªåŠ¨ä¿å­˜
}

// æ‰§è¡Œè‡ªåŠ¨ä¿å­˜
async function autoSaveContent(type) {
    try {
        let id, data = {};
        
        switch(type) {
            case 'announcement':
                id = document.getElementById('edit-announcement-id').value;
                data = {
                    title: document.getElementById('edit-announcement-title').value,
                    content: document.getElementById('edit-announcement-content').value
                };
                await db.collection('announcements').doc(id).update({
                    ...data,
                    autoSavedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                break;
            case 'note':
                id = document.getElementById('edit-note-id').value;
                data = {
                    title: document.getElementById('edit-note-title').value,
                    content: document.getElementById('edit-note-content').value
                };
                await db.collection('wallPosts').doc(id).update({
                    ...data,
                    autoSavedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                break;
            case 'event':
                id = document.getElementById('edit-event-id').value;
                data = {
                    title: document.getElementById('edit-event-title').value,
                    description: document.getElementById('edit-event-description').value
                };
                await db.collection('events').doc(id).update({
                    ...data,
                    autoSavedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                break;
        }
        
        showAutoSaveStatus('Saved automatically', 'saved');
        
    } catch (error) {
        console.error('Auto-save error:', error);
        showAutoSaveStatus('Failed to save', 'error');
    }
}

// æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜çŠ¶æ€
function showAutoSaveStatus(text, status) {
    const statusDiv = document.getElementById('autosave-status');
    const textSpan = document.getElementById('autosave-text');
    
    textSpan.textContent = text;
    
    // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
    switch(status) {
        case 'saving':
            statusDiv.style.backgroundColor = 'var(--warning)';
            break;
        case 'saved':
            statusDiv.style.backgroundColor = 'var(--success)';
            break;
        case 'error':
            statusDiv.style.backgroundColor = 'var(--danger)';
            break;
    }
    
    statusDiv.style.display = 'flex';
    
    // 3ç§’åéšè—
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}

// æ˜¾ç¤ºå¿«æ·é”®æç¤º
function showShortcutHint() {
    const hint = document.getElementById('shortcut-hint');
    hint.style.display = 'block';
    
    setTimeout(() => {
        hint.style.display = 'none';
    }, 2000);
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(date) {
    if (!date) return 'Time Unknown';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Just Now';
    if (diffMins < 60) return `${diffMins}Minutes Before`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}Hours Before`;
    
    return formatDate(date);
}

    
    function initTabs() {
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                
                // Show active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                // Load data if needed
                if (tabId === 'admin-users' && isAdmin) {
                    loadUserManagement();
                } else if (tabId === 'admin-content' && isAdmin) {
                    loadAdminContent();
                }
            });
        });
    }

       function cleanupAllCharts() {
    // æ¸…ç†è¿›åº¦å›¾è¡¨
    if (window.progressChart && typeof window.progressChart.destroy === 'function') {
        try {
            window.progressChart.destroy();
        } catch (e) {
            console.error('Error destroying progress chart:', e);
        }
        window.progressChart = null;
    }
    
    // æ¸…ç†æ‰€æœ‰Chart.jså®ä¾‹
    if (typeof Chart !== 'undefined' && Chart.instances) {
        Object.keys(Chart.instances).forEach(key => {
            try {
                if (Chart.instances[key] && Chart.instances[key].destroy) {
                    Chart.instances[key].destroy();
                }
            } catch (e) {
                console.error('Error destroying chart instance:', e);
            }
        });
    }
    
    // æ¸…ç†æ‰€æœ‰Canvaså…ƒç´ 
    document.querySelectorAll('canvas').forEach(canvas => {
        const ctx = canvas.getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    });
}

       function ultimateSafeChart() {
    try {
        const canvas = document.getElementById('progress-chart');
        if (!canvas) {
            console.warn('No canvas found for chart');
            return null;
        }
        
        // æ¸…ç†å·²æœ‰çš„ chartï¼ˆç”¨æœ€å®‰å…¨çš„æ–¹å¼ï¼‰
        if (typeof Chart !== 'undefined') {
            try {
                const existing = Chart.getChart(canvas);
                if (existing) {
                    console.log('Found existing chart, will reuse');
                    return existing;
                }
            } catch (e) {
                console.warn('Error checking existing chart:', e);
            }
        }
        
        // å¦‚æœ Chart.js æ²¡åŠ è½½ï¼Œä»€ä¹ˆéƒ½ä¸åš
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js not loaded, skipping chart creation');
            return null;
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.warn('Could not get canvas context');
            return null;
        }
        
        // åˆ›å»ºæœ€åŸºæœ¬çš„å›¾è¡¨ï¼ˆä¸ä¼šå¤±è´¥çš„é…ç½®ï¼‰
        const basicChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Safe Mode'],
                datasets: [{
                    label: 'Chart loaded safely',
                    data: [1],
                    backgroundColor: 'rgba(100, 100, 100, 0.2)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false  // ç¦ç”¨åŠ¨ç”»ï¼Œæ›´ç¨³å®š
            }
        });
        
        console.log('Ultimate safe chart created successfully');
        return basicChart;
        
    } catch (error) {
        console.warn('Ultimate safe chart failed (non-critical):', error);
        return null;
    }
}
    
    // Navigation
 function navigateTo(pageId) {
    console.log('Navigate to page:', pageId);
     cleanupAllCharts();
    
    // æ¸…ç†æ—§çš„è®¡æ—¶å™¨
    if (window.countdownTimer) {
        clearInterval(window.countdownTimer);
        window.countdownTimer = null;
    }
    
    // æ¸…ç†å…¶ä»–å¯èƒ½çš„è®¡æ—¶å™¨
    if (window.wallTimer) {
        clearInterval(window.wallTimer);
        window.wallTimer = null;
    }

    // âš ï¸ é‡è¦ï¼šå¦‚æœè¿˜åœ¨ admin é¡µé¢ï¼Œä¸è¦ reset chart
    if (currentPage === 'admin' && pageId === 'admin') {
        console.log('Staying in admin page, no chart reset needed');
    } else if (currentPage === 'admin' && pageId !== 'admin') {
        console.log('Leaving admin page, soft reset chart manager');
        chartManager.hide();  // åªéšè—ï¼Œä¸é‡ç½®
    }

         // æ¸…ç†å›¾è¡¨ï¼ˆæ–°å¢ï¼‰
    if (window.progressChart) {
        window.progressChart.destroy();
        window.progressChart = null;
    }

     cleanupCharts();
    
    // æ›´æ–°æ´»åŠ¨å¯¼èˆªé“¾æ¥
    navLinks.forEach(link => {
        if (link.getAttribute('data-page') === pageId || link.getAttribute('href').substring(1) === pageId) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
    
    // éšè—æ‰€æœ‰é¡µé¢
    Object.values(pages).forEach(page => {
        if (page) {
            page.classList.remove('active');
        }
    });
    
    // æ˜¾ç¤ºç›®æ ‡é¡µé¢
    const targetPage = pages[pageId];
    if (targetPage) {
        targetPage.classList.add('active');
        currentPage = pageId;
        
        // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°åå†åŠ è½½æ•°æ®
        setTimeout(() => {
            // åŠ è½½é¡µé¢ç‰¹å®šæ•°æ®
            switch(pageId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'announcements':
                    loadAnnouncements();
                    break;
                case 'wall':
                    // ç¡®ä¿é¡µé¢å®Œå…¨æ˜¾ç¤ºåå†åŠ è½½è´´æ–‡
                    loadWallPosts();
                    updateAddNoteButton();
                    break;
                case 'calendar':
                    loadCalendarEvents();
                    break;
                case 'countdown':
                    initCountdownPage();
                    loadCountdownData();
                    break;
                case 'admin':
                    if (isAdmin) {
                        loadAdminData();
                        
                        // ==================== ä¿®å¤3ï¼šé‡æ–°åˆå§‹åŒ–trackingåŠŸèƒ½ ====================
                        setTimeout(() => {
                            try {
                                console.log('Initializing admin tracking features...');
                                
                                // é‡æ–°åˆå§‹åŒ–task trackingç³»ç»Ÿ
                                if (window.taskTracking) {
                                    window.taskTracking.initialize();
                                }
                                
                                // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                                initTaskTracking();
                                
                                // ç¡®ä¿trackingæ ‡ç­¾é¡µé»˜è®¤æ˜¾ç¤ºoverview
                                const trackingContainer = document.getElementById('admin-tracking');
                                if (trackingContainer) {
                                    console.log('Found tracking container, activating default tab...');
                                    
                                    // æ¿€æ´»é»˜è®¤çš„trackingæ ‡ç­¾é¡µ
                                    const defaultTab = trackingContainer.querySelector('.tab[data-tab="tracking-overview"]');
                                    if (defaultTab) {
                                        defaultTab.click();
                                    } else {
                                        // æ‰‹åŠ¨æ¿€æ´»
                                        activateTrackingTab('tracking-overview');
                                    }
                                }
                            } catch (error) {
                                console.error('Error initializing admin tracking:', error);
                            }
                        }, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿DOMå®Œå…¨åŠ è½½
                        // ==================== ä¿®å¤3ç»“æŸ ====================
                        
                    } else {
                        navigateTo('dashboard');
                        showAlert('You do not have administrator permissions.', 'error');
                    }
                    break;
            }
        }, 100);
    }
}

// ==================== ä¿®å¤1ï¼šæ›´æ–°activateTrackingTabå‡½æ•° ====================
// æ¿€æ´»è·Ÿè¸ªæ ‡ç­¾é¡µ
function activateTrackingTab(tabId) {
    console.log('Activating tracking tab:', tabId);
    
    try {
        const trackingContainer = document.getElementById('admin-tracking');
        if (!trackingContainer) {
            console.error('Tracking container not found');
            return;
        }
        
        // æ›´æ–°tabçŠ¶æ€
        trackingContainer.querySelectorAll('.tabs .tab').forEach(t => {
            t.classList.remove('active');
        });
        
        const activeTab = trackingContainer.querySelector(`.tab[data-tab="${tabId}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        trackingContainer.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        const activeContent = document.getElementById(tabId);
        if (activeContent) {
            activeContent.classList.add('active');
        }
        
        // å›¾è¡¨å¤„ç†ï¼šåªåœ¨ tracking-overview æ˜¾ç¤ºå›¾è¡¨
        if (tabId === 'tracking-overview') {
            console.log('Showing chart for tracking-overview');
            setTimeout(() => {
                loadTrackingOverview();
            }, 100); // å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°
        } else {
            console.log('Hiding chart for non-overview tab');
            chartManager.hide();
            
            // åŠ è½½å…¶ä»–æ ‡ç­¾é¡µå†…å®¹
            switch(tabId) {
                case 'tracking-tasks':
                    loadManageTasks();
                    break;
                case 'tracking-students':
                    loadStudentProgressList();
                    break;
                case 'tracking-reports':
                    const reportOutput = document.getElementById('report-output');
                    if (reportOutput) {
                        reportOutput.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <p>Select parameters and generate a report</p>
                            </div>
                        `;
                    }
                    break;
            }
        }
        
    } catch (error) {
        console.error('Error activating tracking tab:', error);
    }
}

// ==================== ä¿®å¤2ï¼šæ›´æ–°initTaskTrackingå‡½æ•° ====================
function initTaskTracking() {
    console.log('Initializing task tracking...');
    
    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMåŠ è½½å®Œæˆ
    setTimeout(() => {
        try {
            // Add Task button
            const addTaskBtn = document.getElementById('add-task-btn');
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openTaskModal();
                });
                console.log('Add task button listener added');
            }
            
            // Task form submission
            const taskForm = document.getElementById('task-form');
            if (taskForm) {
                taskForm.addEventListener('submit', handleSaveTask);
                console.log('Task form listener added');
            }
            
            // Generate report button
            const generateReportBtn = document.getElementById('generate-report');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', handleGenerateReport);
                console.log('Generate report button listener added');
            }
            
            // Task tracking tabs - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            const trackingContainer = document.getElementById('admin-tracking');
            if (trackingContainer) {
                trackingContainer.addEventListener('click', function(e) {
                    const tab = e.target.closest('.tab');
                    if (tab && tab.closest('#admin-tracking')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const tabId = tab.getAttribute('data-tab');
                        console.log('Tracking tab clicked:', tabId);
                        if (tabId) {
                            activateTrackingTab(tabId);
                        }
                    }
                });
                console.log('Tracking tabs listener added');
            }
            
            console.log('Task tracking initialization complete');
        } catch (error) {
            console.error('Error initializing task tracking:', error);
        }
    }, 500);
}

function debugReset() {
    console.trace('ğŸš¨ RESET TRIGGERED - Stack trace below:');
    console.log('Current page:', currentPage);
    console.log('Current tab:', document.querySelector('.tab.active')?.getAttribute('data-tab'));
    console.log('Chart status:', chartManager.getStatus());
}
       
// ==================== ä¿®å¤4ï¼šç®€åŒ–loadTrackingTabå‡½æ•° ====================
async function loadTrackingTab(tabId) {
    console.log('Loading tracking tab via unified system:', tabId);
    
    try {
        // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
        const tabs = ['tracking-overview', 'tracking-tasks', 'tracking-students', 'tracking-reports'];
        tabs.forEach(tab => {
            const content = document.getElementById(tab);
            if (content) {
                content.style.display = 'none';
            }
        });
        
        // æ˜¾ç¤ºç›®æ ‡æ ‡ç­¾é¡µ
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.style.display = 'block';
            console.log(`Tab ${tabId} displayed`);
        }
        
        // å›¾è¡¨ç®¡ç†ï¼šåªåœ¨ tracking-overview æ˜¾ç¤º
        if (tabId === 'tracking-overview') {
            console.log('Showing chart for tracking-overview');
            await loadTrackingOverview();
        } else {
            console.log('Hiding chart for non-overview tab');
            chartManager.hide();
            
            // åŠ è½½å…¶ä»–æ ‡ç­¾é¡µå†…å®¹
            switch(tabId) {
                case 'tracking-tasks':
                    await loadManageTasks();
                    break;
                case 'tracking-students':
                    await loadStudentProgressList();
                    break;
                case 'tracking-reports':
                    const reportOutput = document.getElementById('report-output');
                    if (reportOutput) {
                        reportOutput.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <p>Select parameters and generate a report</p>
                            </div>
                        `;
                    }
                    break;
            }
        }
        
        console.log(`Tracking tab ${tabId} loaded successfully`);
        
    } catch (error) {
        console.error(`Error loading tracking tab ${tabId}:`, error);
        showAlert(`Error loading ${tabId}: ${error.message}`, 'error');
    }
}
    
       // åˆå§‹åŒ–å€’è®¡æ—¶é¡µé¢
function initCountdownPage() {
    console.log('Initializing countdown page');
    
    // ç¡®ä¿å€’è®¡æ—¶é¡µé¢å…ƒç´ å­˜åœ¨
    if (!document.getElementById('countdown-page')) {
        console.error('Countdown page elements not found');
        return;
    }
    
    // åˆå§‹åŒ–å€’è®¡æ—¶æ ‡ç­¾é¡µ
    initCountdownTabs();
    
    // åˆå§‹åŒ–å€’è®¡æ—¶äº‹ä»¶ç›‘å¬å™¨
    initCountdownEventListeners();
    
    // åŠ è½½å€’è®¡æ—¶æ•°æ®
    loadCountdownData();
    
    // ä¸ºç®¡ç†å‘˜æ ‡ç­¾é¡µæ·»åŠ ç‚¹å‡»äº‹ä»¶
    const adminTab = document.getElementById('countdown-admin-tab');
    if (adminTab) {
        adminTab.addEventListener('click', function(e) {
            if (!isAdmin) {
                showAlert('Administrator permissions are required to access the settings page.', 'error');
                e.preventDefault();
                return;
            }
        });
    }
    
    console.log('Countdown page initialization complete');
}

       // é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ä½¿ç”¨é˜²æŠ–çš„ä¿å­˜å‡½æ•°
const debouncedSaveNote = debounce(handleEditNote, 1000);

// åœ¨è¡¨å•æäº¤æ—¶ä½¿ç”¨é˜²æŠ–
document.getElementById('edit-note-form').addEventListener('submit', function(e) {
    e.preventDefault();
    debouncedSaveNote(e);
});

// åˆå§‹åŒ–å€’è®¡æ—¶æ ‡ç­¾é¡µ
// åœ¨ initCountdownTabs å‡½æ•°ä¸­ä¿®å¤
// ä¿®å¤æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
function initCountdownTabs() {
    const countdownTabs = document.querySelectorAll('#countdown-page .tab');
    countdownTabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            const tabId = this.getAttribute('data-tab');
            
            // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
            countdownTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
            document.querySelectorAll('#countdown-page .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // é˜²æ­¢é¡µé¢æ»šåŠ¨
            setTimeout(() => {
                document.getElementById('countdown-page').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜æ ‡ç­¾ï¼Œæ£€æŸ¥æƒé™
            if (tabId === 'countdown-admin') {
                if (!isAdmin) {
                    showAlert('Administrator permissions are required to access the settings page.', 'error');
                    document.querySelector('#countdown-page .tab[data-tab="countdown-view"]').click();
                    return;
                }
                
                // åŠ è½½è¡¨å•æ•°æ®
                loadCountdownFormData();
            }
        });
    });
}

       // åœ¨ä¿å­˜æˆåŠŸåé‡ç½®è¡¨å•
function resetCountdownForm() {
    document.getElementById('countdown-settings-form').reset();
    document.getElementById('countdown-event-color').value = '#4361ee';
    
    // é‡ç½®é¢œè‰²é€‰æ‹©å™¨
    document.querySelectorAll('.color-option').forEach(option => {
        if (option.getAttribute('data-color') === '#4361ee') {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
    });
}

       // åœ¨ saveCountdownSettings æˆåŠŸåè°ƒç”¨
function clearCountdownTemplate() {
    // æ¸…é™¤æ¨¡æ¿æ¶ˆæ¯
    const messageElement = document.getElementById('countdown-message');
    if (messageElement && messageElement.textContent.includes('Loading countdown information...')) {
        messageElement.textContent = 'Countdown settings activated';
        messageElement.style.background = 'rgba(46, 204, 113, 0.1)';
        messageElement.style.borderColor = 'var(--success)';
        messageElement.style.color = 'var(--success)';
    }
    
    // æ›´æ–°æ˜¾ç¤ºå†…å®¹
    const eventTitle = document.getElementById('countdown-event-title');
    const eventDesc = document.getElementById('countdown-event-desc');
    
    if (eventTitle.textContent === 'Next Online Exchange Meeting') {
        // è¿™è¡¨ç¤ºè¿˜åœ¨ä½¿ç”¨æ¨¡æ¿å†…å®¹
        // å®é™…å†…å®¹ä¼šåœ¨ updateCountdownDisplay ä¸­æ›´æ–°
    }
}

// æ–°å¢å‡½æ•°ï¼šåŠ è½½è¡¨å•æ•°æ®
async function loadCountdownFormData() {
    try {
        const countdownDoc = await db.collection('countdown').doc('current').get();
        if (countdownDoc.exists) {
            populateCountdownForm(countdownDoc.data());
        }
    } catch (error) {
        console.error('Error loading countdown form data:', error);
    }
}

// åˆå§‹åŒ–å€’è®¡æ—¶äº‹ä»¶ç›‘å¬å™¨
function initCountdownEventListeners() {
    // é¢œè‰²é€‰æ‹©å™¨
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            this.classList.add('active');
            document.getElementById('countdown-event-color').value = this.getAttribute('data-color');
        });
    });
    
    // è®¾ç½®æé†’æŒ‰é’®
    document.getElementById('set-reminder-btn').addEventListener('click', setReminder);
    
    // åˆ†äº«å€’è®¡æ—¶æŒ‰é’®
    document.getElementById('share-countdown-btn').addEventListener('click', shareCountdown);
    
    // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
    document.getElementById('view-details-btn').addEventListener('click', viewEventDetails);
    
    // ç®¡ç†å‘˜è¡¨å•æäº¤
    document.getElementById('countdown-settings-form').addEventListener('submit', saveCountdownSettings);
    
    // æµ‹è¯•å€’è®¡æ—¶æŒ‰é’®
    document.getElementById('test-countdown-btn').addEventListener('click', testCountdown);
    
    // æ¸…é™¤å€’è®¡æ—¶æŒ‰é’®
    document.getElementById('clear-countdown-btn').addEventListener('click', clearCountdown);
    
    // æ—¥æœŸè¾“å…¥æ¡†é»˜è®¤å€¼è®¾ç½®ä¸ºæ˜å¤©
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const formattedDate = tomorrow.toISOString().split('T')[0];
    document.getElementById('countdown-event-date').value = formattedDate;
    document.getElementById('countdown-event-date').min = formattedDate;
}

// åŠ è½½å€’è®¡æ—¶æ•°æ®
async function loadCountdownData() {
    try {
        // è·å–å€’è®¡æ—¶è®¾ç½®
        const countdownDoc = await db.collection('countdown').doc('current').get();
        
        if (countdownDoc.exists) {
            const countdownData = countdownDoc.data();
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦å®Œæ•´
            if (!countdownData.eventName || !countdownData.eventDate) {
                // å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œåˆ›å»ºé»˜è®¤æ•°æ®
                await createDefaultCountdown();
                return;
            }
            
            updateCountdownDisplay(countdownData);
            updateCountdownPreview(countdownData);
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜é¡µé¢ï¼Œå¡«å……è¡¨å•
            if (isAdmin && document.getElementById('countdown-admin').classList.contains('active')) {
                populateCountdownForm(countdownData);
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateCountdownStats();
            
            // åŠ è½½è¿‡å¾€æ´»åŠ¨
            loadPastEvents();
            
            // å¼€å§‹å€’è®¡æ—¶
            startCountdownTimer(countdownData);
        } else {
            // åˆ›å»ºé»˜è®¤å€’è®¡æ—¶
            await createDefaultCountdown();
        }
    } catch (error) {
        console.error('Error loading countdown data:', error);
        showCountdownMessage('Error loading countdown data', 'error');
        
        // å°è¯•åˆ›å»ºé»˜è®¤æ•°æ®
        try {
            await createDefaultCountdown();
        } catch (createError) {
            console.error('Error creating default countdown:', createError);
        }
    }
}

// åˆ›å»ºé»˜è®¤å€’è®¡æ—¶
async function createDefaultCountdown() {
    try {
        // è®¾ç½®é»˜è®¤æ—¶é—´ï¼ˆä¸€å‘¨åï¼‰
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 7);
        
        const defaultCountdown = {
            eventName: 'Online Cultural Exchange Conference',
            eventDescription: 'Online Cultural Exchange between Foon Yew High School, Malaysia and Kaohsiung Municipal Kaohsiung Senior High School, Taiwan',
            eventDate: firebase.firestore.Timestamp.fromDate(defaultDate),
            eventTime: '14:00',
            eventPlatform: 'zoom',
            eventLink: '',
            participants: 150,
            themeColor: '#4361ee',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: 'system',
            views: 0,
            reminders: 0,
            isActive: true
        };
        
        await db.collection('countdown').doc('current').set(defaultCountdown);
        
        // æ›´æ–°æ˜¾ç¤º
        updateCountdownDisplay(defaultCountdown);
        startCountdownTimer(defaultCountdown);
        
    } catch (error) {
        console.error('Error creating default countdown:', error);
    }
}

// æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
function updateCountdownDisplay(data) {
    if (!data) return;
    
    // æ›´æ–°æ ‡é¢˜å’Œæè¿°
    document.getElementById('countdown-event-title').textContent = data.eventName || 'Next Online Exchange Meeting';
    document.getElementById('countdown-event-desc').textContent = data.eventDescription || 'Online Exchange Activity between Foon Yew High School and Kaohsiung Senior High School';
    
    // æ›´æ–°æ—¥æœŸæ—¶é—´æ˜¾ç¤º
    const eventDate = data.eventDate?.toDate();
    if (eventDate) {
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        };
        const dateStr = eventDate.toLocaleDateString('zh-CN', options);
        const timeStr = data.eventTime || '14:00';
        document.getElementById('event-date-time').textContent = `${dateStr} ${timeStr}`;
    }
    
    // æ›´æ–°å¹³å°
    const platformMap = {
        'zoom': 'Zoom Meeting',
        'google-meet': 'Google Meet',
        'microsoft-teams': 'Microsoft Teams',
        'other': 'Other Platform'
    };
    document.getElementById('event-platform').textContent = platformMap[data.eventPlatform] || data.eventPlatform || 'Online Meeting Platform';
    
    // æ›´æ–°å‚ä¸äººæ•°
    document.getElementById('event-participants').textContent = `${data.participants || 0} person`;
    
    // æ›´æ–°ä¸»é¢˜é¢œè‰²
    if (data.themeColor) {
        document.querySelectorAll('.countdown-number').forEach(el => {
            el.style.color = data.themeColor;
        });
        document.querySelectorAll('.countdown-separator').forEach(el => {
            el.style.color = data.themeColor;
        });
    }
}

// å¼€å§‹å€’è®¡æ—¶è®¡æ—¶å™¨
function startCountdownTimer(data) {
    const eventDate = data.eventDate?.toDate();
    if (!eventDate) return;
    
    // è®¾ç½®æ—¶é—´
    const timeStr = data.eventTime || '00:00';
    const [hours, minutes] = timeStr.split(':').map(Number);
    eventDate.setHours(hours, minutes, 0, 0);
    
    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
    updateCountdownTime(eventDate);
    
    // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    const timer = setInterval(() => {
        updateCountdownTime(eventDate);
    }, 1000);
    
    // ä¿å­˜è®¡æ—¶å™¨å¼•ç”¨ä»¥ä¾¿æ¸…ç†
    window.countdownTimer = timer;
}

       // æ·»åŠ æ•°å­—åŠ¨ç”»æ•ˆæœ
function animateStatUpdate(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent) || 0;
    const targetValue = parseInt(newValue) || 0;
    
    if (currentValue === targetValue) return;
    
    const duration = 1000; // 1ç§’åŠ¨ç”»
    const startTime = Date.now();
    const startValue = currentValue;
    
    function updateAnimation() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ç¼“åŠ¨å‡½æ•°
        const easedProgress = progress < 0.5 
            ? 2 * progress * progress 
            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
        
        const current = Math.floor(startValue + (targetValue - startValue) * easedProgress);
        element.textContent = current;
        
        if (progress < 1) {
            requestAnimationFrame(updateAnimation);
        }
    }
    
    requestAnimationFrame(updateAnimation);
}

// åœ¨æ›´æ–°ç»Ÿè®¡æ—¶ä½¿ç”¨åŠ¨ç”»
// ä¾‹å¦‚ï¼šanimateStatUpdate('total-participants', 4);

// æ›´æ–°å€’è®¡æ—¶æ—¶é—´
function updateCountdownTime(targetDate) {
    const now = new Date();
    const diff = targetDate - now;
    
    // æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
    if (diff <= 0) {
        clearInterval(window.countdownTimer);
        showCountdownMessage('The exchange meeting is now in progress! Join now!', 'success');
        document.getElementById('countdown-display').classList.add('countdown-completed');
        document.querySelectorAll('.countdown-number').forEach(el => {
            el.textContent = '00';
        });
        return;
    }
    
    // è®¡ç®—å¤©ã€å°æ—¶ã€åˆ†é’Ÿã€ç§’
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('days').textContent = String(days).padStart(2, '0');
    document.getElementById('hours').textContent = String(hours).padStart(2, '0');
    document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
    document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    const numberElements = document.querySelectorAll('.countdown-number');
    numberElements.forEach(el => {
        el.classList.add('updated');
        setTimeout(() => el.classList.remove('updated'), 500);
    });
    
    // å¦‚æœå°‘äº24å°æ—¶ï¼Œæ·»åŠ ç´§æ€¥æ ·å¼
    if (days === 0 && hours < 24) {
        document.getElementById('countdown-display').classList.add('countdown-urgent');
        showCountdownMessage('The exchange meeting is starting soon! Please be prepared!', 'warning');
    } else {
        document.getElementById('countdown-display').classList.remove('countdown-urgent');
        
        // æ ¹æ®å‰©ä½™æ—¶é—´æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
        if (days === 1) {
            showCountdownMessage('The exchange meeting starts tomorrow! Please check your equipment!', 'info');
        } else if (days === 7) {
            showCountdownMessage('One week until the exchange meetingï¼', 'info');
        } else if (days < 7) {
            showCountdownMessage('The exchange meeting is coming soonï¼', 'info');
        } else {
            showCountdownMessage('The exchange meeting is being prepared...', 'info');
        }
    }
    
    // æ›´æ–°å‰©ä½™å¤©æ•°ç»Ÿè®¡
    document.getElementById('days-remaining').textContent = days;
}

// æ˜¾ç¤ºå€’è®¡æ—¶æ¶ˆæ¯
function showCountdownMessage(message, type) {
    const messageEl = document.getElementById('countdown-message');
    if (!messageEl) return;
    
    messageEl.textContent = message;
    messageEl.className = 'countdown-message';
    
    // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
    switch(type) {
        case 'success':
            messageEl.style.background = 'rgba(46, 204, 113, 0.1)';
            messageEl.style.borderColor = 'var(--success)';
            messageEl.style.color = 'var(--success)';
            break;
        case 'warning':
            messageEl.style.background = 'rgba(243, 156, 18, 0.1)';
            messageEl.style.borderColor = 'var(--warning)';
            messageEl.style.color = 'var(--warning)';
            break;
        case 'error':
            messageEl.style.background = 'rgba(231, 76, 60, 0.1)';
            messageEl.style.borderColor = 'var(--danger)';
            messageEl.style.color = 'var(--danger)';
            break;
        default:
            messageEl.style.background = 'rgba(52, 152, 219, 0.1)';
            messageEl.style.borderColor = 'var(--info)';
            messageEl.style.color = 'var(--info)';
    }
}

// å¡«å……å€’è®¡æ—¶è¡¨å•ï¼ˆç®¡ç†å‘˜ï¼‰
function populateCountdownForm(data) {
    if (!data || !isAdmin) return;
    
    const eventDate = data.eventDate?.toDate();
    
    document.getElementById('countdown-event-name').value = data.eventName || '';
    document.getElementById('countdown-event-description').value = data.eventDescription || '';
    
    if (eventDate) {
        document.getElementById('countdown-event-date').value = eventDate.toISOString().split('T')[0];
    }
    
    document.getElementById('countdown-event-time').value = data.eventTime || '14:00';
    document.getElementById('countdown-event-platform').value = data.eventPlatform || 'zoom';
    document.getElementById('countdown-event-link').value = data.eventLink || '';
    document.getElementById('countdown-event-participants').value = data.participants || 150;
    document.getElementById('countdown-event-color').value = data.themeColor || '#4361ee';
    
    // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨
    const color = data.themeColor || '#4361ee';
    document.querySelectorAll('.color-option').forEach(option => {
        if (option.getAttribute('data-color') === color) {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
    });
}

// ä¿å­˜å€’è®¡æ—¶è®¾ç½®ï¼ˆç®¡ç†å‘˜ï¼‰
let isSavingCountdown = false;

async function saveCountdownSettings(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // é˜²æ­¢é‡å¤æäº¤
    if (isSavingCountdown) {
        showAlert('Saving, please wait...', 'info');
        return;
    }
    
    console.log('ä¿å­˜å€’è®¡æ—¶è®¾ç½®...');
    
    if (!isAdmin) {
        showAlert('Administrator permissions are required to save settings.', 'error');
        return;
    }
    
    const eventName = document.getElementById('countdown-event-name').value;
    const eventDescription = document.getElementById('countdown-event-description').value;
    const eventDate = document.getElementById('countdown-event-date').value;
    const eventTime = document.getElementById('countdown-event-time').value;
    const eventPlatform = document.getElementById('countdown-event-platform').value;
    const eventLink = document.getElementById('countdown-event-link').value;
    const participants = parseInt(document.getElementById('countdown-event-participants').value) || 0;
    const themeColor = document.getElementById('countdown-event-color').value;
    
    // è¡¨å•éªŒè¯
    if (!eventName || !eventName.trim()) {
        showAlert('Please provide an event name.', 'error');
        return;
    }
    
    if (!eventDate) {
        showAlert('Please provide an event date.', 'error');
        return;
    }
    
    if (!eventTime) {
        showAlert('Please provide an event time.', 'error');
        return;
    }
    
    isSavingCountdown = true;
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = document.querySelector('#countdown-settings-form button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
        
        // å¤„ç†æ—¥æœŸæ—¶é—´
        const [year, month, day] = eventDate.split('-');
        const [hours, minutes] = eventTime.split(':');
        
        const targetDate = new Date(year, month - 1, day, hours || 0, minutes || 0, 0);
        
        // éªŒè¯æ—¥æœŸ
        if (isNaN(targetDate.getTime())) {
            showAlert('Invalid date and time format.', 'error');
            return;
        }
        
        // åˆ›å»ºå€’è®¡æ—¶æ•°æ®
        const countdownData = {
            eventName: eventName.trim(),
            eventDescription: eventDescription.trim(),
            eventDate: firebase.firestore.Timestamp.fromDate(targetDate),
            eventTime: eventTime,
            eventPlatform: eventPlatform,
            eventLink: eventLink.trim(),
            participants: participants,
            themeColor: themeColor,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.uid,
            isActive: true,
            views: 0,
            reminders: 0
        };
        
        console.log('Save countdown data:', countdownData);
        
        // ä¿å­˜åˆ°Firestore
        await db.collection('countdown').doc('current').set(countdownData, { merge: true });
        
        console.log('Countdown settings saved successfully');
        showAlert('Countdown settings saved', 'success');
        
        // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
        const scrollPosition = window.scrollY;
        
        // æ›´æ–°æ˜¾ç¤º
        updateCountdownDisplay(countdownData);
        updateCountdownPreview(countdownData);
        
        // é‡æ–°å¯åŠ¨å€’è®¡æ—¶è®¡æ—¶å™¨
        if (window.countdownTimer) {
            clearInterval(window.countdownTimer);
        }
        startCountdownTimer(countdownData);
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateCountdownStats();
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // ç­‰å¾…DOMæ›´æ–°
        setTimeout(() => {
            // åˆ‡æ¢åˆ°æŸ¥çœ‹æ ‡ç­¾é¡µ
            const viewTab = document.querySelector('#countdown-page .tab[data-tab="countdown-view"]');
            if (viewTab) {
                viewTab.click();
            }
            
            // ä¿æŒé¡µé¢æ»šåŠ¨ä½ç½®
            window.scrollTo({
                top: scrollPosition,
                behavior: 'smooth'
            });
            
            // åˆ·æ–°å€’è®¡æ—¶æ•°æ®
            loadCountdownData();
        }, 500);
        
    } catch (error) {
        console.error('Failed to save countdown settings:', error);
        showAlert(`Failed to save countdown settings: ${error.message}`, 'error');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = document.querySelector('#countdown-settings-form button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = 'Save countdown settings';
            submitBtn.disabled = false;
        }
    } finally {
        isSavingCountdown = false;
    }
}

// æ›´æ–°å€’è®¡æ—¶é¢„è§ˆ
function updateCountdownPreview(data) {
    if (!data) return;
    
    const eventDate = data.eventDate?.toDate();
    if (eventDate) {
        const now = new Date();
        const diff = eventDate - now;
        
        if (diff > 0) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.querySelectorAll('.preview-number')[0].textContent = String(days).padStart(2, '0');
            document.querySelectorAll('.preview-number')[1].textContent = String(hours).padStart(2, '0');
            document.querySelectorAll('.preview-number')[2].textContent = String(minutes).padStart(2, '0');
            document.querySelectorAll('.preview-number')[3].textContent = '00';
            
            // æ›´æ–°é¢œè‰²
            if (data.themeColor) {
                document.querySelectorAll('.preview-number').forEach(el => {
                    el.style.color = data.themeColor;
                });
                document.querySelectorAll('.preview-separator').forEach(el => {
                    el.style.color = data.themeColor;
                });
            }
        }
    }
}

// æµ‹è¯•å€’è®¡æ—¶æ˜¾ç¤º
function testCountdown() {
    const eventDate = new Date();
    eventDate.setMinutes(eventDate.getMinutes() + 5); // 5åˆ†é’Ÿå
    
    const testData = {
        eventDate: firebase.firestore.Timestamp.fromDate(eventDate),
        eventTime: 'Test Time',
        themeColor: document.getElementById('countdown-event-color').value
    };
    
    updateCountdownPreview(testData);
    showAlert('Test countdown updated (set to 5 minutes from now).', 'info');
}

// æ¸…é™¤å€’è®¡æ—¶
async function clearCountdown() {
    if (!isAdmin) {
        showAlert('Administrator permissions are required to clear the countdown.', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to clear the current countdown?')) {
        return;
    }
    
    try {
        await db.collection('countdown').doc('current').update({
            isActive: false,
            clearedAt: firebase.firestore.FieldValue.serverTimestamp(),
            clearedBy: currentUser.uid
        });
        
        showAlert('Countdown cleared', 'success');
        
        // é‡æ–°åŠ è½½é¡µé¢
        document.querySelector('#countdown-page .tab[data-tab="countdown-view"]').click();
        loadCountdownData();
        
    } catch (error) {
        console.error('Error clearing countdown:', error);
        showAlert(`Failed to clear countdown: ${error.message}`, 'error');
    }
}

// è®¾ç½®æé†’
async function setReminder() {
    if (!currentUser) {
        showAlert('Please log in first to set reminders.', 'error');
        openModal('login');
        return;
    }
    
    try {
        // è·å–å½“å‰å€’è®¡æ—¶ä¿¡æ¯
        const countdownDoc = await db.collection('countdown').doc('current').get();
        
        if (!countdownDoc.exists || !countdownDoc.data().isActive) {
            showAlert('There are currently no active countdowns.', 'warning');
            return;
        }
        
        const countdownData = countdownDoc.data();
        const eventDate = countdownData.eventDate?.toDate();
        
        if (!eventDate) {
            showAlert('Event time has not been set.', 'error');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®æé†’
        const reminderCheck = await db.collection('reminders')
            .where('userId', '==', currentUser.uid)
            .where('eventId', '==', 'current')
            .get();
        
        if (!reminderCheck.empty) {
            showAlert('You have already set a reminder.', 'info');
            return;
        }
        
        // ä¿å­˜æé†’è®¾ç½®
        await db.collection('reminders').add({
            userId: currentUser.uid,
            userName: userName.textContent,
            userEmail: currentUser.email,
            eventId: 'current',
            eventName: countdownData.eventName,
            eventDate: countdownData.eventDate,
            eventTime: countdownData.eventTime,
            reminderTime: new Date(eventDate.getTime() - (24 * 60 * 60 * 1000)), // æå‰24å°æ—¶æé†’
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            notified: false
        });
        
        // æ›´æ–°å€’è®¡æ—¶ç»Ÿè®¡
        await db.collection('countdown').doc('current').update({
            reminders: firebase.firestore.FieldValue.increment(1)
        });
        
        showAlert('Reminder set successfully! A notification will be sent the day before the event.', 'success');
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        updateCountdownStats();
        
    } catch (error) {
        console.error('Error setting reminder:', error);
        showAlert(`Failed to set reminder: ${error.message}`, 'error');
    }
}

// åˆ†äº«å€’è®¡æ—¶
function shareCountdown() {
    const eventTitle = document.getElementById('countdown-event-title').textContent;
    const eventDate = document.getElementById('event-date-time').textContent;
    const currentUrl = window.location.href.split('#')[0] + '#countdown';
    
    const shareText = `${eventTitle} Countdown\nEvent Time: ${eventDate}\nView Countdown: ${currentUrl}`;
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(shareText).then(() => {
        showAlert('Countdown link copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        
        // å¤‡ç”¨æ–¹æ³•ï¼šæ˜¾ç¤ºåˆ†äº«å¯¹è¯æ¡†
        const shareData = {
            title: `${eventTitle} Countdown`,
            text: `Event Time: ${eventDate}`,
            url: currentUrl
        };
        
        if (navigator.share) {
            navigator.share(shareData).catch(console.error);
        } else {
            showAlert('Please copy the link manually.', 'info');
        }
    });
}

// æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…
function viewEventDetails() {
    // è¿™é‡Œå¯ä»¥æ‰©å±•æ˜¾ç¤ºæ›´å¤šæ´»åŠ¨è¯¦æƒ…
    const eventTitle = document.getElementById('countdown-event-title').textContent;
    const eventDate = document.getElementById('event-date-time').textContent;
    const eventPlatform = document.getElementById('event-platform').textContent;
    const participants = document.getElementById('event-participants').textContent;
    
    const details = `
        <div style="text-align: left;">
            <h4>${eventTitle}</h4>
            <p><strong>Event Time:</strong> ${eventDate}</p>
            <p><strong>Event Platform:</strong> ${eventPlatform}</p>
            <p><strong>Estimated Participants:</strong> ${participants}</p>
            <hr>
            <p style="color: var(--gray);">More details will be announced as the event approaches.</p>
        </div>
    `;
    
    showAlert(details, 'info');
}

// æ›´æ–°å€’è®¡æ—¶ç»Ÿè®¡
async function updateCountdownStats() {
    try {
        const countdownDoc = await db.collection('countdown').doc('current').get();
        
        if (countdownDoc.exists) {
            const data = countdownDoc.data();
            
            // æ›´æ–°æŸ¥çœ‹æ¬¡æ•°
            const newViews = (data.views || 0) + 1;
            document.getElementById('total-views').textContent = newViews.toLocaleString();
            
            // æ›´æ–°æé†’æ•°é‡
            document.getElementById('active-reminders').textContent = (data.reminders || 0).toLocaleString();
            
            // æ›´æ–°å‰©ä½™å¤©æ•°
            const eventDate = data.eventDate?.toDate();
            if (eventDate) {
                const now = new Date();
                const diff = eventDate - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                document.getElementById('days-remaining').textContent = days > 0 ? days : 'Started';
            }
            
            // æ›´æ–°æŸ¥çœ‹æ¬¡æ•°åˆ°æ•°æ®åº“ï¼ˆå»é‡é€»è¾‘å¯ä»¥åœ¨äº‘å‡½æ•°ä¸­å®ç°ï¼‰
            await db.collection('countdown').doc('current').update({
                views: firebase.firestore.FieldValue.increment(1)
            });
        }
    } catch (error) {
        console.error('Error updating countdown stats:', error);
    }
}

// åŠ è½½è¿‡å¾€æ´»åŠ¨
async function loadPastEvents() {
    try {
        const pastEventsList = document.getElementById('past-events-list');
        if (!pastEventsList) return;
        
        // è·å–è¿‡å¾€æ´»åŠ¨ï¼ˆæœ€è¿‘5ä¸ªï¼‰
        const pastEventsSnapshot = await db.collection('countdownHistory')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();
        
        if (pastEventsSnapshot.empty) {
            pastEventsList.innerHTML = '<p style="color: var(--gray); text-align: center;">No past events found.</p>';
            return;
        }
        
        let html = '<div class="event-history">';
        
        pastEventsSnapshot.forEach(doc => {
            const event = doc.data();
            const eventDate = event.eventDate?.toDate();
            const now = new Date();
            
            html += `
                <div class="history-item">
                    <div>
                        <div class="history-date">${formatDate(eventDate)}</div>
                        <div class="history-title">${event.eventName}</div>
                    </div>
                    <div class="history-status ${eventDate > now ? 'status-upcoming' : 'status-completed'}">
                        ${eventDate > now ? 'Starting soon' : 'Completed'}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        pastEventsList.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading past events:', error);
        document.getElementById('past-events-section').style.display = 'none';
    }
}

    
    // Modal controls
    function openModal(modalId) {
        let modal;
        
        if (typeof modalId === 'string') {
            modal = document.getElementById(modalId) || modals[modalId];
        } else if (modalId.target) {
            // å¤„ç†ç‚¹å‡»äº‹ä»¶
            modalId.preventDefault();
            modal = document.getElementById(modalId.target.getAttribute('data-target'));
        }
        
        if (modal) {
            // å…³é—­æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†
            document.querySelectorAll('.modal.active').forEach(m => {
                m.classList.remove('active');
            });
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // è‡ªåŠ¨èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            const firstInput = modal.querySelector('input, textarea, select');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }
    }
    
function closeModal(modalId) {
    console.log('Closing modal:', modalId); // è°ƒè¯•ä¿¡æ¯
    
    // æ”¯æŒç›´æ¥ä¼ å…¥IDæˆ–äº‹ä»¶å¯¹è±¡
    if (modalId && modalId.preventDefault) {
        modalId.preventDefault();
        const target = modalId.target.closest('[data-modal]');
        modalId = target ? target.getAttribute('data-modal') : null;
    }
    
    if (!modalId) {
        console.error('No modal ID provided');
        return;
    }
    
    let modal;
    
    // æŸ¥æ‰¾æ¨¡æ€æ¡†
    if (typeof modalId === 'string') {
        // å¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²ID
        modal = document.getElementById(modalId);
        if (!modal) {
            // å°è¯•é€šè¿‡ç®€å†™åç§°æŸ¥æ‰¾
            const modalKey = modalId.replace('-modal', '');
            modal = modals[modalKey];
        }
    }
    
    if (!modal) {
        console.error('Modal not found:', modalId);
        return;
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
    
    // é‡ç½®è¡¨å•
    const form = modal.querySelector('form');
    if (form) {
        form.reset();
    }
    
    // ç‰¹æ®Šå¤„ç† - æ¸…é™¤å›¾ç‰‡é¢„è§ˆç­‰
    switch(modalId) {
        case 'add-note-modal':
        case 'edit-note-modal':
            const imagePreview = document.getElementById('image-preview');
            const editImagePreview = document.getElementById('edit-image-preview');
            if (imagePreview) imagePreview.style.display = 'none';
            if (editImagePreview) editImagePreview.style.display = 'none';
            break;
    }
}
    
    // Authentication
    function initAuthStateListener() {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                updateUIForUser(user);
                loadUserData(user.uid);
            } else {
                currentUser = null;
                updateUIForGuest();
            }
        });
    }
    
    async function loadUserData(userId) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                updateUserUI(userData);
            } else {
                // Create user document if it doesn't exist
                await db.collection('users').doc(userId).set({
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    school: '',
                    grade: '',
                    role: 'student',
                    interests: [],
                    bio: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                updateUserUI({
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    school: '',
                    grade: '',
                    role: 'student',
                    interests: [],
                    bio: ''
                });
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            showAlert('Failed to load user data. Please refresh the page and try again.', 'error');
        }
    }
    
    function updateUserUI(userData) {
        isAdmin = userData.role === 'admin';
        
        // Update UI based on role
        if (isAdmin) {
            adminMenu.style.display = 'block';
        } else {
            adminMenu.style.display = 'none';
            if (currentPage === 'admin') {
                navigateTo('dashboard');
            }
        }
        
        // Update user info
        userName.textContent = userData.name || (currentUser ? currentUser.email.split('@')[0] : 'User');
        userRole.textContent = userData.role === 'admin' ? 'Administrator' : 'Student';
        
        // Update avatar
        const firstChar = userName.textContent.charAt(0).toUpperCase();
        userAvatar.textContent = firstChar;
        document.getElementById('profile-avatar').textContent = firstChar;
        
        // Update profile page
        document.getElementById('profile-name').textContent = userData.name || 'Not set';
        document.getElementById('profile-school').textContent = `School: ${userData.school === 'fyhs' ? 'Foon Yew High School' : userData.school === 'kshs' ? 'Kaohsiung Senior High School' : 'Not set'}`;
        document.getElementById('profile-grade').textContent = `Grade: ${userData.grade || 'Not set'}`;
        document.getElementById('profile-email').textContent = `Email: ${currentUser ? currentUser.email : 'Not set'}`;
        
        // Update profile form
        document.getElementById('edit-name').value = userData.name || '';
        document.getElementById('edit-school').value = userData.school || '';
        document.getElementById('edit-grade').value = userData.grade || '';
        document.getElementById('edit-interests').value = userData.interests ? userData.interests.join(', ') : '';
        document.getElementById('edit-bio').value = userData.bio || '';

            isAdmin = userData.role === 'admin';
    window.isAdmin = isAdmin; // è®¾ä¸ºå…¨å±€å˜é‡
    
    // æ˜¾ç¤º/éšè—ç®¡ç†å‘˜æ§åˆ¶æŒ‰é’®
    const adminLinkControls = document.getElementById('admin-link-controls');
    if (adminLinkControls) {
        adminLinkControls.style.display = isAdmin ? 'block' : 'none';
    }
    
    // é‡æ–°æ¸²æŸ“é“¾æ¥ï¼ˆæ˜¾ç¤º/éšè—ç¼–è¾‘æŒ‰é’®ï¼‰
    if (currentPage === 'wall') {
        renderExchangeLinks();
    }
        // Enable add note button for non-admin users
        if (!isAdmin) {
            addNoteBtn.disabled = false;
        }
    }
    
     function updateUIForUser(user) {
    authButtons.style.display = 'none';
    userProfile.style.display = 'flex';
    
    // å¯ç”¨æ‰€æœ‰å¯¼èˆªé“¾æ¥
    navLinks.forEach(link => {
        link.style.pointerEvents = 'auto';
        link.style.opacity = '1';
    });
    
    // ç¡®ä¿æ·»åŠ è´´æ–‡æŒ‰é’®å¯ç”¨
    updateAddNoteButton();
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    if (user.displayName || user.email) {
        const name = user.displayName || user.email.split('@')[0];
        userName.textContent = name;
        const firstChar = name.charAt(0).toUpperCase();
        userAvatar.textContent = firstChar;
        document.getElementById('profile-avatar').textContent = firstChar;
    }
}
    
    function updateUIForGuest() {
    authButtons.style.display = 'block';
    userProfile.style.display = 'none';
    adminMenu.style.display = 'none';
    
    // ç¦ç”¨éœ€è¦ç™»å½•çš„å¯¼èˆªé“¾æ¥
    navLinks.forEach(link => {
        if (link.getAttribute('data-page') !== 'dashboard') {
            link.style.pointerEvents = 'none';
            link.style.opacity = '0.6';
        }
    });
    
    // ç¦ç”¨æ·»åŠ è´´æ–‡æŒ‰é’®
    updateAddNoteButton();
    
    // å¦‚æœåœ¨å—é™é¡µé¢ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
    if (currentPage !== 'dashboard') {
        navigateTo('dashboard');
    }
}
    
    async function handleLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            
            // Update last login time
            await db.collection('users').doc(userCredential.user.uid).update({
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeModal('login');
            showAlert('Login successfully', 'success');
        } catch (error) {
            showAlert(`Failed to login: ${error.message}`, 'error');
        }
    }
    
    async function handleRegister(e) {
        e.preventDefault();
        
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        const school = document.getElementById('register-school').value;
        const grade = document.getElementById('register-grade').value;
        
        if (password !== confirmPassword) {
            showAlert('The passwords you entered do not match.', 'error');
            return;
        }
        
        if (!school) {
            showAlert('Please choose your affiliated school.', 'error');
            return;
        }
        
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const userId = userCredential.user.uid;
            
            // Save additional user data to Firestore
            await db.collection('users').doc(userId).set({
                name: name,
                email: email,
                school: school,
                grade: grade,
                role: 'student', // Default role
                interests: [],
                bio: '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeModal('register');
            showAlert('Registration successful! Welcome to the communication platform.', 'success');
        } catch (error) {
            showAlert(`Register failed: ${error.message}`, 'error');
        }
    }
    
    async function handleGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        
        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            
            // Check if user already exists in Firestore
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (!userDoc.exists) {
                // Create new user record
                await db.collection('users').doc(user.uid).set({
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    school: '', // User will need to complete profile
                    grade: '',
                    role: 'student',
                    interests: [],
                    bio: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Update last login time
                await db.collection('users').doc(user.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            closeModal('login');
            closeModal('register');
            showAlert('Successfully logged in with Google account.', 'success');
        } catch (error) {
            showAlert(`Failed to logged in with Google account: ${error.message}`, 'error');
        }
    }
    
    async function handleLogout() {
        try {
            await auth.signOut();
            showAlert('Successfully signed out.', 'success');
        } catch (error) {
            showAlert(`Failed to signed out: ${error.message}`, 'error');
        }
    }
    
    // Data Loading Functions
    async function loadDashboardData() {
        // Load recent announcements
        try {
            const announcementsSnapshot = await db.collection('announcements')
                .orderBy('createdAt', 'desc')
                .limit(3)
                .get();
            
            const recentAnnouncements = document.getElementById('recent-announcements');
            if (announcementsSnapshot.empty) {
                recentAnnouncements.innerHTML = '<p>No announcements available.</p>';
            } else {
                let html = '';
                announcementsSnapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                            <strong>${data.title}</strong>
                            <p style="font-size: 0.95rem; margin-top: 8px; color: #555;">${data.content.substring(0, 80)}${data.content.length > 80 ? '...' : ''}</p>
                            <small style="color: #666;">${formatDate(data.createdAt?.toDate())}</small>
                        </div>
                    `;
                });
                recentAnnouncements.innerHTML = html;
            }
        } catch (error) {
            console.error('Error loading announcements:', error);
            document.getElementById('recent-announcements').innerHTML = '<p>Failed to load announcements.</p>';
        }
        
        // Load upcoming events (next 7 days)
        try {
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const eventsSnapshot = await db.collection('events')
                .where('date', '>=', today)
                .where('date', '<=', nextWeek)
                .orderBy('date')
                .limit(3)
                .get();
            
            const upcomingEvents = document.getElementById('upcoming-events');
            if (eventsSnapshot.empty) {
                upcomingEvents.innerHTML = '<p>No upcoming events.</p>';
            } else {
                let html = '';
                eventsSnapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div style="margin-bottom: 12px; padding: 10px; background-color: rgba(44, 90, 160, 0.05); border-radius: 8px;">
                            <strong>${data.title}</strong>
                            <p style="font-size: 0.9rem; margin-top: 5px; color: #555;">${formatDate(data.date?.toDate())} ${data.time || ''}</p>
                        </div>
                    `;
                });
                upcomingEvents.innerHTML = html;
            }
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('upcoming-events').innerHTML = '<p>Failed to load events.</p>';
        }
        
        // Update statistics
        try {
            // Get total users count
            const usersSnapshot = await db.collection('users').get();
            const totalUsers = usersSnapshot.size;
            
            // Get total posts count
            const postsSnapshot = await db.collection('wallPosts').get();
            const totalPosts = postsSnapshot.size;
            
            // Get total events count
            const eventsSnapshot = await db.collection('events').get();
            const totalEvents = eventsSnapshot.size;
            
            // Update statistics display
            document.getElementById('total-participants').textContent = totalUsers;
            document.getElementById('total-posts').textContent = totalPosts;
            document.getElementById('total-events').textContent = totalEvents;
            
            // Online users is estimated (users active in last 15 minutes)
            const activeTime = new Date(Date.now() - 15 * 60 * 1000);
            const activeUsersQuery = await db.collection('users')
                .where('lastLogin', '>=', activeTime)
                .get();
            
            document.getElementById('online-users').textContent = activeUsersQuery.size;
            
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }
    
  async function loadAnnouncements() {
    const announcementsList = document.getElementById('announcements-list');
    
    // Show loading
    announcementsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading announcements...</p></div>';
    
    try {
        // Check if we have demo data
        if (window.demoAnnouncements) {
            let html = '';
            window.demoAnnouncements.forEach((announcement, index) => {
                const announcementId = 'announcement-' + index;
                const canEdit = window.isAdmin || (currentUser && currentUser.email === announcement.authorEmail);
                
                html += `
                    <div class="announcement-item" data-id="${announcementId}">
                        <div class="announcement-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${announcement.title}</h4>
                            ${canEdit ? `
                                <div class="announcement-actions" style="display: flex; gap: 8px;">
                                    <button class="btn btn-icon btn-small edit-announcement-btn" title="Edit" data-id="${announcementId}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-icon btn-small delete-announcement-btn" title="Delete" style="color: var(--danger);" data-id="${announcementId}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="announcement-content">${announcement.content}</div>
                        <div class="announcement-meta">
                            <span>By: ${announcement.authorName}</span>
                            <span>${formatDate(announcement.createdAt)}</span>
                        </div>
                    </div>
                `;
            });
            announcementsList.innerHTML = html;
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-announcement-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const announcementId = this.getAttribute('data-id');
                    editAnnouncement(announcementId);
                });
            });
            
            document.querySelectorAll('.delete-announcement-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const announcementId = this.getAttribute('data-id');
                    deleteAnnouncement(announcementId);
                });
            });
        } else if (db) {
            // Similar logic for Firebase data
            const announcementsSnapshot = await db.collection('announcements')
                .orderBy('createdAt', 'desc')
                .get();
            
            if (announcementsSnapshot.empty) {
                announcementsList.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No announcements yet</p></div>';
            } else {
                let html = '';
                announcementsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const announcementId = doc.id;
                    const canEdit = window.isAdmin || (currentUser && currentUser.uid === data.authorId);
                    
                    html += `
                        <div class="announcement-item" data-id="${announcementId}">
                            <div class="announcement-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <h4>${data.title}</h4>
                                ${canEdit ? `
                                    <div class="announcement-actions" style="display: flex; gap: 8px;">
                                        <button class="btn btn-icon btn-small edit-announcement-btn" title="Edit" data-id="${announcementId}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-icon btn-small delete-announcement-btn" title="Delete" style="color: var(--danger);" data-id="${announcementId}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="announcement-content">${data.content}</div>
                            <div class="announcement-meta">
                                <span>By: ${data.authorName || 'Admin'}</span>
                                <span>${formatDate(data.createdAt?.toDate())}</span>
                            </div>
                        </div>
                    `;
                });
                announcementsList.innerHTML = html;
                
                // Add event listeners
                document.querySelectorAll('.edit-announcement-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const announcementId = this.getAttribute('data-id');
                        editAnnouncement(announcementId);
                    });
                });
                
                document.querySelectorAll('.delete-announcement-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const announcementId = this.getAttribute('data-id');
                        deleteAnnouncement(announcementId);
                    });
                });
            }
        } else {
            announcementsList.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>Cannot load announcements</p></div>';
        }
    } catch (error) {
        console.error('Error loading announcements:', error);
        announcementsList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading announcements</p></div>';
    }
}

       async function deleteWallPost(postId) {
    try {
        const postDoc = await db.collection('wallPosts').doc(postId).get();
        const postData = postDoc.data();
        
        if (!isAdmin && postData.authorId !== currentUser?.uid) {
            showAlert('You do not have permission to delete this post.', 'error');
            return;
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´´æ–‡å—ï¼Ÿå›¾ç‰‡ä¹Ÿå°†è¢«åˆ é™¤ã€‚')) {
            return;
        }
        
        // å…ˆåˆ é™¤Firestoreæ–‡æ¡£
        await db.collection('wallPosts').doc(postId).delete();
        
        // å¦‚æœCloud Functionå·²è®¾ç½®ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ é™¤Cloudinaryå›¾ç‰‡
        // å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåªæ˜¯è®°å½•è­¦å‘Š
        if (postData.imageData && postData.imageData.publicId) {
            console.log('æç¤ºï¼šè¯·è®¾ç½®Cloud Functionæ¥è‡ªåŠ¨åˆ é™¤Cloudinaryå›¾ç‰‡');
            console.log('å¾…åˆ é™¤çš„å›¾ç‰‡ID:', postData.imageData.publicId);
            
            // å¯é€‰ï¼šæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            showAlert('è´´æ–‡å·²åˆ é™¤ï¼Œä½†å›¾ç‰‡å¯èƒ½ä»åœ¨Cloudinaryä¸­ã€‚è¯·ç®¡ç†å‘˜åœ¨åå°æ‰‹åŠ¨æ¸…ç†ã€‚', 'warning');
        } else {
            showAlert('Post deleted successfully.', 'success');
        }
        
        // ä»DOMç§»é™¤
        const postElement = document.querySelector(`[data-id="${postId}"]`);
        if (postElement) postElement.remove();
        
        // æ›´æ–°ç»Ÿè®¡
        loadDashboardData();
        if (isAdmin) loadAdminData();
        
    } catch (error) {
        console.error('Error deleting post:', error);
        showAlert(`Failed to delete post: ${error.message}`, 'error');
    }
}

    
async function loadWallPosts() {
    console.log('Loading wall posts...');
    
    const padletWall = document.getElementById('padlet-wall');
    
    // æ·»åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
    if (!padletWall) {
        console.error('padlet-wall element not found');
        // å°è¯•é‡æ–°æŸ¥æ‰¾
        setTimeout(() => {
            const retryElement = document.getElementById('padlet-wall');
            if (retryElement) {
                loadWallPosts();
            }
        }, 100);
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    padletWall.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading communication wall...</p></div>';
    
    try {
        const postsSnapshot = await db.collection('wallPosts')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        if (postsSnapshot.empty) {
            // å®‰å…¨æ›´æ–°å†…å®¹
            if (padletWall && padletWall.parentNode) {
                padletWall.innerHTML = `
                    <div class="add-note-btn" id="empty-wall-add-btn">
                        <i class="fas fa-plus-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.2rem; font-weight: 600;">Add your first post</p>
                        <p style="font-size: 0.9rem; opacity: 0.7;">Share your thoughts...</p>
                    </div>
                `;
                
                // å»¶è¿Ÿç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    const emptyBtn = document.getElementById('empty-wall-add-btn');
                    if (emptyBtn) {
                        emptyBtn.onclick = () => {
                            if (!currentUser) {
                                showAlert('Please log in to add a post.', 'error');
                                openModal('login');
                                return;
                            }
                            openModal('add-note-modal');
                        };
                    }
                }, 50);
            }
        } else {
            let html = '';
            let index = 0;
            postsSnapshot.forEach(doc => {
                const data = doc.data();
                const noteColorClass = `note-${data.color || 'yellow'}`;
                const canEdit = isAdmin || currentUser?.uid === data.authorId;
                const postId = doc.id;
                
                // å®‰å…¨å¤„ç†æ•°æ®
                const safeTitle = data.title ? escapeHTML(data.title) : '';
                const safeContent = escapeHTML(data.content || '');
                const safeAuthorName = escapeHTML(data.authorName || 'Anonymous User');
                
                html += `
                    <div class="padlet-note ${noteColorClass} draggable" data-id="${postId}" draggable="true">
                        ${canEdit ? `
                            <div class="note-actions">
                                <button class="note-btn edit-note" title="Edit" data-note-id="${postId}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="note-btn delete-note" title="Delete" data-note-id="${postId}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                        ${safeTitle ? `<div class="note-title">${safeTitle}</div>` : ''}
                        <div class="note-content">${safeContent}</div>
                        ${data.imageUrl ? `<img src="${data.imageUrl}" alt="Post Image" class="note-image" loading="lazy">` : ''}
                        <div class="note-meta">
                            <span><i class="fas fa-user"></i> ${safeAuthorName}</span>
                            <span><i class="fas fa-clock"></i> ${formatDate(data.createdAt?.toDate())}</span>
                            ${data.updatedAt ? `<span><i class="fas fa-edit"></i> Edited on ${formatDate(data.updatedAt?.toDate())}</span>` : ''}
                        </div>
                    </div>
                `;
                index++;
            });
            
            // æ·»åŠ "æ·»åŠ è´´æ–‡"æŒ‰é’®
            html += `
                <div class="add-note-btn" id="wall-add-btn">
                    <i class="fas fa-plus-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.2rem; font-weight: 600;">Add Post</p>
                    <p style="font-size: 0.9rem; opacity: 0.7;">Share your thoughts...</p>
                </div>
            `;
            
            // å®‰å…¨æ›´æ–°DOM
            if (padletWall && padletWall.parentNode) {
                padletWall.innerHTML = html;
                
                // å»¶è¿Ÿç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    // ç»‘å®šæ·»åŠ æŒ‰é’®äº‹ä»¶
                    const addBtn = document.getElementById('wall-add-btn');
                    if (addBtn) {
                        addBtn.onclick = () => {
                            if (!currentUser) {
                                showAlert('Please log in to add a post.', 'error');
                                openModal('login');
                                return;
                            }
                            openModal('add-note-modal');
                        };
                    }
                    
                    // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.edit-note').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const noteId = this.getAttribute('data-note-id');
                            if (noteId) {
                                openEditNoteModalById(noteId);
                            }
                        });
                    });
                    
                    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.delete-note').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const noteId = this.getAttribute('data-note-id');
                            if (noteId) {
                                if (confirm('Are you sure you want to delete this post?')) {
                                    deleteWallPost(noteId);
                                }
                            }
                        });
                    });
                    
                    // æ›´æ–°é¡¶éƒ¨çš„æ·»åŠ è´´æ–‡æŒ‰é’®çŠ¶æ€
                    updateAddNoteButton();
                    
                }, 50);
                
                // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                initDragAndDrop();
            }
        }
    } catch (error) {
        console.error('Error loading wall posts:', error);
        
        // å®‰å…¨æ˜¾ç¤ºé”™è¯¯
        if (padletWall && padletWall.parentNode) {
            padletWall.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading posts</p>
                    <button class="btn btn-outline" onclick="safeReloadWallPosts()" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }
}

// å®‰å…¨é‡æ–°åŠ è½½å‡½æ•°
function safeReloadWallPosts() {
    // æ£€æŸ¥é¡µé¢æ˜¯å¦å¤„äºwallé¡µé¢
    if (document.getElementById('wall-page') && document.getElementById('wall-page').classList.contains('active')) {
        loadWallPosts();
    }
}

// é€šè¿‡IDæ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
async function openEditNoteModalById(noteId) {
    try {
        const noteDoc = await db.collection('wallPosts').doc(noteId).get();
        if (noteDoc.exists) {
            const noteData = noteDoc.data();
            openEditNoteModal(noteId, noteData);
        } else {
            showAlert('Post not found', 'error');
        }
    } catch (error) {
        console.error('Error loading note for editing:', error);
        showAlert('Error loading post for editing', 'error');
    }
}
       function escapeHTML(text) {
    if (!text) return '';
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

       // å¤„ç†åˆ é™¤è´´æ–‡
function handleDeleteNote(noteId) {
    if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        deleteWallPost(noteId);
    }
}

// ä¿®å¤ï¼šç¡®ä¿æ·»åŠ è´´æ–‡æŒ‰é’®å§‹ç»ˆå¯ç”¨
function updateAddNoteButton() {
    const addNoteBtn = document.getElementById('add-note-btn');
    if (addNoteBtn) {
        if (currentUser) {
            addNoteBtn.disabled = false;
            addNoteBtn.innerHTML = '<i class="fas fa-plus"></i> Add Post';
            addNoteBtn.onclick = () => {
                openModal('add-note-modal');
            };
        } else {
            addNoteBtn.disabled = true;
            addNoteBtn.innerHTML = '<i class="fas fa-plus"></i> Log in to add';
            addNoteBtn.onclick = null;
        }
    }
}
       
    function initDragAndDrop() {
        const draggables = document.querySelectorAll('.draggable');
        const container = document.getElementById('padlet-wall');
        
        if (!container) return;
        
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('dragging');
            });
            
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
            });
        });
        
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
        });
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

       // æ·»åŠ è¾…åŠ©å‡½æ•°æ¥å¤„ç†æ—¥æœŸæ—¶åŒº
function toLocalDate(date) {
    if (!date) return null;
    
    // å¦‚æœæ˜¯ä» Firestore è·å–çš„æ—¶é—´æˆ³
    if (typeof date.toDate === 'function') {
        date = date.toDate();
    }
    
    // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
    return new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
}

function formatLocalDate(date) {
    const localDate = toLocalDate(date);
    if (!localDate) return 'Unknown Date';
    
    const year = localDate.getFullYear();
    const month = String(localDate.getMonth() + 1).padStart(2, '0');
    const day = String(localDate.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}
    
    function generateCalendar(date) {
        const calendar = document.getElementById('calendar');
        if (!calendar) return;
        
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        // Update month display
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const monthDisplay = document.getElementById('current-month');
        if (monthDisplay) {
            monthDisplay.textContent = `${date.getFullYear()} ${monthNames[date.getMonth()]}`;
        }
        
        // Get first day of month
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        // Get last day of month
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        // Calculate days in month
        const daysInMonth = lastDay.getDate();
        // Calculate day of week for first day (0 = Sunday, 1 = Monday, etc.)
        const firstDayOfWeek = firstDay.getDay();
        
        // Create header
        let html = '';
        daysOfWeek.forEach(day => {
            html += `<div class="calendar-day header">${day}</div>`;
        });
        
        // Add empty cells for days before first day of month
        for (let i = 0; i < firstDayOfWeek; i++) {
            html += `<div class="calendar-day"></div>`;
        }
        
        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDate = new Date(date.getFullYear(), date.getMonth(), day);
            const isToday = isSameDay(dayDate, new Date());
            
            html += `
                <div class="calendar-day" data-date="${dayDate.toISOString().split('T')[0]}">
                    <div class="day-number" style="${isToday ? 'color: var(--primary); font-weight: bold;' : ''}">${day}</div>
                    <div id="events-${dayDate.toISOString().split('T')[0]}"></div>
                    ${currentUser ? `<button class="add-event-btn" data-date="${dayDate.toISOString().split('T')[0]}"><i class="fas fa-plus"></i></button>` : ''}
                </div>
            `;
        }
        
        calendar.innerHTML = html;
        
        // Add event listeners to add event buttons
        document.querySelectorAll('.add-event-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const date = this.getAttribute('data-date');
                document.getElementById('event-date').value = date;
                document.querySelector('[data-tab="add-event"]').click();
            });
        });
    }
    
    async function loadCalendarEvents() {
        const calendarDays = document.querySelectorAll('.calendar-day[data-date]');
        
        // Clear existing events
        calendarDays.forEach(day => {
            const eventContainer = day.querySelector('div[id^="events-"]');
            if (eventContainer) {
                eventContainer.innerHTML = '';
            }
        });
        
        try {
            // Get first and last day of current month view
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            
            const eventsSnapshot = await db.collection('events')
                .where('date', '>=', firstDay)
                .where('date', '<=', lastDay)
                .orderBy('date')
                .get();
            
            eventsSnapshot.forEach(doc => {
                const data = doc.data();
                const date = data.date?.toDate();
                if (date) {
                    const dateString = date.toISOString().split('T')[0];
                    const eventContainer = document.getElementById(`events-${dateString}`);
                    
                    if (eventContainer) {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'calendar-event';
                        eventElement.textContent = data.title;
                        eventElement.setAttribute('data-id', doc.id);
                        eventElement.addEventListener('click', () => showEventDetail(doc.id, data));
                        
                        eventContainer.appendChild(eventElement);
                    }
                }
            });
        } catch (error) {
            console.error('Error loading calendar events:', error);
        }
    }
    
   async function loadAdminData() {
    try {
        // Get total users count
        const usersSnapshot = await db.collection('users').get();
        const totalUsers = usersSnapshot.size;
        
        // Get users active today
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const activeUsersQuery = await db.collection('users')
            .where('lastLogin', '>=', today)
            .get();
        
        // Get total announcements count
        const announcementsSnapshot = await db.collection('announcements').get();
        
        // Get total posts count
        const postsSnapshot = await db.collection('wallPosts').get();
        
        // Get total events count
        const eventsSnapshot = await db.collection('events').get();
        
        // æ–°å¢ï¼šè·å–å€’è®¡æ—¶ç»Ÿè®¡æ•°æ®
        const countdownData = await getCountdownAdminStats();
        await loadPlatformSettings();
        // Update admin statistics
        document.getElementById('admin-total-users').textContent = totalUsers;
        document.getElementById('admin-active-today').textContent = activeUsersQuery.size;
        document.getElementById('admin-total-announcements').textContent = announcementsSnapshot.size;
        document.getElementById('admin-total-posts').textContent = postsSnapshot.size;
        document.getElementById('admin-total-events').textContent = eventsSnapshot.size;
        
        // æ–°å¢ï¼šæ›´æ–°å€’è®¡æ—¶ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚æœç›¸å…³å…ƒç´ å­˜åœ¨ï¼‰
        updateAdminCountdownStats(countdownData);
        
    } catch (error) {
        console.error('Error loading admin data:', error);
        showAlert('åŠ è½½ç®¡ç†å‘˜æ•°æ®æ—¶å‡ºé”™', 'error');
    }
}

       function validateFormData(data) {
    const validated = {};
    
    for (const [key, value] of Object.entries(data)) {
        if (value === undefined || value === null) {
            validated[key] = '';
        } else if (typeof value === 'string') {
            validated[key] = value.trim();
        } else {
            validated[key] = value;
        }
    }
    
    return validated;
}
       

// æ–°å¢ï¼šè·å–å€’è®¡æ—¶ç®¡ç†å‘˜ç»Ÿè®¡æ•°æ®
async function getCountdownAdminStats() {
    try {
        const stats = {
            totalViews: 0,
            activeReminders: 0,
            daysRemaining: 0,
            upcomingEvents: 0,
            pastEvents: 0
        };
        
        // è·å–å½“å‰å€’è®¡æ—¶æ•°æ®
        const countdownDoc = await db.collection('countdown').doc('current').get();
        if (countdownDoc.exists) {
            const countdownData = countdownDoc.data();
            stats.totalViews = countdownData.views || 0;
            stats.activeReminders = countdownData.reminders || 0;
            
            // è®¡ç®—å‰©ä½™å¤©æ•°
            const eventDate = countdownData.eventDate?.toDate();
            if (eventDate) {
                const now = new Date();
                const diff = eventDate - now;
                if (diff > 0) {
                    stats.daysRemaining = Math.floor(diff / (1000 * 60 * 60 * 24));
                }
            }
        }
        
        // è·å–å³å°†åˆ°æ¥çš„æ´»åŠ¨æ•°é‡ï¼ˆæœªæ¥30å¤©å†…ï¼‰
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 30);
        const upcomingSnapshot = await db.collection('countdownHistory')
            .where('eventDate', '>=', firebase.firestore.Timestamp.fromDate(new Date()))
            .where('eventDate', '<=', firebase.firestore.Timestamp.fromDate(futureDate))
            .get();
        stats.upcomingEvents = upcomingSnapshot.size;
        
        // è·å–è¿‡å¾€æ´»åŠ¨æ•°é‡
        const pastSnapshot = await db.collection('countdownHistory')
            .where('eventDate', '<', firebase.firestore.Timestamp.fromDate(new Date()))
            .get();
        stats.pastEvents = pastSnapshot.size;
        
        return stats;
        
    } catch (error) {
        console.error('Error getting countdown stats:', error);
        return null;
    }
}

// æ–°å¢ï¼šæ›´æ–°å€’è®¡æ—¶ç»Ÿè®¡æ•°æ®åˆ°ç®¡ç†å‘˜é¢æ¿
function updateAdminCountdownStats(stats) {
    if (!stats) return;
    
    // æ£€æŸ¥ç®¡ç†å‘˜é¢æ¿æ˜¯å¦æœ‰å€’è®¡æ—¶ç»Ÿè®¡åŒºåŸŸï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
    let statsContainer = document.getElementById('admin-countdown-stats');
    
    if (!statsContainer && document.getElementById('admin-dashboard')) {
        // åˆ›å»ºå€’è®¡æ—¶ç»Ÿè®¡åŒºåŸŸ
        const adminDashboard = document.getElementById('admin-dashboard');
        const dashboardCards = adminDashboard.querySelector('.dashboard-cards');
        
        if (dashboardCards) {
            // åˆ›å»ºå€’è®¡æ—¶ç»Ÿè®¡å¡ç‰‡
            const countdownCard = document.createElement('div');
            countdownCard.className = 'card';
            countdownCard.id = 'countdown-stats-card';
            countdownCard.innerHTML = `
                <div class="card-header">
                    <i class="fas fa-clock"></i>
                    <h3>Countdown Statistics</h3>
                </div>
                <div class="card-body">
                    <div id="admin-countdown-stats">
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="stat-item">
                                <div class="stat-label">Total Views</div>
                                <div class="stat-value" id="admin-countdown-views">${stats.totalViews}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Activity Reminders</div>
                                <div class="stat-value" id="admin-countdown-reminders">${stats.activeReminders}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Days Remaining</div>
                                <div class="stat-value" id="admin-countdown-days">${stats.daysRemaining}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total Activities</div>
                                <div class="stat-value" id="admin-countdown-total">${stats.upcomingEvents + stats.pastEvents}</div>
                            </div>
                        </div>
                        <button class="btn btn-outline btn-small" style="margin-top: 1rem;" onclick="navigateTo('countdown')">
                            Manage Countdown Settings
                        </button>
                    </div>
                </div>
            `;
            
            // æ’å…¥åˆ°ç°æœ‰å¡ç‰‡ä¹‹å
            dashboardCards.appendChild(countdownCard);
            statsContainer = document.getElementById('admin-countdown-stats');
        }
    }
    
    // æ›´æ–°ç»Ÿè®¡æ•°å­—
    if (statsContainer) {
        const elements = {
            'admin-countdown-views': stats.totalViews,
            'admin-countdown-reminders': stats.activeReminders,
            'admin-countdown-days': stats.daysRemaining,
            'admin-countdown-total': stats.upcomingEvents + stats.pastEvents
        };
        
        for (const [id, value] of Object.entries(elements)) {
            const element = document.getElementById(id);
            if (element) {
                // æ·»åŠ æ•°å­—åŠ¨ç”»æ•ˆæœ
                animateNumber(element, value);
            }
        }
    }
}

// æ–°å¢ï¼šæ•°å­—åŠ¨ç”»æ•ˆæœ
function animateNumber(element, targetValue) {
    const currentValue = parseInt(element.textContent) || 0;
    if (currentValue === targetValue) return;
    
    const duration = 1000; // åŠ¨ç”»æŒç»­æ—¶é—´
    const startTime = Date.now();
    const startValue = currentValue;
    
    function update() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        const current = Math.floor(startValue + (targetValue - startValue) * easedProgress);
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

// æ–°å¢ï¼šåœ¨ç®¡ç†å‘˜é¢æ¿çš„ä»ªè¡¨æ¿éƒ¨åˆ†æ·»åŠ æ›´å¤šç»Ÿè®¡ä¿¡æ¯
function enhanceAdminDashboard() {
    // å½“ç®¡ç†å‘˜é¡µé¢åŠ è½½æ—¶è°ƒç”¨
    if (currentPage === 'admin') {
        setTimeout(() => {
            updateAdminDashboardWithCountdown();
        }, 1000);
    }
}

// æ–°å¢ï¼šæ›´æ–°ç®¡ç†å‘˜é¢æ¿
async function updateAdminDashboardWithCountdown() {
    try {
        // è·å–æœ€æ–°çš„å€’è®¡æ—¶ä¿¡æ¯
        const countdownDoc = await db.collection('countdown').doc('current').get();
        if (countdownDoc.exists) {
            const countdownData = countdownDoc.data();
            
            // åœ¨ç®¡ç†å‘˜é¢æ¿é¡¶éƒ¨æ˜¾ç¤ºå€’è®¡æ—¶æ‘˜è¦
            const adminDashboard = document.getElementById('admin-dashboard');
            const existingSummary = document.getElementById('countdown-summary');
            
            if (!existingSummary && adminDashboard) {
                const eventDate = countdownData.eventDate?.toDate();
                let dateStr = '';
                if (eventDate) {
                    dateStr = eventDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                }
                
                const summary = document.createElement('div');
                summary.id = 'countdown-summary';
                summary.className = 'alert alert-info';
                summary.style.margin = '1rem 0 2rem 0';
                summary.style.padding = '1.5rem';
                summary.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0;">Current Event Countdown</h4>
                            <p style="margin: 0; color: var(--dark);">
                                <strong>${countdownData.eventName || 'Online Exchange Meeting'}</strong> - 
                                ${dateStr} ${countdownData.eventTime || '14:00'}
                            </p>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="navigateTo('countdown')">
                            View Details
                        </button>
                    </div>
                `;
                
                // æ’å…¥åˆ°é¡µé¢æ ‡é¢˜ä¹‹å
                const pageHeader = adminDashboard.querySelector('.page-header');
                if (pageHeader) {
                    pageHeader.parentNode.insertBefore(summary, pageHeader.nextSibling);
                }
            }
        }
    } catch (error) {
        console.error('Error updating admin dashboard:', error);
    }
}
    
    async function loadUserManagement() {
        const userManagement = document.getElementById('user-management');
        userManagement.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading user data...</p></div>';
        
        try {
            const usersSnapshot = await db.collection('users').get();
            
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
            html += `
                <thead>
                    <tr>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--light-gray);">Name</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--light-gray);">Email</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--light-gray);">School</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--light-gray);">Role</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--light-gray);">Action</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                
                html += `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">${user.name}</td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">${user.email}</td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">${user.school === 'fyhs' ? 'Foon Yew High School' : user.school === 'kshs' ? 'Kaohsiung Senior High School' : user.school || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">
                            <span class="badge ${user.role === 'admin' ? 'badge-primary' : ''}">${user.role === 'admin' ? 'Admin' : 'Student'}</span>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">
                            ${userId !== currentUser?.uid ? `
                                <button class="btn btn-small btn-outline" onclick="changeUserRole('${userId}', '${user.role}')" style="margin-right: 5px;">
                                    ${user.role === 'admin' ? 'Remove Administrator' : 'Set as Admin'}
                                </button>
                                <button class="btn btn-small btn-outline" onclick="deleteUser('${userId}')" style="color: var(--danger); border-color: var(--danger);">
                                    Delete
                                </button>
                            ` : '<span>Current User</span>'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            userManagement.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading user management:', error);
            userManagement.innerHTML = '<p>Error loading user data.</p>';
        }
    }
    
    async function loadAdminContent() {
        // Load wall posts for management
        const adminWallPosts = document.getElementById('admin-wall-posts');
        adminWallPosts.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading posts...</p></div>';
        
        try {
            const postsSnapshot = await db.collection('wallPosts')
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get();
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            
            postsSnapshot.forEach(doc => {
                const post = doc.data();
                const postId = doc.id;
                
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid var(--light-gray);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <strong>${post.title || 'No Title'}</strong>
                                <div style="font-size: 0.95rem; margin: 8px 0; color: #555;">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    Author: ${post.authorName} | ${formatDate(post.createdAt?.toDate())}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-small" style="background-color: #dc3545; color: white; border: none; margin-left: 5px;" onclick="safeDeleteWallPost('${postId}', true)">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            adminWallPosts.innerHTML = html;
            
            // Load events for management
            const adminEvents = document.getElementById('admin-events');
            adminEvents.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading activities...</p></div>';
            
            const eventsSnapshot = await db.collection('events')
                .orderBy('date', 'desc')
                .limit(10)
                .get();
            
            let eventsHtml = '<div style="max-height: 300px; overflow-y: auto;">';
            
            eventsSnapshot.forEach(doc => {
                const event = doc.data();
                const eventId = doc.id;
                
                eventsHtml += `
                    <div style="padding: 12px; border-bottom: 1px solid var(--light-gray);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <strong>${event.title}</strong>
                                <div style="font-size: 0.95rem; margin: 8px 0; color: #555;">${event.description ? event.description.substring(0, 100) + (event.description.length > 100 ? '...' : '') : 'æ— æè¿°'}</div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    æ—¥æœŸ: ${formatDate(event.date?.toDate())}
                                </div>
                            </div>
                            <div>
<button class="btn btn-small btn-outline" style="margin-left: 5px;" onclick="deleteEvent('${eventId}', true)">
    Delete
</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            eventsHtml += '</div>';
            adminEvents.innerHTML = eventsHtml;
            
        } catch (error) {
            console.error('Error loading admin content:', error);
            adminWallPosts.innerHTML = '<p>Something went wrong while loading posts. Please try again.</p>';
            adminEvents.innerHTML = '<p>Something went wrong while loading events. Please try again.</p>';
        }
    }
    
    // Form Handlers
 async function handleAddNote(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showAlert('è¯·å…ˆç™»å½•', 'error');
        return;
    }
    
    const title = document.getElementById('note-title').value;
    const content = document.getElementById('note-content').value;
    const color = document.getElementById('note-color-value').value;
    const imageFile = document.getElementById('note-image').files[0];
    
    if (!content.trim()) {
        showAlert('è¯·è¾“å…¥è´´æ–‡å†…å®¹', 'error');
        return;
    }
    
    try {
        let imageData = null;
        
        // ä¸Šä¼ å›¾ç‰‡åˆ°Cloudinaryï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–Firebase Storage
        if (imageFile) {
            try {
                // å…ˆå‹ç¼©å›¾ç‰‡
                const compressedFile = await compressImage(imageFile);
                
                // å°è¯•Cloudinaryä¸Šä¼ 
                try {
                    imageData = await uploadToCloudinary(compressedFile, 'wall-posts');
                    console.log('ä½¿ç”¨Cloudinaryä¸Šä¼ ');
                } catch (cloudinaryError) {
                    console.log('Cloudinaryä¸Šä¼ å¤±è´¥ï¼Œå°è¯•Firebase Storage:', cloudinaryError);
                    
                    // ä½¿ç”¨Firebase Storageä½œä¸ºå¤‡é€‰
                    imageData = await uploadToFirebaseStorage(compressedFile, 'wall-posts');
                    console.log('ä½¿ç”¨Firebase Storageä¸Šä¼ ');
                }
                
                showAlert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } catch (uploadError) {
                console.error('æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ æ–¹å¼éƒ½å¤±è´¥äº†:', uploadError);
                showAlert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${uploadError.message}`, 'error');
                
                // è¯¢é—®æ˜¯å¦ç»§ç»­å‘å¸ƒæ²¡æœ‰å›¾ç‰‡çš„è´´æ–‡
                if (!confirm('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œæ˜¯å¦ç»§ç»­å‘å¸ƒä¸å¸¦å›¾ç‰‡çš„è´´æ–‡ï¼Ÿ')) {
                    return;
                }
            }
        }
        
        // åˆ›å»ºè´´æ–‡æ•°æ®
        const postData = {
            title: title || '',
            content: content,
            color: color,
            authorId: currentUser.uid,
            authorName: userName.textContent,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ•°æ®
        if (imageData) {
            postData.imageData = {
                url: imageData.url,
                thumbnail: imageData.thumbnail || imageData.url,
                medium: imageData.medium || imageData.url,
                publicId: imageData.publicId || imageData.path,
                width: imageData.width,
                height: imageData.height,
                format: imageData.format || imageFile.type,
                size: imageData.size || imageFile.size
            };
            
            // è®°å½•ä½¿ç”¨å“ªç§å­˜å‚¨æ–¹å¼
            postData.imageData.storageProvider = imageData.publicId ? 'cloudinary' : 'firebase';
        }
        
        // ä¿å­˜åˆ°Firestore
        const docRef = await db.collection('wallPosts').add(postData);
        
        // ç«‹å³æ·»åŠ åˆ°é¡µé¢
        addPostToWall({
            id: docRef.id,
            ...postData,
            imageUrl: imageData ? imageData.url : null
        });
        
        // æ¸…é™¤è¡¨å•
        closeModal('add-note');
        showAlert('è´´æ–‡å‘å¸ƒæˆåŠŸ!', 'success');
        
        // æ›´æ–°ç»Ÿè®¡
        loadDashboardData();
        if (isAdmin) loadAdminData();
        
    } catch (error) {
        console.error('æ·»åŠ è´´æ–‡é”™è¯¯:', error);
        showAlert(`å‘å¸ƒè´´æ–‡å¤±è´¥: ${error.message}`, 'error');
    }
}

// === æ·»åŠ è´´æ–‡åˆ°å¢™é¢çš„è¾…åŠ©å‡½æ•° ===
function addPostToWall(post) {
    const wall = document.getElementById('padlet-wall');
    const addNoteBtn = document.getElementById('wall-add-btn') || document.getElementById('empty-wall-add-btn');
    
    const noteColorClass = `note-${post.color || 'yellow'}`;
    
    // åˆ›å»ºå›¾ç‰‡HTML
    let imageHtml = '';
    if (post.imageUrl) {
        // ä½¿ç”¨ä¼˜åŒ–åçš„ç¼©ç•¥å›¾
        const thumbnailUrl = post.imageData?.thumbnail || post.imageUrl;
        imageHtml = `
            <img src="${thumbnailUrl}" 
                 data-src="${post.imageUrl}" 
                 class="note-image lazy-load" 
                 alt="Post Image"
                 loading="lazy">
        `;
    }
    
    const noteHtml = `
        <div class="padlet-note ${noteColorClass} draggable" data-id="${post.id}" draggable="true">
            <div class="note-actions">
                <button class="note-btn delete-note" title="Delete" onclick="handleDeleteNote('${post.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            ${post.title ? `<div class="note-title">${post.title}</div>` : ''}
            <div class="note-content">${escapeHTML(post.content)}</div>
            ${imageHtml}
            <div class="note-meta">
                <span><i class="fas fa-user"></i> ${post.authorName}</span>
                <span><i class="fas fa-clock"></i> åˆšåˆš</span>
            </div>
        </div>
    `;
    
    if (addNoteBtn && addNoteBtn.parentNode) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = noteHtml;
        addNoteBtn.parentNode.insertBefore(tempDiv.firstChild, addNoteBtn);
    }
    
    // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½
    initDragAndDrop();
}
    
    // ä¿®æ”¹profile-formçš„æäº¤å¤„ç†
async function handleUpdateProfile(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showAlert('Please login first', 'error');
        return;
    }
    
    const name = document.getElementById('edit-name').value;
    const school = document.getElementById('edit-school').value;
    const grade = document.getElementById('edit-grade').value;
    const interests = document.getElementById('edit-interests').value.split(',').map(i => i.trim()).filter(i => i);
    const bio = document.getElementById('edit-bio').value;
    const avatarFile = document.getElementById('edit-avatar').files[0];
    
    try {
        let avatarUrl = '';
        
        // ä¸Šä¼ å¤´åƒåˆ°Cloudinary
        if (avatarFile) {
            try {
                // å‹ç¼©å¤´åƒå›¾ç‰‡
                const compressedAvatar = await compressImage(avatarFile, 400, 0.9);
                
                // ä¸Šä¼ åˆ°Cloudinary
                const avatarResult = await uploadToCloudinary(compressedAvatar, 'avatars');
                avatarUrl = avatarResult.url;
                
                // ç«‹å³æ›´æ–°å¤´åƒæ˜¾ç¤º
                document.getElementById('user-avatar').innerHTML = 
                    `<img src="${avatarResult.thumbnail}" alt="Avatar" style="width:100%;height:100%;border-radius:50%;">`;
                
                showAlert('å¤´åƒä¸Šä¼ æˆåŠŸ', 'success');
            } catch (uploadError) {
                console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', uploadError);
                showAlert('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œä½†å…¶ä»–ä¿¡æ¯å·²ä¿å­˜', 'warning');
            }
        }


        
        // æ›´æ–°ç”¨æˆ·æ•°æ®
        const updateData = {
            name: name,
            school: school,
            grade: grade,
            interests: interests,
            bio: bio,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (avatarUrl) {
            updateData.avatarUrl = avatarUrl;
        }
        
        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        // æ›´æ–°UI
        updateUserUI(updateData);
        showAlert('Profile updated successfully!', 'success');
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showAlert(`Failed to update profile: ${error.message}`, 'error');
    }
}
    
    async function handleChangePassword(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        
        if (newPassword !== confirmNewPassword) {
            showAlert('The new password and confirmation password must be the same.', 'error');
            return;
        }
        
        if (!currentPassword) {
            showAlert('Please enter your current password.', 'error');
            return;
        }
        
        try {
            // Reauthenticate user
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email, 
                currentPassword
            );
            
            await currentUser.reauthenticateWithCredential(credential);
            
            // Update password
            await currentUser.updatePassword(newPassword);
            
            closeModal('changePassword');
            showAlert('Password changed successfully!', 'success');
        } catch (error) {
            console.error('Error changing password:', error);
            showAlert(`Failed to change password: ${error.message}`, 'error');
        }
    }
    
    async function handleAddEvent(e) {
        e.preventDefault();
        
        if (!currentUser) {
            showAlert('Please login first', 'error');
            return;
        }
        
        const title = document.getElementById('event-title').value;
        const description = document.getElementById('event-description').value;
        const date = document.getElementById('event-date').value;
        const time = document.getElementById('event-time').value;
        const type = document.getElementById('event-type').value;
        const school = document.getElementById('event-school').value;
        
        if (!title || !date) {
            showAlert('Please enter the title and date.', 'error');
            return;
        }
        
        try {
            // ä¿®å¤æ—¥æœŸé—®é¢˜ï¼šä½¿ç”¨æœ¬åœ°æ—¶åŒº
            const eventDate = new Date(date + 'T12:00:00'); // ä½¿ç”¨ä¸­åˆ12ç‚¹é¿å…æ—¶åŒºé—®é¢˜

if (time) {
    const [hours, minutes] = time.split(':');
    eventDate.setHours(parseInt(hours), parseInt(minutes));
}

const eventData = {
    title: title,
    description: description,
    date: firebase.firestore.Timestamp.fromDate(eventDate), // ä½¿ç”¨Firestoreæ—¶é—´æˆ³
    time: time || '',
    type: type,
    school: school,
    authorId: currentUser.uid,
    authorName: userName.textContent,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
            
            const docRef = await db.collection('events').add(eventData);
            
            // ä¿®å¤ï¼šä½¿ç”¨æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²æ˜¾ç¤º
            const dateString = eventDate.toISOString().split('T')[0];
            const eventContainer = document.getElementById(`events-${dateString}`);
            
            if (eventContainer) {
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event';
                eventElement.textContent = title;
                eventElement.setAttribute('data-id', docRef.id);
                eventElement.addEventListener('click', () => showEventDetail(docRef.id, eventData));
                
                eventContainer.appendChild(eventElement);
            }
            
            eventForm.reset();
            document.querySelector('[data-tab="view-calendar"]').click();
            showAlert('æ´»åŠ¨å·²æ·»åŠ ', 'success');
            
            loadDashboardData();
            if (isAdmin) loadAdminData();
            
        } catch (error) {
            console.error('Error adding event:', error);
            showAlert(`Failed to add the post: ${error.message}`, 'error');
        }
    }
    
    async function handleAdminAddAnnouncement(e) {
        e.preventDefault();
        
        if (!isAdmin) {
            showAlert('You do not have permission to post announcements.', 'error');
            return;
        }
        
        const title = document.getElementById('admin-announcement-title').value;
        const content = document.getElementById('admin-announcement-content').value;
        
        if (!title || !content) {
            showAlert('Please enter the title and content.', 'error');
            return;
        }
        
        try {
            // Create announcement in Firestore
            const announcementData = {
                title: title,
                content: content,
                authorId: currentUser.uid,
                authorName: userName.textContent,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('announcements').add(announcementData);
            
            adminAnnouncementForm.reset();
            showAlert('Announcement published successfully!', 'success');
            
            // Reload announcements if on that page
            if (currentPage === 'announcements') {
                loadAnnouncements();
            }
            
            // Update dashboard and admin data
            loadDashboardData();
            loadAdminData();
        } catch (error) {
            console.error('Error adding announcement:', error);
            showAlert(`Failed to publish announcement: ${error.message}`, 'error');
        }
    }
    
    async function handleAdminAddEvent(e) {
        e.preventDefault();
        
        if (!isAdmin) {
            showAlert('You do not have permission to create events.', 'error');
            return;
        }
        
        const title = document.getElementById('admin-event-title').value;
        const date = document.getElementById('admin-event-date').value;
        
        if (!title || !date) {
            showAlert('Please enter the title and date', 'error');
            return;
        }
        
        try {
            // Create event object
            const eventDate = new Date(date);
            const eventData = {
                title: title,
                date: eventDate,
                authorId: currentUser.uid,
                authorName: userName.textContent,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const docRef = await db.collection('events').add(eventData);
            
            // Add to calendar
            const dateString = date;
            const eventContainer = document.getElementById(`events-${dateString}`);
            
            if (eventContainer) {
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event';
                eventElement.textContent = title;
                eventElement.setAttribute('data-id', docRef.id);
                eventElement.addEventListener('click', () => showEventDetail(docRef.id, eventData));
                
                eventContainer.appendChild(eventElement);
            }
            
            adminEventForm.reset();
            showAlert('æ´»åŠ¨å·²åˆ›å»º', 'success');
            
            // Reload calendar and update data
            loadCalendarEvents();
            loadDashboardData();
            loadAdminData();
        } catch (error) {
            console.error('Error adding admin event:', error);
            showAlert(`Failed to create events: ${error.message}`, 'error');
        }
    }
    
async function saveAdminSettings() {
    if (!isAdmin) {
        showAlert('You do not have permission to change system settings.', 'error');
        return;
    }
    
    const platformNameInput = document.getElementById('platform-name');
    const welcomeMessageInput = document.getElementById('welcome-message');
    const maintenanceModeCheckbox = document.getElementById('maintenance-mode');
    
    // è°ƒè¯•ï¼šæ£€æŸ¥è·å–çš„å€¼
    console.log('platformName input:', platformNameInput);
    console.log('platformName value:', platformNameInput ? platformNameInput.value : 'not found');
    console.log('welcomeMessage input:', welcomeMessageInput);
    console.log('welcomeMessage value:', welcomeMessageInput ? welcomeMessageInput.value : 'not found');
    
    if (!platformNameInput || !welcomeMessageInput) {
        showAlert('Settings form elements not found!', 'error');
        return;
    }
    
    const platformName = platformNameInput.value;
    const welcomeMessage = welcomeMessageInput.value;
    const maintenanceMode = maintenanceModeCheckbox ? maintenanceModeCheckbox.checked : false;
    
    // æ›´å®½æ¾çš„éªŒè¯ï¼šåªæ£€æŸ¥æ˜¯å¦ä¸º undefined æˆ– null
    if (platformName === undefined || platformName === null) {
        showAlert('Please fill in platform name.', 'error');
        platformNameInput.focus();
        return;
    }
    
    if (welcomeMessage === undefined || welcomeMessage === null) {
        showAlert('Please fill in welcome message.', 'error');
        welcomeMessageInput.focus();
        return;
    }
    
    try {
        // å‡†å¤‡è®¾ç½®æ•°æ®
        const settingsData = {
            platformName: platformName.trim() || 'Foon Yew High School - Kaohsiung Senior High School Online Exchange Platform',
            welcomeMessage: welcomeMessage.trim() || 'Welcome to the Two-School Exchange Platformï¼',
            maintenanceMode: maintenanceMode,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.uid
        };
        
        console.log('Saving settings data:', settingsData);
        
        // Save settings to Firestore
        await db.collection('settings').doc('platform').set(settingsData, { merge: true });
        
        // Update UI
        const platformTitle = document.querySelector('.logo-text h1');
        if (platformTitle) {
            platformTitle.textContent = settingsData.platformName;
        }
        
        // æ³¨æ„ï¼šè¿™é‡Œæœ‰æ½œåœ¨çš„å†²çª - ID "welcome-message" åŒæ—¶ç”¨äºè¾“å…¥æ¡†å’Œæ˜¾ç¤ºåŒºåŸŸ
        // ä¿®æ­£ï¼šæ˜¾ç¤ºåŒºåŸŸåº”è¯¥æœ‰ä¸åŒçš„ID
        
        showAlert('System settings saved successfully!', 'success');
        
    } catch (error) {
        console.error('Error saving settings:', error);
        showAlert(`Failed to save settings: ${error.message}`, 'error');
    }
}

       async function loadPlatformSettings() {
    try {
        const settingsDoc = await db.collection('settings').doc('platform').get();
        
        if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            
            // å¡«å……è¡¨å•
            document.getElementById('platform-name').value = settings.platformName || 'Foon Yew High School - Kaohsiung Senior High School Online Exchange Platform';
            document.getElementById('welcome-message').value = settings.welcomeMessage || 'Welcome to the Two-School Exchange Platformï¼';
            document.getElementById('maintenance-mode').checked = settings.maintenanceMode || false;
        }
    } catch (error) {
        console.error('Error loading platform settings:', error);
    }
}
    
    async function showEventDetail(eventId, eventData) {
        document.getElementById('event-detail-title').textContent = eventData.title;
        
        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†æ—¥æœŸå¯¹è±¡
        let eventDate;
        if (eventData.date && typeof eventData.date.toDate === 'function') {
            eventDate = eventData.date.toDate();
        } else if (eventData.date instanceof Date) {
            eventDate = eventData.date;
        } else if (eventData.date) {
            eventDate = new Date(eventData.date);
        }
        
        let html = `
            <p><strong>Description:</strong> ${eventData.description || 'No description'}</p>
        `;
        
        if (eventDate) {
            // ä¿®å¤ï¼šä½¿ç”¨æœ¬åœ°æ—¶åŒºæ˜¾ç¤ºæ—¥æœŸ
            const options = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Taipei' };
            html += `<p><strong>Date:</strong> ${eventDate.toLocaleDateString('zh-CN', options)}</p>`;
        }
        
        if (eventData.time) {
            html += `<p><strong>Time:</strong> ${eventData.time}</p>`;
        }
        
        if (eventData.type) {
            const typeMap = {
                'academic': 'Academic Seminar',
                'cultural': 'Cultural Exchange',
                'competition': 'Joint Competition',
                'language': 'Language Exchange',
                'other': 'Other'
            };
            html += `<p><strong>Type:</strong> ${typeMap[eventData.type] || eventData.type}</p>`;
        }
        
        if (eventData.school) {
            const schoolMap = {
                'both': 'Joint by Both Schools',
                'fyhs': 'Foon Yew High School',
                'kshs': 'Kaohsiung Senior High School'
            };
            html += `<p><strong>Organizer:</strong> ${schoolMap[eventData.school] || eventData.school}</p>`;
        }
        
        html += `<p><strong>Creator:</strong> ${eventData.authorName || 'Unknown User'}</p>`;
        
        document.getElementById('event-detail-content').innerHTML = html;
        
        const actions = document.getElementById('event-detail-actions');
        actions.innerHTML = '';
        
        if (isAdmin || currentUser?.uid === eventData.authorId) {
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-outline';
            deleteBtn.style.color = 'var(--danger)';
            deleteBtn.style.borderColor = 'var(--danger)';
            deleteBtn.textContent = 'Delete Events';
            deleteBtn.onclick = () => {
                if (confirm('Are you sure you want to delete this event?ï¼Ÿ')) {
                    deleteEvent(eventId);
                    closeModal('eventDetail');
                }
            };
            actions.appendChild(deleteBtn);
            
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn btn-primary';
            editBtn.textContent = 'Edit Events';
            editBtn.onclick = () => {
                closeModal('eventDetail');
                openEditEventModal(eventId, eventData);
            };
            actions.appendChild(editBtn);
        }
        
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'btn btn-outline';
        closeBtn.textContent = 'Close';
        closeBtn.onclick = () => closeModal('eventDetail');
        actions.appendChild(closeBtn);
        
        openModal('eventDetail');
    }
    
    // Helper Functions
    async function deleteWallPost(postId) {
        try {
            // Get post data first to check permissions
            const postDoc = await db.collection('wallPosts').doc(postId).get();
            const postData = postDoc.data();
            
            if (!isAdmin && postData.authorId !== currentUser?.uid) {
                showAlert('You do not have permission to delete this post.', 'error');
                return;
            }
            
            // Delete image from storage if exists
            if (postData.imageUrl) {
                try {
                    const imageRef = storage.refFromURL(postData.imageUrl);
                    await imageRef.delete();
                } catch (storageError) {
                    console.error('Error deleting image:', storageError);
                }
            }
            
            // Delete from Firestore
            await db.collection('wallPosts').doc(postId).delete();
            
            // Remove from DOM
            const postElement = document.querySelector(`[data-id="${postId}"]`);
            if (postElement) {
                postElement.remove();
            }
            
            // Check if wall is now empty
            const wall = document.getElementById('padlet-wall');
            const remainingPosts = wall.querySelectorAll('.padlet-note').length;
            
            if (remainingPosts === 0) {
                wall.innerHTML = '<div class="add-note-btn" id="empty-wall-add-btn"><i class="fas fa-plus"></i><p>Create your first post</p></div>';
                document.getElementById('empty-wall-add-btn').addEventListener('click', () => openModal('add-note'));
            }
            
            showAlert('Post deleted successfully.', 'success');
            
            // Update statistics
            loadDashboardData();
            if (isAdmin) loadAdminData();
            
        } catch (error) {
            console.error('Error deleting post:', error);
            showAlert(`Failed to delete post: ${error.message}`, 'error');
        }
    }
    
    async function deleteEvent(eventId, isFromAdmin = false) {
    try {
        // Get event data first
        const eventDoc = await db.collection('events').doc(eventId).get();
        
        // ä¿®å¤ï¼šæ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨
        if (!eventDoc.exists) {
            showAlert('Event not found or has been deleted.', 'error');
            return;
        }
        
        const eventData = eventDoc.data();
        
        // ä¿®å¤ï¼šæ£€æŸ¥ eventData æ˜¯å¦å­˜åœ¨
        if (!eventData) {
            showAlert('Error loading event data.', 'error');
            return;
        }
        
        // ä¿®å¤ï¼šå¦‚æœæ˜¯ç®¡ç†é¢æ¿è°ƒç”¨ï¼Œè·³è¿‡æƒé™æ£€æŸ¥
        if (!isFromAdmin) {
            if (!isAdmin && eventData.authorId !== currentUser?.uid) {
                showAlert('You do not have permission to delete this event.', 'error');
                return;
            }
        }
        
        // Delete from Firestore
        await db.collection('events').doc(eventId).delete();
        
        // Remove from calendar
        const eventElement = document.querySelector(`[data-id="${eventId}"]`);
        if (eventElement) {
            eventElement.remove();
        }
        
        // ä¿®å¤ï¼šé‡æ–°åŠ è½½æ—¥å†äº‹ä»¶
        loadCalendarEvents();
        
        showAlert('Event deleted successfully.', 'success');
        
        // Close modal if open
        closeModal('eventDetail');
        
        // Update statistics
        loadDashboardData();
        if (isAdmin) loadAdminData();
        
    } catch (error) {
        console.error('Error deleting event:', error);
        showAlert(`Failed to delete events: ${error.message}`, 'error');
    }
}
    
    async function deleteUser(userId) {
        if (userId === currentUser?.uid) {
            showAlert('You cannot delete your own account.', 'error');
            return;
        }
        
        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            try {
                // Delete user from Firestore
                await db.collection('users').doc(userId).delete();
                
                // In a production app, you would also:
                // 1. Delete user's posts
                // 2. Delete user's events
                // 3. Delete user from Firebase Auth
                // (This requires Cloud Functions for security)
                
                showAlert('User deleted successfully.', 'success');
                
                // Reload user management if on that page
                if (currentPage === 'admin') {
                    loadUserManagement();
                    loadAdminData();
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert(`Failed to delete user: ${error.message}`, 'error');
            }
        }
    }
    
    async function deleteAccount() {
        if (confirm('Are you sure you want to permanently delete your account? This action cannot be undone.')) {
            try {
                // Delete user data from Firestore
                await db.collection('users').doc(currentUser.uid).delete();
                
                // Delete user's posts
                const userPosts = await db.collection('wallPosts')
                    .where('authorId', '==', currentUser.uid)
                    .get();
                
                const deletePromises = [];
                userPosts.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                
                // Delete user's events
                const userEvents = await db.collection('events')
                    .where('authorId', '==', currentUser.uid)
                    .get();
                
                userEvents.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                
                await Promise.all(deletePromises);
                
                // Delete user from Firebase Auth
                await currentUser.delete();
                
                showAlert('Account deleted successfully.', 'success');
            } catch (error) {
                console.error('Error deleting account:', error);
                showAlert(`Failed to delete account: ${error.message}`, 'error');
            }
        }
    }
    
    async function changeUserRole(userId, currentRole) {
        try {
            const newRole = currentRole === 'admin' ? 'student' : 'admin';
            
            await db.collection('users').doc(userId).update({
                role: newRole,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showAlert(`User permissions updated to${newRole === 'admin' ? 'Administrator' : 'Student'}`, 'success');
            
            // Reload user management
            if (currentPage === 'admin') {
                loadUserManagement();
            }
            
            // If current user changed their own role, update UI
            if (userId === currentUser?.uid) {
                isAdmin = newRole === 'admin';
                userRole.textContent = isAdmin ? 'Administrator' : 'Student';
                
                if (!isAdmin && currentPage === 'admin') {
                    navigateTo('dashboard');
                }
            }
        } catch (error) {
            console.error('Error changing user role:', error);
            showAlert(`Failed to change user role: ${error.message}`, 'error');
        }
    }
    
    function formatDate(date) {
        if (!date) return 'Unknown Date';
        
        if (typeof date === 'string') {
            date = new Date(date);
        }
        
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('zh-CN', options);
    }
    
    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
    }
    
    function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alert-container');
        const alertId = 'alert-' + Date.now();
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.id = alertId;
        alertDiv.innerHTML = `
            <span>${message}</span>
            <button class="close-alert" onclick="document.getElementById('${alertId}').remove()">&times;</button>
        `;
        
        alertContainer.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (document.getElementById(alertId)) {
                document.getElementById(alertId).remove();
            }
        }, 5000);
    }

       // åœ¨æ‰€æœ‰å‡½æ•°ä¹‹åæ·»åŠ Logoç®¡ç†åŠŸèƒ½
function initLogoManagement() {
    // Logoä¸Šä¼ äº‹ä»¶
    if (document.getElementById('fyhs-logo-upload')) {
        document.getElementById('fyhs-logo-upload').addEventListener('click', function() {
            document.getElementById('fyhs-logo-input').click();
        });
        
        document.getElementById('kshs-logo-upload').addEventListener('click', function() {
            document.getElementById('kshs-logo-input').click();
        });
        
        // Logoé¢„è§ˆ
        document.getElementById('fyhs-logo-input').addEventListener('change', function(e) {
            previewLogo(e, 'fyhs');
        });
        
        document.getElementById('kshs-logo-input').addEventListener('change', function(e) {
            previewLogo(e, 'kshs');
        });
        
        // ä¿å­˜Logo
        document.getElementById('save-logos').addEventListener('click', saveSchoolLogos);
    }
    
    // åŠ è½½ç°æœ‰Logo
    loadSchoolLogos();
}

// é¢„è§ˆLogo
function previewLogo(event, school) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.match('image.*')) {
        showAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
        showAlert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewDiv = document.getElementById(`${school}-logo-preview`);
        previewDiv.innerHTML = `
            <div class="logo-preview">
                <img src="${e.target.result}" alt="é¢„è§ˆ">
                <div>
                    <p>${file.name}</p>
                    <p>${(file.size / 1024).toFixed(2)} KB</p>
                </div>
            </div>
        `;
    };
    reader.readAsDataURL(file);
}

// ä¿å­˜Logoåˆ°Firebase Storage
// ä¿®æ”¹saveSchoolLogoså‡½æ•°
async function saveSchoolLogos() {
    if (!isAdmin) {
        showAlert('éœ€è¦ç®¡ç†å‘˜æƒé™', 'error');
        return;
    }
    
    const fyhsFile = document.getElementById('fyhs-logo-input').files[0];
    const kshsFile = document.getElementById('kshs-logo-input').files[0];
    
    if (!fyhsFile && !kshsFile) {
        showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªLogoæ–‡ä»¶', 'warning');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨ä¸Šä¼ Logo...', 'info');
        
        const logoData = {};
        
        // å¤„ç†å®½æŸ”ä¸­å­¦Logo
        if (fyhsFile) {
            const fyhsBase64 = await fileToBase64(fyhsFile);
            logoData.fyhsLogoBase64 = fyhsBase64;
            logoData.fyhsLogoType = fyhsFile.type;
            logoData.fyhsLogoUpdated = firebase.firestore.FieldValue.serverTimestamp();
            logoData.fyhsLogoUpdatedBy = currentUser.uid;
        }
        
        // å¤„ç†é«˜é›„ä¸­å­¦Logo
        if (kshsFile) {
            const kshsBase64 = await fileToBase64(kshsFile);
            logoData.kshsLogoBase64 = kshsBase64;
            logoData.kshsLogoType = kshsFile.type;
            logoData.kshsLogoUpdated = firebase.firestore.FieldValue.serverTimestamp();
            logoData.kshsLogoUpdatedBy = currentUser.uid;
        }
        
        // ä¿å­˜åˆ°Firestore
        await db.collection('settings').doc('logos').set(logoData, { merge: true });
        
        showAlert('Logoä¸Šä¼ æˆåŠŸ', 'success');
        
        // åˆ·æ–°Logoæ˜¾ç¤º
        loadSchoolLogos();
        
    } catch (error) {
        console.error('Error saving logos:', error);
        showAlert(`Logoä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
}

// è¾…åŠ©å‡½æ•°ï¼šå°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// ä¿®æ”¹loadSchoolLogoså‡½æ•°
async function loadSchoolLogos() {
    try {
        // ä»Firestoreè·å–Logoæ•°æ®
        const logosDoc = await db.collection('settings').doc('logos').get();
        
        if (logosDoc.exists) {
            const logosData = logosDoc.data();
            
            // è®¾ç½®å®½æŸ”ä¸­å­¦Logo
            if (logosData.fyhsLogoBase64) {
                const fyhsImg = document.getElementById('fyhs-logo-img');
                if (fyhsImg) {
                    fyhsImg.src = logosData.fyhsLogoBase64;
                    fyhsImg.style.display = 'block';
                }
            } else {
                // ä½¿ç”¨é»˜è®¤SVG
                setDefaultLogo('fyhs');
            }
            
            // è®¾ç½®é«˜é›„ä¸­å­¦Logo
            if (logosData.kshsLogoBase64) {
                const kshsImg = document.getElementById('kshs-logo-img');
                if (kshsImg) {
                    kshsImg.src = logosData.kshsLogoBase64;
                    kshsImg.style.display = 'block';
                }
            } else {
                // ä½¿ç”¨é»˜è®¤SVG
                setDefaultLogo('kshs');
            }
        } else {
            // ä½¿ç”¨é»˜è®¤SVG
            setDefaultLogo('fyhs');
            setDefaultLogo('kshs');
        }
    } catch (error) {
        console.error('Error loading logos:', error);
        setDefaultLogo('fyhs');
        setDefaultLogo('kshs');
    }
}

// è®¾ç½®é»˜è®¤Logoï¼ˆSVGï¼‰
function setDefaultLogo(school) {
    const imgElement = document.getElementById(`${school}-logo-img`);
    if (!imgElement) return;
    
    if (school === 'fyhs') {
        imgElement.src = 'data:image/svg+xml;base64,' + btoa(`
            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="20" width="80" height="80" rx="15" fill="#e53935"/>
                <text x="60" y="70" text-anchor="middle" fill="white" font-size="28" font-weight="bold" font-family="Arial">FY</text>
                <text x="60" y="95" text-anchor="middle" fill="white" font-size="12" font-family="Arial">å®½æŸ”ä¸­å­¦</text>
            </svg>
        `);
    } else if (school === 'kshs') {
        imgElement.src = 'data:image/svg+xml;base64,' + btoa(`
            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="60" cy="60" r="50" fill="#1565c0"/>
                <text x="60" y="65" text-anchor="middle" fill="white" font-size="28" font-weight="bold" font-family="Arial">KS</text>
                <text x="60" y="90" text-anchor="middle" fill="white" font-size="12" font-family="Arial">é«˜é›„ä¸­å­¦</text>
            </svg>
        `);
    }
    imgElement.style.display = 'block';
}

// åŠ è½½Logo
async function loadSchoolLogos() {
    try {
        // ä»Firestoreè·å–Logo URL
        const logosDoc = await db.collection('settings').doc('logos').get();
        
        if (logosDoc.exists) {
            const logosData = logosDoc.data();
            
            // è®¾ç½®å®½æŸ”ä¸­å­¦Logo
            if (logosData.fyhsLogoUrl) {
                const fyhsImg = document.getElementById('fyhs-logo-img');
                if (fyhsImg) fyhsImg.src = logosData.fyhsLogoUrl;
            }
            
            // è®¾ç½®é«˜é›„ä¸­å­¦Logo
            if (logosData.kshsLogoUrl) {
                const kshsImg = document.getElementById('kshs-logo-img');
                if (kshsImg) kshsImg.src = logosData.kshsLogoUrl;
            }
        }
    } catch (error) {
        console.error('Error loading logos:', error);
    }
}
    
    // Make functions available globally for inline event handlers
    window.changeUserRole = changeUserRole;
    window.deleteWallPost = deleteWallPost;
    window.deleteEvent = deleteEvent;
    window.deleteUser = deleteUser;
    window.showEventDetail = showEventDetail;
       window.openDeleteConfirmation = openDeleteConfirmation;
window.openEditAnnouncementModal = openEditAnnouncementModal;
window.openEditNoteModal = openEditNoteModal;
window.openEditEventModal = openEditEventModal;

       const achievementSystem = {
        badges: {
            firstPost: {
                id: 'firstPost',
                name: 'åˆæ¬¡åˆ†äº«',
                description: 'å‘è¡¨ç¬¬ä¸€ä¸ªè´´æ–‡',
                icon: 'fas fa-feather-alt',
                color: '#4a6fa5',
                condition: (userData) => userData.postCount >= 1
            },
            activeParticipant: {
                id: 'activeParticipant',
                name: 'æ´»è·ƒå‚ä¸è€…',
                description: 'å‚ä¸5ä¸ªä»¥ä¸Šæ´»åŠ¨',
                icon: 'fas fa-users',
                color: '#27ae60',
                condition: (userData) => userData.eventParticipation >= 5
            },
            popularAuthor: {
                id: 'popularAuthor',
                name: 'çƒ­é—¨ä½œè€…',
                description: 'è·å¾—10ä¸ªä»¥ä¸Šç‚¹èµ',
                icon: 'fas fa-fire',
                color: '#e74c3c',
                condition: (userData) => userData.likesReceived >= 10
            },
            languageExpert: {
                id: 'languageExpert',
                name: 'è¯­è¨€ä¸“å®¶',
                description: 'å‚ä¸è¯­è¨€äº¤æ¢æ´»åŠ¨',
                icon: 'fas fa-language',
                color: '#9b59b6',
                condition: (userData) => userData.languageExchangeParticipation >= 1
            },
            cultureAmbassador: {
                id: 'cultureAmbassador',
                name: 'æ–‡åŒ–å¤§ä½¿',
                description: 'åˆ†äº«æ–‡åŒ–ç›¸å…³è´´æ–‡',
                icon: 'fas fa-handshake',
                color: '#f39c12',
                condition: (userData) => userData.culturePosts >= 3
            }
        },

        async getUserAchievements(userId) {
            try {
                const achievementsSnapshot = await db.collection('userAchievements')
                    .where('userId', '==', userId)
                    .get();
                
                const achievements = [];
                achievementsSnapshot.forEach(doc => {
                    achievements.push(doc.data());
                });
                
                return achievements;
            } catch (error) {
                console.error('Error loading achievements:', error);
                return [];
            }
        },

        async checkAndAwardBadges(userId, userData) {
            try {
                const userAchievements = await this.getUserAchievements(userId);
                const awardedBadges = userAchievements.map(ach => ach.badgeId);
                
                const badgesToAward = [];
                
                // æ£€æŸ¥æ¯ä¸ªå¾½ç« æ¡ä»¶
                for (const [badgeId, badge] of Object.entries(this.badges)) {
                    if (!awardedBadges.includes(badgeId) && badge.condition(userData)) {
                        badgesToAward.push({
                            badgeId: badgeId,
                            ...badge
                        });
                    }
                }
                
                // é¢å‘æ–°å¾½ç« 
                for (const badge of badgesToAward) {
                    await this.awardBadge(userId, badge);
                }
                
                return badgesToAward;
            } catch (error) {
                console.error('Error checking badges:', error);
                return [];
            }
        },

        async awardBadge(userId, badge) {
            try {
                const achievementData = {
                    userId: userId,
                    badgeId: badge.id,
                    badgeName: badge.name,
                    badgeDescription: badge.description,
                    badgeIcon: badge.icon,
                    badgeColor: badge.color,
                    awardedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    notified: false
                };
                
                await db.collection('userAchievements').add(achievementData);
                
                // å‘é€é€šçŸ¥
                showAlert(`æ­å–œè·å¾—å¾½ç« : ${badge.name} - ${badge.description}`, 'success');
                
                return true;
            } catch (error) {
                console.error('Error awarding badge:', error);
                return false;
            }
        }
    };

    // æ›´æ–°ç”¨æˆ·æ•°æ®æ—¶æ£€æŸ¥å¾½ç« 
    async function updateUserAchievements(userId) {
        try {
            // è·å–ç”¨æˆ·æ•°æ®
            const userStats = await getUserStats(userId);
            
            // æ£€æŸ¥å¹¶é¢å‘å¾½ç« 
            const newBadges = await achievementSystem.checkAndAwardBadges(userId, userStats);
            
            // å¦‚æœæœ‰æ–°å¾½ç« ï¼Œåˆ·æ–°æ˜¾ç¤º
            if (newBadges.length > 0) {
                await loadUserAchievements(userId);
            }
            
            return newBadges;
        } catch (error) {
            console.error('Error updating achievements:', error);
            return [];
        }
    }

    // è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
    async function getUserStats(userId) {
        try {
            const userData = {
                postCount: 0,
                eventParticipation: 0,
                likesReceived: 0,
                languageExchangeParticipation: 0,
                culturePosts: 0
            };
            
            // è·å–ç”¨æˆ·è´´æ–‡æ•°é‡
            const postsQuery = await db.collection('wallPosts')
                .where('authorId', '==', userId)
                .get();
            userData.postCount = postsQuery.size;
            
            // è·å–å‚ä¸çš„æ´»åŠ¨æ•°é‡ï¼ˆç®€åŒ–çš„ç¤ºä¾‹ï¼‰
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦è·Ÿè¸ªç”¨æˆ·å‚ä¸çš„æ´»åŠ¨
            
            // è·å–ç‚¹èµæ•°é‡ï¼ˆéœ€è¦åœ¨è´´æ–‡ä¸­æ·»åŠ ç‚¹èµå­—æ®µï¼‰
            
            return userData;
        } catch (error) {
            console.error('Error getting user stats:', error);
            return {};
        }
    }

    // åŠ è½½ç”¨æˆ·æˆå°±å¾½ç« 
    async function loadUserAchievements(userId) {
        const achievementBadges = document.getElementById('achievement-badges');
        
        if (!achievementBadges) return;
        
        try {
            const achievements = await achievementSystem.getUserAchievements(userId);
            
            if (achievements.length === 0) {
                achievementBadges.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-trophy" style="font-size: 4rem; color: var(--warning); opacity: 0.5;"></i>
                        <p style="font-size: 1.2rem; margin-top: 1rem;">æš‚æ— æˆå°±å¾½ç« </p>
                        <p style="opacity: 0.7; margin-top: 0.5rem;">å‚ä¸æ›´å¤šäº¤æµæ´»åŠ¨ä»¥è§£é”æˆå°±</p>
                        <div style="margin-top: 2rem; text-align: left;">
                            <h4 style="color: var(--primary); margin-bottom: 1rem;">å¦‚ä½•è·å¾—å¾½ç« ï¼Ÿ</h4>
                            <ul style="text-align: left; padding-left: 1.5rem;">
                                <li>å‘è¡¨ç¬¬ä¸€ä¸ªè´´æ–‡ - <span class="badge" style="background-color: #4a6fa5; color: white;">åˆæ¬¡åˆ†äº«</span></li>
                                <li>å‚ä¸5ä¸ªæ´»åŠ¨ - <span class="badge" style="background-color: #27ae60; color: white;">æ´»è·ƒå‚ä¸è€…</span></li>
                                <li>è·å¾—10ä¸ªç‚¹èµ - <span class="badge" style="background-color: #e74c3c; color: white;">çƒ­é—¨ä½œè€…</span></li>
                                <li>å‚ä¸è¯­è¨€äº¤æ¢ - <span class="badge" style="background-color: #9b59b6; color: white;">è¯­è¨€ä¸“å®¶</span></li>
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                let html = '<div style="display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: center;">';
                
                achievements.forEach(achievement => {
                    html += `
                        <div class="achievement-badge" style="
                            background: linear-gradient(135deg, ${achievement.badgeColor}20, ${achievement.badgeColor}40);
                            border: 3px solid ${achievement.badgeColor};
                            border-radius: 20px;
                            padding: 1.5rem;
                            text-align: center;
                            width: 180px;
                            transition: var(--transition);
                            cursor: pointer;
                        " 
                        onclick="showAchievementDetail('${achievement.badgeId}')"
                        onmouseover="this.style.transform='translateY(-10px) scale(1.05)'; this.style.boxShadow='0 15px 30px rgba(0,0,0,0.1)';"
                        onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='none';">
                            <i class="${achievement.badgeIcon}" style="font-size: 3rem; color: ${achievement.badgeColor}; margin-bottom: 1rem;"></i>
                            <h4 style="color: ${achievement.badgeColor}; margin-bottom: 0.5rem;">${achievement.badgeName}</h4>
                            <p style="font-size: 0.9rem; color: var(--dark); opacity: 0.8;">${achievement.badgeDescription}</p>
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;">
                                ${formatDate(achievement.awardedAt?.toDate())}
                            </p>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                achievementBadges.innerHTML = html;
            }
        } catch (error) {
            console.error('Error loading achievements:', error);
            achievementBadges.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>åŠ è½½æˆå°±å¾½ç« æ—¶å‡ºé”™</p>
                </div>
            `;
        }
    }

    // æ˜¾ç¤ºæˆå°±è¯¦æƒ…
    function showAchievementDetail(badgeId) {
        const badge = achievementSystem.badges[badgeId];
        if (!badge) return;
        
        showAlert(`æˆå°±: ${badge.name}<br>${badge.description}`, 'info');
    }

    // åœ¨ç”¨æˆ·ç™»å½•æ—¶åŠ è½½æˆå°±
    async function loadUserData(userId) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                updateUserUI(userData);
                
                // åŠ è½½æˆå°±å¾½ç« 
                await loadUserAchievements(userId);
                
                // æ£€æŸ¥æ–°å¾½ç« 
                await updateUserAchievements(userId);
            } else {
                // åˆ›å»ºç”¨æˆ·æ–‡æ¡£
                await db.collection('users').doc(userId).set({
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    school: '',
                    grade: '',
                    role: 'student',
                    interests: [],
                    bio: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    achievements: []
                });
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

       // ==================== Task Tracking System ====================
const taskTracking = {
    // Default tasks
    defaultTasks: [
        {
            id: 'task-register',
            name: 'Complete Registration',
            description: 'Complete user registration process on the platform',
            type: 'auto-registration',
            points: 10,
            active: true,
            createdAt: new Date(),
            order: 1
        },
        {
            id: 'task-profile',
            name: 'Complete Profile',
            description: 'Fill in all profile information including school, grade, and interests',
            type: 'auto-profile',
            points: 15,
            active: true,
            createdAt: new Date(),
            order: 2
        },
        {
            id: 'task-first-post',
            name: 'First Wall Post',
            description: 'Create your first post on the exchange wall',
            type: 'auto-post',
            points: 20,
            active: true,
            createdAt: new Date(),
            order: 3
        },
        {
            id: 'task-read-announcement',
            name: 'Read Announcements',
            description: 'Read at least 3 announcements from the announcements board',
            type: 'auto-announcement',
            points: 10,
            active: true,
            createdAt: new Date(),
            order: 4
        },
        {
            id: 'task-join-event',
            name: 'Join Exchange Event',
            description: 'Participate in at least one online exchange event',
            type: 'auto-event',
            points: 25,
            active: true,
            createdAt: new Date(),
            order: 5
        }
    ],

    // Initialize task tracking
    async initialize() {
        try {
            // Check if tasks collection exists, if not create default tasks
            const tasksSnapshot = await db.collection('trackingTasks').limit(1).get();
            if (tasksSnapshot.empty) {
                await this.createDefaultTasks();
            }
            
            // Initialize auto-tracking listeners
            this.setupAutoTracking();
            
            console.log('Task tracking system initialized');
        } catch (error) {
            console.error('Error initializing task tracking:', error);
        }
    },

    // Create default tasks
    async createDefaultTasks() {
        try {
            for (const task of this.defaultTasks) {
                await db.collection('trackingTasks').doc(task.id).set({
                    ...task,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'system'
                });
            }
            console.log('Default tasks created');
        } catch (error) {
            console.error('Error creating default tasks:', error);
        }
    },

    // Setup auto-tracking listeners
    setupAutoTracking() {
        // Listen for new user registrations
        db.collection('users').onSnapshot((snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const userId = change.doc.id;
                    const userData = change.doc.data();
                    
                    // Auto-complete registration task
                    await this.updateTaskCompletion(userId, 'task-register', true, false);
                    
                    // Check profile completion
                    if (userData.school && userData.grade) {
                        await this.updateTaskCompletion(userId, 'task-profile', true, false);
                    }
                }
            });
        });

        // Listen for new wall posts
        db.collection('wallPosts').onSnapshot((snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const postData = change.doc.data();
                    const userId = postData.authorId;
                    
                    if (userId) {
                        // Check if this is user's first post
                        const userPosts = await db.collection('wallPosts')
                            .where('authorId', '==', userId)
                            .get();
                        
                        if (userPosts.size === 1) {
                            await this.updateTaskCompletion(userId, 'task-first-post', true, false);
                        }
                    }
                }
            });
        });

        // Listen for event participation
        // This would need additional setup based on how event participation is tracked
    },

    // Get all active tasks
    async getAllTasks(activeOnly = true) {
        try {
            let query = db.collection('trackingTasks').orderBy('order');
            if (activeOnly) {
                query = query.where('active', '==', true);
            }
            
            const snapshot = await query.get();
            const tasks = [];
            snapshot.forEach(doc => {
                tasks.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            return tasks;
        } catch (error) {
            console.error('Error getting tasks:', error);
            return [];
        }
    },

    // Get student progress
    async getStudentProgress(studentId) {
        try {
            const progressSnapshot = await db.collection('taskProgress')
                .where('studentId', '==', studentId)
                .get();
            
            const progress = {};
            progressSnapshot.forEach(doc => {
                const data = doc.data();
                progress[data.taskId] = data;
            });
            
            return progress;
        } catch (error) {
            console.error('Error getting student progress:', error);
            return {};
        }
    },

    // Update task completion
    async updateTaskCompletion(studentId, taskId, completed = true, manualUpdate = false) {
        try {
            const taskData = {
                studentId: studentId,
                taskId: taskId,
                completed: completed,
                completedAt: completed ? firebase.firestore.FieldValue.serverTimestamp() : null,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: manualUpdate ? (currentUser?.uid || 'system') : 'auto-system',
                manualUpdate: manualUpdate
            };

            await db.collection('taskProgress').doc(`${studentId}_${taskId}`).set(taskData, { merge: true });

            // Log activity
            await this.logActivity(studentId, taskId, completed, manualUpdate);
            
            return true;
        } catch (error) {
            console.error('Error updating task completion:', error);
            return false;
        }
    },

    // Log activity
    async logActivity(studentId, taskId, completed, manualUpdate = false) {
        try {
            // Get student info
            const studentDoc = await db.collection('users').doc(studentId).get();
            const studentData = studentDoc.exists ? studentDoc.data() : { name: 'Unknown Student' };
            
            // Get task info
            const taskDoc = await db.collection('trackingTasks').doc(taskId).get();
            const taskData = taskDoc.exists ? taskDoc.data() : { name: 'Unknown Task' };

            const activityData = {
                studentId: studentId,
                studentName: studentData.name || 'Unknown Student',
                taskId: taskId,
                taskName: taskData.name || 'Unknown Task',
                action: completed ? 'completed' : 'reset',
                manualUpdate: manualUpdate,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                processedBy: manualUpdate ? (currentUser?.uid || 'system') : 'auto-system'
            };
            
            await db.collection('taskActivityLogs').add(activityData);
        } catch (error) {
            console.error('Error logging activity:', error);
        }
    },

    // Get completion statistics
    async getStatistics() {
        try {
            // Get total students
            const studentsSnapshot = await db.collection('users').get();
            const totalStudents = studentsSnapshot.size;

            // Get total tasks
            const tasksSnapshot = await db.collection('trackingTasks')
                .where('active', '==', true)
                .get();
            const totalTasks = tasksSnapshot.size;

            // Get completed tasks count
            const completedSnapshot = await db.collection('taskProgress')
                .where('completed', '==', true)
                .get();
            const totalCompletions = completedSnapshot.size;

            // Calculate average completion rate
            const avgCompletion = totalStudents > 0 && totalTasks > 0 ? 
                Math.round((totalCompletions / (totalStudents * totalTasks)) * 100) : 0;

            // Get today's completions
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaySnapshot = await db.collection('taskActivityLogs')
                .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(today))
                .where('action', '==', 'completed')
                .get();

            return {
                totalStudents,
                totalTasks,
                totalCompletions,
                avgCompletion,
                todayCompletions: todaySnapshot.size
            };
        } catch (error) {
            console.error('Error getting statistics:', error);
            return null;
        }
    },

    // Get recent activities
    async getRecentActivities(limit = 10) {
        try {
            const snapshot = await db.collection('taskActivityLogs')
                .orderBy('timestamp', 'desc')
                .limit(limit)
                .get();
            
            const activities = [];
            snapshot.forEach(doc => {
                activities.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            return activities;
        } catch (error) {
            console.error('Error getting recent activities:', error);
            return [];
        }
    },

    // Generate report
    async generateReport(type, startDate, endDate) {
        try {
            let reportData = {};
            
            switch(type) {
                case 'completion':
                    reportData = await this.generateCompletionReport(startDate, endDate);
                    break;
                case 'progress':
                    reportData = await this.generateProgressReport(startDate, endDate);
                    break;
                case 'comparison':
                    reportData = await this.generateComparisonReport(startDate, endDate);
                    break;
                case 'timeline':
                    reportData = await this.generateTimelineReport(startDate, endDate);
                    break;
            }
            
            return reportData;
        } catch (error) {
            console.error('Error generating report:', error);
            return null;
        }
    },

    // Generate completion report
    async generateCompletionReport(startDate, endDate) {
        const tasks = await this.getAllTasks();
        const students = await db.collection('users').get();
        
        const report = {
            title: 'Task Completion Report',
            period: `${formatDate(startDate)} to ${formatDate(endDate)}`,
            data: []
        };
        
        for (const task of tasks) {
            const completions = await db.collection('taskProgress')
                .where('taskId', '==', task.id)
                .where('completed', '==', true)
                .where('completedAt', '>=', firebase.firestore.Timestamp.fromDate(startDate))
                .where('completedAt', '<=', firebase.firestore.Timestamp.fromDate(endDate))
                .get();
            
            report.data.push({
                task: task.name,
                completions: completions.size,
                completionRate: Math.round((completions.size / students.size) * 100)
            });
        }
        
        return report;
    },

    // Generate progress report
    async generateProgressReport(startDate, endDate) {
        const students = await db.collection('users').get();
        const tasks = await this.getAllTasks();
        
        const report = {
            title: 'Student Progress Report',
            period: `${formatDate(startDate)} to ${formatDate(endDate)}`,
            data: []
        };
        
        students.forEach(doc => {
            const student = doc.data();
            report.data.push({
                name: student.name,
                school: student.school,
                email: student.email,
                tasksCompleted: 0, // Will be populated below
                completionRate: 0
            });
        });
        
        return report;
    }
};

// Initialize task tracking when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        taskTracking.initialize();
    }, 2000);
    
    // Initialize task tracking event listeners
    initTaskTracking();
});

// Initialize task tracking event listeners
// ä¿®å¤initTaskTrackingå‡½æ•°ï¼š
function initTaskTracking() {
    // ç¡®ä¿DOMå·²åŠ è½½
    setTimeout(() => {
        // Add Task button
        const addTaskBtn = document.getElementById('add-task-btn');
        if (addTaskBtn) {
            addTaskBtn.addEventListener('click', () => openTaskModal());
        }
        
        // Task form submission
        const taskForm = document.getElementById('task-form');
        if (taskForm) {
            taskForm.addEventListener('submit', handleSaveTask);
        }
        
        // Generate report button
        const generateReportBtn = document.getElementById('generate-report');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', handleGenerateReport);
        }
        
        // Task tracking tabs - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
        const trackingContainer = document.getElementById('admin-tracking');
        if (trackingContainer) {
            trackingContainer.addEventListener('click', function(e) {
                const tab = e.target.closest('.tab');
                if (tab && tab.closest('#admin-tracking')) {
                    e.preventDefault();
                    const tabId = tab.getAttribute('data-tab');
                    if (tabId) {
                        activateTrackingTab(tabId);
                    }
                }
            });
        }
    }, 500); // å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨åŠ è½½
}

// Activate tracking tab
// ä¿®å¤åçš„å‡½æ•°ï¼š
function activateTrackingTab(tabId) {
    // åªåœ¨trackingåŒºåŸŸå†…æŸ¥æ‰¾å…ƒç´ 
    const trackingContainer = document.getElementById('admin-tracking');
    if (!trackingContainer) return;
    
    // æ›´æ–°trackingåŒºåŸŸå†…çš„tab
    trackingContainer.querySelectorAll('.tabs .tab').forEach(t => {
        t.classList.remove('active');
    });
    const activeTab = trackingContainer.querySelector(`.tab[data-tab="${tabId}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // æ›´æ–°trackingåŒºåŸŸå†…çš„tabå†…å®¹
    trackingContainer.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    const activeContent = trackingContainer.querySelector(`#${tabId}`);
    if (activeContent) {
        activeContent.classList.add('active');
    }
    
    // åŠ è½½tabå†…å®¹
    loadTrackingTab(tabId);
}

// å›¾è¡¨æ¸…ç†è¾…åŠ©å‡½æ•°
function cleanupCharts() {
    chartManager.destroy();
}

// åœ¨ DOMContentLoaded åè°ƒç”¨ï¼Œç¡®ä¿é¡µé¢åŠ è½½æ—¶æ²¡æœ‰æ®‹ç•™å›¾è¡¨
document.addEventListener('DOMContentLoaded', function() {
    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ®‹ç•™å›¾è¡¨
    cleanupCharts();
});

        // å®‰å…¨çš„å›¾è¡¨åˆå§‹åŒ–å‡½æ•°
/*async function safeInitializeProgressChart() {
    try {
        console.log('Safe initializing progress chart...');
        
        // ç¡®ä¿é¡µé¢æ­£åœ¨æ˜¾ç¤º
        const canvas = document.getElementById('progress-chart');
        if (!canvas) {
            console.warn('Canvas not found, chart may not be visible yet');
            return;
        }
        
        // æ£€æŸ¥çˆ¶å…ƒç´ æ˜¯å¦å¯è§
        const parentContainer = canvas.closest('.tab-content');
        if (parentContainer && !parentContainer.classList.contains('active')) {
            console.warn('Chart container not active, skipping initialization');
            return;
        }
        
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // æ¸…ç†ç°æœ‰å›¾è¡¨
        if (window.progressChart) {
            try {
                window.progressChart.destroy();
                window.progressChart = null;
            } catch (e) {
                console.error('Error destroying chart:', e);
            }
        }
        
        // æ¸…ç†Canvasä¸Šä¸‹æ–‡
        const ctx = canvas.getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
        await initializeProgressChart();
        
        console.log('Chart initialized successfully');
        
    } catch (error) {
        console.error('Error in safeInitializeProgressChart:', error);
        // ä¸è¦æŠ›å‡ºé”™è¯¯ï¼Œä»¥å…å½±å“å…¶ä»–åŠŸèƒ½
    }
}*/
       
       
// Load tracking tab content
// ç®€åŒ–loadTrackingTabå‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†æ¯ä¸ªtabï¼š
async function loadTrackingTab(tabId) {
    console.log('Loading tracking tab:', tabId);
    
    try {
        if (tabId !== 'tracking-overview') {
            console.log('Hiding chart for non-overview tab');
            chartManager.hide();
        }
        
        switch(tabId) {
            case 'tracking-overview':
                await loadTrackingOverview();
                break;
            case 'tracking-tasks':
                await loadManageTasks();
                break;
            case 'tracking-students':
                await loadStudentProgressList();
                break;
            case 'tracking-reports':
                // æ¸…ç©ºä¹‹å‰çš„æŠ¥å‘Š
                document.getElementById('report-output').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>Select parameters and generate a report</p>
                    </div>
                `;
                break;
        }
    } catch (error) {
        console.error(`Error loading tracking tab ${tabId}:`, error);
        showAlert(`Error loading ${tabId}: ${error.message}`, 'error');
    }
}

       function checkChartJSAvailability() {
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded, attempting to load...');
        loadChartJS();
        return false;
    }
    return true;
}

function loadChartJS() {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        console.log('Chart.js loaded successfully');
    };
    script.onerror = function() {
        console.error('Failed to load Chart.js');
        showAlert('Failed to load charting library. Some features may not work properly.', 'warning');
    };
    document.head.appendChild(script);
}

// Load tracking overview
// Load tracking overview
async function loadTrackingOverview() {
    try {
        console.log('Loading tracking overview via ChartManager...');
        
        // ç¡®ä¿å›¾è¡¨å®¹å™¨å¯è§
        const chartContainer = document.getElementById('progress-chart-container');
        if (chartContainer) {
            chartContainer.style.display = 'block';
        }
        
        // ä½¿ç”¨ ChartManager å®‰å…¨åœ°åˆå§‹åŒ–å›¾è¡¨
        await chartManager.initialize();
        
        // åˆ·æ–°å›¾è¡¨æ•°æ®
        await chartManager.refresh();
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆä¿æŒä¸å˜ï¼‰
        const stats = await taskTracking.getStatistics();
        if (stats) {
            document.getElementById('tracking-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalStudents}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalTasks}</div>
                        <div class="stat-label">Active Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalCompletions}</div>
                        <div class="stat-label">Total Completions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.avgCompletion}%</div>
                        <div class="stat-label">Average Completion</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.todayCompletions || 0}</div>
                        <div class="stat-label">Today's Completions</div>
                    </div>
                </div>
            `;
        }
        
        // åŠ è½½æœ€è¿‘æ´»åŠ¨ï¼ˆä¿æŒä¸å˜ï¼‰
        const recentActivities = await taskTracking.getRecentActivities(5);
        if (recentActivities.length > 0) {
            let html = '';
            recentActivities.forEach(activity => {
                const timeAgo = formatTimeAgo(activity.timestamp?.toDate());
                const actionIcon = activity.action === 'completed' ? 'âœ…' : 'ğŸ”„';
                html += `
                    <div class="recent-activity-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <span style="font-weight: 600;">${activity.studentName}</span>
                                <span style="margin: 0 10px;">${actionIcon}</span>
                                <span>${activity.taskName}</span>
                            </div>
                            <span style="font-size: 0.9rem; color: var(--gray);">${timeAgo}</span>
                        </div>
                        ${activity.manualUpdate ? 
                            '<div style="font-size: 0.85rem; color: var(--warning); margin-top: 5px;">Manual update by admin</div>' : 
                            '<div style="font-size: 0.85rem; color: var(--success); margin-top: 5px);">Auto-tracked by system</div>'}
                    </div>
                `;
            });
            document.getElementById('recent-tracked-activities').innerHTML = html;
        } else {
            document.getElementById('recent-tracked-activities').innerHTML = 
                '<div class="empty-state"><p>No recent activities</p></div>';
        }
        
        console.log('Tracking overview loaded successfully');
        
    } catch (error) {
        console.error('Error loading tracking overview:', error);
        showAlert('Error loading tracking overview', 'error');
    }
}

// Initialize progress chart
/*function initializeProgressChart() {
    const canvas = document.getElementById('progress-chart');
    if (!canvas) return;

    // â­ å…³é”®ï¼šå…ˆé”€æ¯æ—§ chart
    if (progressChartInstance) {
        progressChartInstance.destroy();
        progressChartInstance = null;
    }

    const ctx = canvas.getContext('2d');
    progressChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Completed', 'Pending'],
            datasets: [{
                data: [10, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}*/

       
// Load manage tasks
async function loadManageTasks() {
    try {
        const tasks = await taskTracking.getAllTasks(false);
        const container = document.getElementById('tasks-list');
        
        if (!tasks || tasks.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No tasks found</p></div>';
            return;
        }

        let html = '';
        tasks.forEach(task => {
            html += `
                <div class="task-item">
                    <div class="task-info">
                        <h4>${task.name} ${!task.active ? '<span style="color: var(--gray); font-size: 0.9rem;">(Inactive)</span>' : ''}</h4>
                        <p>${task.description || 'No description provided'}</p>
                        <div class="task-meta">
                            <span class="task-type-badge ${task.type.startsWith('auto') ? 'type-auto' : 'type-manual'}">
                                ${task.type.replace('auto-', '').replace('-', ' ')}
                            </span>
                            ${task.points ? `<span><i class="fas fa-star" style="color: var(--warning);"></i> ${task.points} points</span>` : ''}
                            ${task.deadline ? `<span><i class="fas fa-calendar-alt"></i> ${formatDate(new Date(task.deadline))}</span>` : ''}
                            <span><i class="fas fa-clock"></i> Created: ${formatDate(task.createdAt?.toDate())}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-small btn-outline edit-task" data-task-id="${task.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-small btn-outline delete-task" data-task-id="${task.id}" 
                                style="color: var(--danger); border-color: var(--danger);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

        // Add event listeners
        document.querySelectorAll('.edit-task').forEach(btn => {
            btn.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                openTaskModal(taskId);
            });
        });

        document.querySelectorAll('.delete-task').forEach(btn => {
            btn.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                deleteTask(taskId);
            });
        });

    } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById('tasks-list').innerHTML = 
            '<div class="empty-state"><p>Error loading tasks</p></div>';
    }
}

// Open task modal
async function openTaskModal(taskId = null) {
    const modal = document.getElementById('task-modal');
    const title = document.getElementById('task-modal-title');
    const form = document.getElementById('task-form');
    
    if (taskId) {
        title.textContent = 'Edit Task';
        // Load task data
        const taskDoc = await db.collection('trackingTasks').doc(taskId).get();
        if (taskDoc.exists) {
            const task = taskDoc.data();
            document.getElementById('task-id').value = taskId;
            document.getElementById('task-name').value = task.name || '';
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-type').value = task.type || 'manual';
            document.getElementById('task-points').value = task.points || '';
            
            if (task.deadline) {
                const deadlineDate = new Date(task.deadline);
                document.getElementById('task-deadline').value = deadlineDate.toISOString().split('T')[0];
            } else {
                document.getElementById('task-deadline').value = '';
            }
            
            document.getElementById('task-active').checked = task.active !== false;
        }
    } else {
        title.textContent = 'Add New Task';
        form.reset();
        document.getElementById('task-id').value = '';
        document.getElementById('task-active').checked = true;
        
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('task-deadline').value = tomorrow.toISOString().split('T')[0];
    }
    
    openModal('task-modal');
}

// Save task
async function handleSaveTask(e) {
    e.preventDefault();
    
    if (!isAdmin) {
        showAlert('Administrator permissions required to manage tasks.', 'error');
        return;
    }
    
    const taskId = document.getElementById('task-id').value;
    const taskData = {
        name: document.getElementById('task-name').value.trim(),
        description: document.getElementById('task-description').value.trim(),
        type: document.getElementById('task-type').value,
        points: parseInt(document.getElementById('task-points').value) || null,
        deadline: document.getElementById('task-deadline').value || null,
        active: document.getElementById('task-active').checked,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.uid || 'admin'
    };
    
    if (!taskData.name) {
        showAlert('Task name is required.', 'error');
        return;
    }
    
    try {
        if (!taskId) {
            // New task
            taskData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            taskData.createdBy = currentUser?.uid || 'admin';
            taskData.order = await getNextTaskOrder();
            
            const newTaskRef = await db.collection('trackingTasks').add(taskData);
            showAlert('Task created successfully!', 'success');
        } else {
            // Update task
            await db.collection('trackingTasks').doc(taskId).update(taskData);
            showAlert('Task updated successfully!', 'success');
        }
        
        closeModal('task-modal');
        loadManageTasks();
        if (currentPage === 'admin' && document.getElementById('tracking-overview').classList.contains('active')) {
            loadTrackingOverview();
        }
        
    } catch (error) {
        console.error('Error saving task:', error);
        showAlert(`Failed to save task: ${error.message}`, 'error');
    }
}

// Get next task order
async function getNextTaskOrder() {
    try {
        const snapshot = await db.collection('trackingTasks')
            .orderBy('order', 'desc')
            .limit(1)
            .get();
        
        if (snapshot.empty) return 1;
        return snapshot.docs[0].data().order + 1;
    } catch (error) {
        console.error('Error getting next task order:', error);
        return 1;
    }
}

// Delete task
async function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task? This will also delete all progress records for this task.')) {
        return;
    }
    
    if (!isAdmin) {
        showAlert('Administrator permissions required to delete tasks.', 'error');
        return;
    }
    
    try {
        // Delete task
        await db.collection('trackingTasks').doc(taskId).delete();
        
        // Delete all progress records for this task
        const progressSnapshot = await db.collection('taskProgress')
            .where('taskId', '==', taskId)
            .get();
        
        const deletePromises = [];
        progressSnapshot.forEach(doc => {
            deletePromises.push(doc.ref.delete());
        });
        
        if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
        }
        
        showAlert('Task deleted successfully!', 'success');
        loadManageTasks();
        if (currentPage === 'admin' && document.getElementById('tracking-overview').classList.contains('active')) {
            loadTrackingOverview();
        }
        
    } catch (error) {
        console.error('Error deleting task:', error);
        showAlert('Failed to delete task', 'error');
    }
}

// Load student progress list
async function loadStudentProgressList() {
    try {
        const studentsSnapshot = await db.collection('users').get();
        const tasks = await taskTracking.getAllTasks();
        
        if (studentsSnapshot.empty) {
            document.getElementById('students-progress-list').innerHTML = 
                '<div class="empty-state"><p>No students found</p></div>';
            return;
        }
        
        let html = '';
        studentsSnapshot.forEach(doc => {
            const student = doc.data();
            const studentId = doc.id;
            
            html += `
                <div class="student-progress-item" data-student-id="${studentId}" data-student-name="${student.name || ''}" data-school="${student.school || ''}">
                    <div class="student-progress-header">
                        <div class="student-info">
                            <h4>${student.name || 'Unknown Student'}</h4>
                            <div class="student-school">
                                ${student.school === 'fyhs' ? 'Foon Yew High School' : 
                                  student.school === 'kshs' ? 'Kaohsiung Senior High School' : 
                                  'School not set'}
                                ${student.email ? `â€¢ ${student.email}` : ''}
                            </div>
                        </div>
                        <div class="completion-stats">
                            <span id="completed-count-${studentId}">0</span>/<span>${tasks.length}</span> tasks
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-bar-${studentId}" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="task-checklist" id="checklist-${studentId}">
                        <div class="loading">
                            <div class="spinner" style="width: 20px; height: 20px;"></div>
                            <p>Loading tasks...</p>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn btn-small btn-primary view-details-btn" data-student-id="${studentId}">
                            <i class="fas fa-chart-line"></i> View Details
                        </button>
                        <button class="btn btn-small btn-outline" onclick="openStudentProgressModal('${studentId}')">
                            <i class="fas fa-eye"></i> Quick View
                        </button>
                    </div>
                </div>
            `;
        });

        document.getElementById('students-progress-list').innerHTML = html;

        // Load progress for each student
        studentsSnapshot.forEach(async doc => {
            const studentId = doc.id;
            await loadStudentProgress(studentId, tasks);
        });

        // Add event listeners for view details buttons
        document.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const studentId = this.getAttribute('data-student-id');
                openStudentProgressDetailModal(studentId);
            });
        });

    } catch (error) {
        console.error('Error loading student progress list:', error);
        document.getElementById('students-progress-list').innerHTML = 
            '<div class="empty-state"><p>Error loading student progress</p></div>';
    }
}

// Filter students
function filterStudents() {
    const searchTerm = document.getElementById('student-filter').value.toLowerCase();
    const schoolFilter = document.getElementById('school-filter').value;
    const completionFilter = document.getElementById('completion-filter').value;
    
    const studentItems = document.querySelectorAll('.student-progress-item');
    
    studentItems.forEach(item => {
        const studentId = item.getAttribute('data-student-id');
        const studentName = item.getAttribute('data-student-name').toLowerCase();
        const school = item.getAttribute('data-school');
        const completedCount = parseInt(document.getElementById(`completed-count-${studentId}`)?.textContent || 0);
        const totalTasks = parseInt(item.querySelector('.completion-stats span:nth-child(2)')?.textContent || 0);
        
        let shouldShow = true;
        
        // Search filter
        if (searchTerm && !studentName.includes(searchTerm)) {
            shouldShow = false;
        }
        
        // School filter
        if (schoolFilter && school !== schoolFilter) {
            shouldShow = false;
        }
        
        // Completion filter
        if (completionFilter) {
            const completionRate = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
            
            switch(completionFilter) {
                case 'completed':
                    if (completionRate < 100) shouldShow = false;
                    break;
                case 'in-progress':
                    if (completionRate <= 0 || completionRate >= 100) shouldShow = false;
                    break;
                case 'pending':
                    if (completionRate > 0) shouldShow = false;
                    break;
            }
        }
        
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

// Load individual student progress
async function loadStudentProgress(studentId, tasks) {
    try {
        const progress = await taskTracking.getStudentProgress(studentId);
        const completedCount = Object.values(progress).filter(p => p.completed).length;
        const completionPercentage = tasks.length > 0 ? (completedCount / tasks.length) * 100 : 0;

        // Update completion count and progress bar
        const completedCountEl = document.getElementById(`completed-count-${studentId}`);
        const progressBarEl = document.getElementById(`progress-bar-${studentId}`);
        
        if (completedCountEl) completedCountEl.textContent = completedCount;
        if (progressBarEl) {
            progressBarEl.style.width = `${completionPercentage}%`;
            progressBarEl.style.backgroundColor = completionPercentage === 100 ? 
                'var(--success)' : completionPercentage >= 50 ? 
                'var(--warning)' : 'var(--primary)';
        }

        // Update checklist
        const checklistEl = document.getElementById(`checklist-${studentId}`);
        if (checklistEl) {
            let checklistHtml = '';
            tasks.forEach(task => {
                const taskProgress = progress[task.id];
                const isCompleted = taskProgress?.completed || false;
                const completedDate = taskProgress?.completedAt?.toDate();
                const updatedBy = taskProgress?.updatedBy;
                
                checklistHtml += `
                    <div class="checklist-item">
                        <div class="checkbox-container">
                            <input type="checkbox" 
                                   data-student-id="${studentId}" 
                                   data-task-id="${task.id}"
                                   ${isCompleted ? 'checked' : ''}
                                   onchange="toggleTaskCompletion('${studentId}', '${task.id}', this.checked)"
                                   ${!isAdmin && !(currentUser?.uid === studentId) ? 'disabled' : ''}>
                        </div>
                        <div class="task-check-label">
                            <h5>${task.name} ${task.points ? `<span style="color: var(--warning); font-size: 0.9rem;">(${task.points} pts)</span>` : ''}</h5>
                            <p style="font-size: 0.85rem;">${task.description || ''}</p>
                            ${isCompleted && completedDate ? 
                                `<span class="completion-date">
                                    <i class="fas fa-check-circle"></i> 
                                    Completed: ${formatDate(completedDate)}
                                    ${updatedBy && updatedBy !== 'auto-system' ? ' (Manual)' : ''}
                                </span>` : 
                                '<span style="font-size: 0.85rem; color: var(--gray);"><i class="fas fa-clock"></i> Pending</span>'}
                        </div>
                    </div>
                `;
            });
            checklistEl.innerHTML = checklistHtml;
        }

    } catch (error) {
        console.error(`Error loading progress for student ${studentId}:`, error);
    }
}

// Toggle task completion
async function toggleTaskCompletion(studentId, taskId, completed) {
    if (!isAdmin && currentUser?.uid !== studentId) {
        showAlert('You can only update your own tasks.', 'error');
        return;
    }
    
    const success = await taskTracking.updateTaskCompletion(studentId, taskId, completed, true);
    if (success) {
        // Reload the student's progress
        const tasks = await taskTracking.getAllTasks();
        await loadStudentProgress(studentId, tasks);
        
        // Update overview if on that tab
        if (document.getElementById('tracking-overview')?.classList.contains('active')) {
            loadTrackingOverview();
        }
        
        showAlert(`Task ${completed ? 'marked as completed' : 'marked as pending'}`, 'success');
    } else {
        showAlert('Failed to update task completion', 'error');
    }
}

// Open student progress detail modal
async function openStudentProgressDetailModal(studentId) {
    try {
        const studentDoc = await db.collection('users').doc(studentId).get();
        const tasks = await taskTracking.getAllTasks();
        const progress = await taskTracking.getStudentProgress(studentId);
        
        if (!studentDoc.exists) {
            showAlert('Student not found', 'error');
            return;
        }
        
        const student = studentDoc.data();
        const completedCount = Object.values(progress).filter(p => p.completed).length;
        const completionRate = tasks.length > 0 ? Math.round((completedCount / tasks.length) * 100) : 0;
        
        let html = `
            <div class="student-detail-header" style="margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray);">
                <h4 style="color: var(--primary-dark); margin-bottom: 10px;">${student.name || 'Unknown Student'}</h4>
                <div style="display: flex; gap: 20px; color: var(--gray);">
                    <span><i class="fas fa-school"></i> ${student.school === 'fyhs' ? 'Foon Yew High School' : 
                          student.school === 'kshs' ? 'Kaohsiung Senior High School' : 
                          'School not set'}</span>
                    <span><i class="fas fa-envelope"></i> ${student.email || 'No email'}</span>
                    <span><i class="fas fa-chart-line"></i> ${completionRate}% Complete</span>
                </div>
            </div>
            
            <div class="progress-summary" style="margin-bottom: 25px;">
                <h5 style="color: var(--primary); margin-bottom: 15px;">Task Progress Summary</h5>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="background: rgba(67, 97, 238, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">${completedCount}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Tasks Completed</div>
                    </div>
                    <div style="background: rgba(247, 37, 133, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--secondary);">${tasks.length - completedCount}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Tasks Remaining</div>
                    </div>
                    <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${completionRate}%</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Overall Progress</div>
                    </div>
                </div>
            </div>
            
            <div class="task-details">
                <h5 style="color: var(--primary); margin-bottom: 15px;">Task Details</h5>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--light-gray);">Task</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--light-gray);">Status</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--light-gray);">Points</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--light-gray);">Completed On</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        let totalPoints = 0;
        let earnedPoints = 0;
        
        tasks.forEach(task => {
            const taskProgress = progress[task.id];
            const isCompleted = taskProgress?.completed || false;
            const completedDate = taskProgress?.completedAt?.toDate();
            totalPoints += task.points || 0;
            
            if (isCompleted) {
                earnedPoints += task.points || 0;
            }
            
            html += `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">
                        <div><strong>${task.name}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${task.description || ''}</div>
                    </td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--light-gray);">
                        <span style="display: inline-block; padding: 4px 12px; border-radius: 20px; 
                              background: ${isCompleted ? 'rgba(46, 204, 113, 0.2)' : 'rgba(243, 156, 18, 0.2)'}; 
                              color: ${isCompleted ? 'var(--success)' : 'var(--warning)'}; font-weight: 600;">
                            ${isCompleted ? 'Completed' : 'Pending'}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--light-gray);">
                        ${task.points || 0}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid var(--light-gray);">
                        ${completedDate ? formatDate(completedDate) : 'Not completed'}
                    </td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="points-summary" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--light-gray);">
                <h5 style="color: var(--primary); margin-bottom: 10px;">Points Summary</h5>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">
                            ${earnedPoints} / ${totalPoints} points
                        </div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${Math.round((earnedPoints / totalPoints) * 100)}% of total points earned
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="printStudentProgress('${studentId}')">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('student-progress-detail').innerHTML = html;
        document.getElementById('student-progress-title').textContent = `Progress: ${student.name || 'Student'}`;
        openModal('student-progress-modal');
        
    } catch (error) {
        console.error('Error opening student progress modal:', error);
        showAlert('Error loading student details', 'error');
    }
}

// Open student progress modal (quick view)
async function openStudentProgressModal(studentId) {
    try {
        const studentDoc = await db.collection('users').doc(studentId).get();
        const tasks = await taskTracking.getAllTasks();
        const progress = await taskTracking.getStudentProgress(studentId);
        
        if (!studentDoc.exists) {
            showAlert('Student not found', 'error');
            return;
        }
        
        const student = studentDoc.data();
        const completedCount = Object.values(progress).filter(p => p.completed).length;
        
        let html = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h4 style="color: var(--primary-dark);">${student.name || 'Unknown Student'}</h4>
                <p style="color: var(--gray);">
                    ${student.school === 'fyhs' ? 'Foon Yew High School' : 
                      student.school === 'kshs' ? 'Kaohsiung Senior High School' : 
                      'School not set'}
                </p>
                <div style="margin: 20px 0;">
                    <div style="font-size: 3rem; font-weight: 800; color: var(--primary);">${completedCount}/${tasks.length}</div>
                    <div style="font-size: 1rem; color: var(--gray);">Tasks Completed</div>
                </div>
            </div>
            
            <div style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
        `;
        
        tasks.forEach(task => {
            const taskProgress = progress[task.id];
            const isCompleted = taskProgress?.completed || false;
            
            html += `
                <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--light-gray);">
                    <div style="margin-right: 15px;">
                        ${isCompleted ? 
                            '<i class="fas fa-check-circle" style="color: var(--success); font-size: 1.2rem;"></i>' : 
                            '<i class="fas fa-clock" style="color: var(--warning); font-size: 1.2rem;"></i>'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--dark);">${task.name}</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${task.description || ''}</div>
                    </div>
                    <div>
                        <button class="btn btn-small ${isCompleted ? 'btn-outline' : 'btn-primary'}" 
                                onclick="toggleTaskCompletion('${studentId}', '${task.id}', ${!isCompleted})"
                                style="min-width: 100px;">
                            ${isCompleted ? 'Mark Pending' : 'Mark Complete'}
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="openStudentProgressDetailModal('${studentId}')">
                    <i class="fas fa-chart-line"></i> View Full Report
                </button>
            </div>
        `;
        
        document.getElementById('student-progress-detail').innerHTML = html;
        document.getElementById('student-progress-title').textContent = `Quick View: ${student.name || 'Student'}`;
        openModal('student-progress-modal');
        
    } catch (error) {
        console.error('Error opening student progress modal:', error);
        showAlert('Error loading student progress', 'error');
    }
}

// Print student progress
function printStudentProgress(studentId) {
    const studentDetail = document.getElementById('student-progress-detail');
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html>
        <head>
            <title>Student Progress Report</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #333; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #4361ee; color: white; padding: 10px; }
                td { padding: 10px; border-bottom: 1px solid #ddd; }
                .summary { background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0; }
            </style>
        </head>
        <body>
            ${studentDetail.innerHTML}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// Handle generate report
async function handleGenerateReport() {
    const reportType = document.getElementById('report-type').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
        showAlert('Please select a date range', 'error');
        return;
    }
    
    try {
        showAlert('Generating report...', 'info');
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        
        const report = await taskTracking.generateReport(reportType, start, end);
        
        if (!report) {
            showAlert('Failed to generate report', 'error');
            return;
        }
        
        displayReport(report, reportType);
        showAlert('Report generated successfully', 'success');
        
    } catch (error) {
        console.error('Error generating report:', error);
        showAlert(`Failed to generate report: ${error.message}`, 'error');
    }
}

// Display report
function displayReport(report, reportType) {
    const output = document.getElementById('report-output');
    
    switch(reportType) {
        case 'completion':
            output.innerHTML = `
                <div class="report-content">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">${report.title}</h4>
                    <p style="color: var(--gray); margin-bottom: 20px;">Period: ${report.period}</p>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Completions</th>
                                <th>Completion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.data.map(item => `
                                <tr>
                                    <td>${item.task}</td>
                                    <td style="text-align: center;">${item.completions}</td>
                                    <td style="text-align: center;">
                                        <span style="display: inline-block; padding: 4px 10px; border-radius: 15px; 
                                              background: ${item.completionRate >= 75 ? 'rgba(46, 204, 113, 0.2)' : 
                                                          item.completionRate >= 50 ? 'rgba(243, 156, 18, 0.2)' : 
                                                          'rgba(231, 76, 60, 0.2)'}; 
                                              color: ${item.completionRate >= 75 ? 'var(--success)' : 
                                                      item.completionRate >= 50 ? 'var(--warning)' : 
                                                      'var(--danger)'};">
                                            ${item.completionRate}%
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-outline" onclick="exportReport('${reportType}')">
                            <i class="fas fa-download"></i> Export as CSV
                        </button>
                    </div>
                </div>
            `;
            break;
            
        case 'progress':
            output.innerHTML = `
                <div class="report-content">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">${report.title}</h4>
                    <p style="color: var(--gray); margin-bottom: 20px;">Period: ${report.period}</p>
                    <p>Progress report requires additional data processing...</p>
                </div>
            `;
            break;
            
        default:
            output.innerHTML = `
                <div class="report-content">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">Report Generated</h4>
                    <p>Report type: ${reportType}</p>
                    <p>Period: ${report.period}</p>
                    <p>Data processing complete.</p>
                </div>
            `;
    }
}

// Export report
function exportReport(reportType) {
    // This would generate and download a CSV file
    // For simplicity, we'll show an alert
    showAlert(`Exporting ${reportType} report as CSV... (This would generate a download in a real implementation)`, 'info');
}

// Helper function: Format time ago
function formatTimeAgo(date) {
    if (!date) return 'Unknown time';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    
    return formatDate(date);
}

// Make functions available globally
window.openTaskModal = openTaskModal;
window.toggleTaskCompletion = toggleTaskCompletion;
window.openStudentProgressModal = openStudentProgressModal;
window.openStudentProgressDetailModal = openStudentProgressDetailModal;
window.filterStudents = filterStudents;
window.printStudentProgress = printStudentProgress;
window.exportReport = exportReport;
</script>
</body>
</html>
